<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Delicias ‚Äî Men√∫</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0d0b09;
  --bg2:#141210;
  --bg3:#1c1915;
  --surface:#1f1c18;
  --surface2:#252119;
  --border:#2e2a24;
  --border2:#3a352d;
  --gold:#c9a84c;
  --gold2:#e8c96a;
  --gold3:#f0d88a;
  --cream:#f5ede0;
  --cream2:#ede0cc;
  --text:#f0e8dc;
  --text2:#b8a890;
  --text3:#7a6e60;
  --red:#c0392b;
  --green:#1e7a4a;
  --orange:#c47a1e;
  --shadow:0 4px 24px rgba(0,0,0,.5);
  --shadow-lg:0 12px 48px rgba(0,0,0,.7);
  --glow:0 0 40px rgba(201,168,76,.12);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}

/* ‚îÄ‚îÄ TEXTURA FONDO ‚îÄ‚îÄ */
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:
    radial-gradient(ellipse at 20% 20%,rgba(201,168,76,.06) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 80%,rgba(201,168,76,.04) 0%,transparent 50%),
    url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='60' height='60' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;
}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loading{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:9999;gap:20px;
}
.loader-ring{
  width:52px;height:52px;
  border:2px solid var(--border2);
  border-top-color:var(--gold);
  border-radius:50%;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-txt{font-size:.82rem;letter-spacing:.2em;text-transform:uppercase;color:var(--text3);}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
#screen-home{
  position:relative;z-index:1;
  min-height:100vh;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:32px 20px;
  text-align:center;
}
.home-ornament{
  font-size:3rem;margin-bottom:8px;
  animation:float 4s ease-in-out infinite;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.home-brand{
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(3rem,12vw,5.5rem);
  font-weight:700;
  color:var(--gold2);
  letter-spacing:.05em;
  line-height:1;
  margin-bottom:4px;
  text-shadow:0 0 60px rgba(201,168,76,.3);
}
.home-sub{
  font-size:.7rem;letter-spacing:.35em;text-transform:uppercase;
  color:var(--text3);margin-bottom:40px;font-weight:500;
}
.home-divider{
  display:flex;align-items:center;gap:14px;margin-bottom:40px;width:100%;max-width:280px;
}
.home-divider-line{flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--border2),transparent);}
.home-divider-icon{color:var(--gold);font-size:.9rem;opacity:.6;}

.home-btns{display:flex;flex-direction:column;gap:14px;width:100%;max-width:320px;}
.btn-home{
  padding:17px 28px;
  border-radius:4px;
  font-family:'DM Sans',sans-serif;
  font-size:.92rem;font-weight:600;
  cursor:pointer;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  letter-spacing:.06em;
  position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.btn-home::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.08) 0%,transparent 100%);
  opacity:0;transition:opacity .3s;
}
.btn-home:hover::before{opacity:1;}
.btn-home:active{transform:scale(.98);}

.btn-menu{
  background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);
  color:#0d0b09;border:none;
  box-shadow:0 4px 20px rgba(201,168,76,.3);
}
.btn-menu:hover{box-shadow:0 6px 30px rgba(201,168,76,.45);transform:translateY(-2px);}

.btn-pedido{
  background:transparent;
  color:var(--gold2);
  border:1.5px solid var(--gold);
}
.btn-pedido:hover{background:rgba(201,168,76,.06);transform:translateY(-2px);}

.home-footer{
  position:absolute;bottom:24px;left:0;right:0;
  text-align:center;
}
.personal-link{
  font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;
  color:var(--text3);text-decoration:none;
  transition:color .2s;
  border-bottom:1px solid transparent;
  padding-bottom:1px;
}
.personal-link:hover{color:var(--text2);border-bottom-color:var(--border2);}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;position:relative;z-index:1;min-height:100vh;}
.screen.active{display:block;}

/* ‚îÄ‚îÄ HEADER COM√öN ‚îÄ‚îÄ */
.screen-header{
  position:sticky;top:0;z-index:100;
  background:rgba(13,11,9,.92);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  padding:14px 20px;
  display:flex;align-items:center;gap:14px;
}
.btn-back{
  width:36px;height:36px;border-radius:4px;
  border:1px solid var(--border2);background:transparent;
  color:var(--text2);cursor:pointer;font-size:1rem;
  transition:all .2s;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
}
.btn-back:hover{border-color:var(--gold);color:var(--gold);}
.screen-title{
  font-family:'Cormorant Garamond',serif;
  font-size:1.35rem;font-weight:700;color:var(--gold2);
  letter-spacing:.04em;
}
.screen-sub{font-size:.72rem;color:var(--text3);margin-top:1px;}

/* ‚îÄ‚îÄ MEN√ö ‚îÄ‚îÄ */
#screen-menu .main{padding:20px 16px 40px;}
@media(min-width:600px){#screen-menu .main{padding:24px 24px 48px;}}

.cat-filter{
  display:flex;gap:8px;overflow-x:auto;
  padding:16px 0 12px;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.cat-filter::-webkit-scrollbar{display:none;}
.cat-pill{
  padding:7px 16px;border-radius:100px;
  border:1px solid var(--border2);
  background:transparent;
  font-family:'DM Sans',sans-serif;font-size:.76rem;font-weight:600;
  color:var(--text2);cursor:pointer;
  white-space:nowrap;
  transition:all .22s;
  letter-spacing:.04em;
}
.cat-pill.active{background:var(--gold);color:#0d0b09;border-color:var(--gold);}
.cat-pill:not(.active):hover{border-color:var(--border2);color:var(--text);background:rgba(255,255,255,.04);}

.menu-section{margin-bottom:32px;}
.menu-section-title{
  display:flex;align-items:center;gap:10px;
  font-family:'Cormorant Garamond',serif;
  font-size:1.3rem;font-style:italic;color:var(--cream2);
  margin-bottom:14px;padding-bottom:10px;
  border-bottom:1px solid var(--border);
}
.section-dot{width:5px;height:5px;border-radius:50%;background:var(--gold);flex-shrink:0;}

.menu-grid{
  display:grid;
  grid-template-columns:1fr;gap:10px;
}
@media(min-width:500px){.menu-grid{grid-template-columns:1fr 1fr;gap:12px;}}
@media(min-width:900px){.menu-grid{grid-template-columns:repeat(3,1fr);}}

.menu-item{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:6px;
  padding:16px;
  transition:all .25s;
  position:relative;overflow:hidden;
}
.menu-item::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--gold),var(--gold2));
  opacity:0;transition:opacity .25s;
}
.menu-item:hover{border-color:var(--border2);box-shadow:var(--glow);transform:translateY(-2px);}
.menu-item:hover::before{opacity:1;}
.menu-item-icon{font-size:1.6rem;margin-bottom:8px;display:block;}
.menu-item-name{
  font-family:'Cormorant Garamond',serif;
  font-size:1.1rem;font-weight:600;color:var(--text);
  margin-bottom:4px;line-height:1.2;
}
.menu-item-cat{
  font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--text3);margin-bottom:8px;
}
.menu-item-price{
  font-family:'Cormorant Garamond',serif;
  font-size:1.25rem;font-weight:700;color:var(--gold);
}

/* ‚îÄ‚îÄ PEDIDO ‚îÄ‚îÄ */
#screen-pedido .main{padding:20px 16px 40px;max-width:600px;margin:0 auto;}

.mesa-input-wrap{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:8px;
  padding:24px;
  margin-bottom:20px;
  text-align:center;
}
.mesa-input-label{
  font-family:'Cormorant Garamond',serif;
  font-size:1.2rem;color:var(--cream2);
  margin-bottom:6px;
}
.mesa-input-hint{font-size:.76rem;color:var(--text3);margin-bottom:18px;}
.mesa-input-row{display:flex;gap:10px;max-width:260px;margin:0 auto;}
.mesa-number-input{
  flex:1;padding:12px 16px;
  border:1.5px solid var(--border2);
  border-radius:4px;
  background:var(--bg3);color:var(--text);
  font-family:'Cormorant Garamond',serif;
  font-size:1.6rem;font-weight:700;text-align:center;
  transition:border-color .2s;
  -moz-appearance:textfield;
}
.mesa-number-input::-webkit-outer-spin-button,
.mesa-number-input::-webkit-inner-spin-button{-webkit-appearance:none;}
.mesa-number-input:focus{outline:none;border-color:var(--gold);}
.btn-consultar{
  padding:12px 20px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  border:none;border-radius:4px;
  color:#0d0b09;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.9rem;
  cursor:pointer;white-space:nowrap;transition:all .2s;
}
.btn-consultar:hover{box-shadow:0 4px 16px rgba(201,168,76,.35);}

/* QR: si viene ?mesa=X auto-llena */
.qr-chip{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);
  border-radius:100px;padding:5px 12px;
  font-size:.73rem;color:var(--gold2);margin-bottom:16px;
}

/* Resultado pedido */
.pedido-result{display:none;}
.pedido-result.visible{display:block;animation:fadeUp .4s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.pedido-mesa-badge{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px 8px 0 0;
  padding:16px 20px;
  border-bottom:none;
}
.pedido-mesa-num{
  font-family:'Cormorant Garamond',serif;
  font-size:2.2rem;font-weight:700;color:var(--gold2);line-height:1;
}
.pedido-mesa-lbl{font-size:.65rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);}
.pedido-estado{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(30,122,74,.15);border:1px solid rgba(30,122,74,.3);
  border-radius:100px;padding:5px 12px;
  font-size:.72rem;font-weight:600;color:#2ecc71;
}
.pedido-estado-dot{width:6px;height:6px;border-radius:50%;background:#2ecc71;animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.pedido-info-row{
  background:var(--surface2);
  border:1px solid var(--border);border-top:none;
  padding:12px 20px;
  display:flex;gap:20px;flex-wrap:wrap;
  border-bottom:none;
}
.pedido-info-item{font-size:.76rem;color:var(--text2);}
.pedido-info-item strong{color:var(--text);font-weight:600;}

.pedido-items-card{
  background:var(--surface);
  border:1px solid var(--border);border-top:none;
  border-radius:0 0 8px 8px;
  overflow:hidden;
}
.pedido-items-head{
  padding:12px 20px;
  font-size:.68rem;letter-spacing:.14em;text-transform:uppercase;
  color:var(--text3);border-bottom:1px solid var(--border);
  display:grid;grid-template-columns:1fr auto auto;gap:10px;
}
.pedido-item-row{
  padding:13px 20px;
  display:grid;grid-template-columns:1fr auto auto;gap:10px;
  align-items:center;
  border-bottom:1px solid var(--border);
  transition:background .2s;
}
.pedido-item-row:last-of-type{border-bottom:none;}
.pedido-item-row:hover{background:rgba(255,255,255,.02);}
.item-name{font-size:.9rem;color:var(--text);font-weight:500;}
.item-cat-tag{font-size:.65rem;color:var(--text3);}
.item-qty{
  background:rgba(201,168,76,.12);border:1px solid rgba(201,168,76,.2);
  border-radius:4px;padding:3px 10px;
  font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:700;color:var(--gold2);
  text-align:center;min-width:36px;
}
.item-sub{font-size:.88rem;font-weight:600;color:var(--text2);text-align:right;}

.pedido-total-row{
  background:var(--bg3);
  padding:16px 20px;
  display:flex;justify-content:space-between;align-items:center;
  border-top:2px solid var(--border2);
}
.total-label{font-size:.76rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);}
.total-amount{
  font-family:'Cormorant Garamond',serif;
  font-size:1.8rem;font-weight:700;color:var(--gold);
}

.pedido-timer-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:14px 20px;margin-top:12px;
  display:flex;align-items:center;justify-content:space-between;
}
.timer-label{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);}
.timer-val{
  font-family:'Cormorant Garamond',serif;
  font-size:1.4rem;font-weight:700;color:var(--cream2);
  font-variant-numeric:tabular-nums;
}
.timer-val.alerta{color:#e74c3c;}

.pedido-empty{
  text-align:center;padding:48px 20px;
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
}
.pedido-empty-icon{font-size:2.8rem;margin-bottom:12px;opacity:.4;}
.pedido-empty-txt{font-size:.9rem;color:var(--text3);}

.error-msg{
  background:rgba(192,57,43,.1);border:1px solid rgba(192,57,43,.25);
  border-radius:6px;padding:12px 16px;
  font-size:.84rem;color:#e74c3c;
  margin-top:12px;display:none;
}
.error-msg.visible{display:block;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:24px;right:16px;
  background:var(--surface);border:1px solid var(--border);
  color:var(--text);padding:10px 16px;border-radius:4px;
  font-size:.82rem;z-index:9999;
  box-shadow:var(--shadow);
  animation:toastIn .3s ease;
}
@keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:400px){
  .home-brand{font-size:3.2rem;}
  .btn-home{padding:15px 24px;}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="loader-ring"></div>
  <div class="loader-txt">Cargando men√∫...</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-home" class="screen">
  <div class="home-ornament">üçΩ</div>
  <div class="home-brand">Delicias</div>
  <div class="home-sub">Restaurante ¬∑ Men√∫ del d√≠a</div>
  <div class="home-divider">
    <div class="home-divider-line"></div>
    <div class="home-divider-icon">‚ú¶</div>
    <div class="home-divider-line"></div>
  </div>
  <div class="home-btns">
    <button class="btn-home btn-menu" onclick="irA('menu')">üìã Ver Men√∫</button>
    <button class="btn-home btn-pedido" onclick="irA('pedido')">üîé Consultar mi Pedido</button>
  </div>
  <div class="home-footer">
    <a href="admin.html" class="personal-link">Acceso Personal ‚Üí</a>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MEN√ö ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-menu" class="screen">
  <div class="screen-header">
    <button class="btn-back" onclick="irA('home')">‚Üê</button>
    <div>
      <div class="screen-title">Nuestro Men√∫</div>
      <div class="screen-sub" id="menu-count">Cargando productos...</div>
    </div>
  </div>
  <div class="main">
    <div class="cat-filter" id="cat-filter">
      <button class="cat-pill active" data-cat="todos" onclick="filtrarMenu('todos',this)">‚ú¶ Todos</button>
      <button class="cat-pill" data-cat="comida" onclick="filtrarMenu('comida',this)">üçï Comidas</button>
      <button class="cat-pill" data-cat="bebida" onclick="filtrarMenu('bebida',this)">ü•§ Bebidas</button>
      <button class="cat-pill" data-cat="postre" onclick="filtrarMenu('postre',this)">üç® Postres</button>
    </div>
    <div id="menu-body"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PEDIDO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-pedido" class="screen">
  <div class="screen-header">
    <button class="btn-back" onclick="irA('home')">‚Üê</button>
    <div>
      <div class="screen-title">Consultar Pedido</div>
      <div class="screen-sub">Ingres√° el n√∫mero de tu mesa</div>
    </div>
  </div>
  <div class="main">
    <!-- chip QR si viene ?mesa=X -->
    <div id="qr-chip-wrap" style="text-align:center;margin-bottom:4px;display:none;">
      <span class="qr-chip">üì± Mesa detectada por QR</span>
    </div>

    <div class="mesa-input-wrap">
      <div class="mesa-input-label">¬øCu√°l es tu mesa?</div>
      <div class="mesa-input-hint">El mesero te indic√≥ el n√∫mero al sentarte</div>
      <div class="mesa-input-row">
        <input class="mesa-number-input" type="number" id="inp-mesa-num"
          min="1" max="12" placeholder="‚Äî"
          onkeydown="if(event.key==='Enter')consultarPedido()"/>
        <button class="btn-consultar" onclick="consultarPedido()">Consultar</button>
      </div>
      <div class="error-msg" id="pedido-error"></div>
    </div>

    <div class="pedido-result" id="pedido-result"></div>

    <!-- Timer en vivo -->
    <div class="pedido-timer-card" id="timer-card" style="display:none;">
      <div>
        <div class="timer-label">Tiempo en mesa</div>
        <div class="timer-val" id="timer-display">‚Äî</div>
      </div>
      <div style="font-size:2rem;opacity:.4">‚è±</div>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyCdKSf2g1cIyXrD6k_u1aR9TMln9HaPJro",
  authDomain:"delicia-restaurante.firebaseapp.com",
  databaseURL:"https://delicia-restaurante-default-rtdb.firebaseio.com",
  projectId:"delicia-restaurante",
  storageBucket:"delicia-restaurante.firebasestorage.app",
  messagingSenderId:"653903447900",
  appId:"1:653903447900:web:85cffda9d703e464af6399"
};

const CURRENCY = 'Gs.';
const TZ = 'America/Asuncion';
const fmt = n => CURRENCY + ' ' + Math.round(n).toLocaleString('es-PY');

const CAT_ICONS = { comida:'üçï', bebida:'ü•§', postre:'üç®' };
const CAT_NAMES = { comida:'Comidas', bebida:'Bebidas', postre:'Postres' };
const CAT_ORDER = ['comida','bebida','postre'];

let productos = [];
let mesas = {};
let catMenuActiva = 'todos';
let timerInterval = null;
let currentMesaTs = null;
let currentMesaNum = null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// Cargar productos en tiempo real
onValue(ref(db,'productos'), snap => {
  const r = snap.val();
  productos = r ? (Array.isArray(r) ? r : Object.values(r)) : [];
  renderMenu();
  $('loading').style.display = 'none';
  // Si hay mesa activa abierta, re-renderizar
  if(currentMesaNum) consultarMesa(currentMesaNum, false);
});

// Cargar mesas en tiempo real
onValue(ref(db,'mesas'), snap => {
  if(snap.exists()) mesas = snap.val();
  // Re-renderizar pedido si hay uno abierto
  if(currentMesaNum) consultarMesa(currentMesaNum, false);
});

// ‚îÄ‚îÄ QR: detectar ?mesa=X en URL ‚îÄ‚îÄ
const urlParams = new URLSearchParams(window.location.search);
const mesaQR = urlParams.get('mesa');
if(mesaQR && parseInt(mesaQR) >= 1 && parseInt(mesaQR) <= 12){
  // Ir directo a pantalla pedido con mesa pre-llenada
  window.addEventListener('DOMContentLoaded', () => {
    irA('pedido');
    $('inp-mesa-num').value = parseInt(mesaQR);
    $('qr-chip-wrap').style.display = 'block';
    // Auto-consultar cuando los datos est√©n listos
    setTimeout(() => consultarPedido(), 1000);
  });
}

// ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ
window.irA = function(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  if(screen === 'home'){
    $('screen-home').style.display = 'flex';
    $('screen-home').classList.add('active');
  } else {
    $('screen-home').style.display = 'none';
    $('screen-'+screen).classList.add('active');
  }
  if(screen !== 'pedido'){
    // Limpiar timer al salir de pedido
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
    currentMesaNum = null; currentMesaTs = null;
    $('timer-card').style.display = 'none';
    $('pedido-result').innerHTML = '';
    $('pedido-result').classList.remove('visible');
    $('pedido-error').classList.remove('visible');
    $('inp-mesa-num').value = '';
  }
  window.scrollTo(0,0);
};

// ‚îÄ‚îÄ RENDER MEN√ö ‚îÄ‚îÄ
function renderMenu(){
  const count = productos.length;
  $('menu-count').textContent = count + ' producto' + (count !== 1 ? 's' : '') + ' disponibles';
  renderMenuFiltrado();
}

function renderMenuFiltrado(){
  const cat = catMenuActiva;
  const body = $('menu-body');
  if(!productos.length){ body.innerHTML = '<div style="text-align:center;padding:48px;color:var(--text3);">Sin productos disponibles.</div>'; return; }

  const catsToShow = cat === 'todos' ? CAT_ORDER : [cat];
  let html = '';

  catsToShow.forEach(c => {
    const items = productos.filter(p => (p.cat || 'comida') === c);
    if(!items.length) return;
    html += `<div class="menu-section">
      <div class="menu-section-title"><span class="section-dot"></span>${CAT_ICONS[c]} ${CAT_NAMES[c]}</div>
      <div class="menu-grid">
        ${items.map(p => `
          <div class="menu-item">
            <span class="menu-item-icon">${CAT_ICONS[p.cat || 'comida']}</span>
            <div class="menu-item-name">${p.nombre}</div>
            <div class="menu-item-cat">${CAT_NAMES[p.cat || 'comida']}</div>
            <div class="menu-item-price">${fmt(p.precio)}</div>
          </div>`).join('')}
      </div>
    </div>`;
  });

  body.innerHTML = html || '<div style="text-align:center;padding:48px;color:var(--text3);">Sin productos en esta categor√≠a.</div>';
}

window.filtrarMenu = function(cat, el){
  catMenuActiva = cat;
  document.querySelectorAll('.cat-pill').forEach(p => p.classList.toggle('active', p === el));
  renderMenuFiltrado();
};

// ‚îÄ‚îÄ CONSULTAR PEDIDO ‚îÄ‚îÄ
window.consultarPedido = function(){
  const num = parseInt($('inp-mesa-num').value);
  const errEl = $('pedido-error');
  errEl.classList.remove('visible');

  if(isNaN(num) || num < 1 || num > 12){
    errEl.textContent = '‚ö†Ô∏è Ingres√° un n√∫mero de mesa v√°lido (1 al 12).';
    errEl.classList.add('visible');
    return;
  }
  consultarMesa(num, true);
};

function consultarMesa(num, animate){
  const mesa = mesas[num];
  const result = $('pedido-result');
  const errEl = $('pedido-error');
  const timerCard = $('timer-card');

  if(!mesa || !mesa.ocupada){
    result.innerHTML = `
      <div class="pedido-empty">
        <div class="pedido-empty-icon">ü™ë</div>
        <div class="pedido-empty-txt" style="font-size:1rem;color:var(--text2);margin-bottom:6px;">Mesa ${num} sin pedido activo</div>
        <div class="pedido-empty-txt">Esta mesa est√° libre o a√∫n no tiene pedidos registrados.</div>
      </div>`;
    result.classList.add('visible');
    timerCard.style.display = 'none';
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
    currentMesaNum = num; currentMesaTs = null;
    if(animate) result.style.animation = 'none';
    return;
  }

  currentMesaNum = num;
  currentMesaTs  = mesa.tsOcupada || null;

  // Construir lista de items
  const pedido = mesa.pedidoActual || {};
  const items = Object.entries(pedido).map(([pid, qty]) => {
    const p = productos.find(p => String(p.id) === String(pid));
    if(!p || qty <= 0) return null;
    return { ...p, qty, sub: p.precio * qty };
  }).filter(Boolean);

  const total = items.reduce((s, i) => s + i.sub, 0);

  if(!items.length){
    result.innerHTML = `
      <div class="pedido-empty">
        <div class="pedido-empty-icon">üçΩ</div>
        <div class="pedido-empty-txt">Mesa ${num} ocupada pero sin productos a√∫n.</div>
      </div>`;
    result.classList.add('visible');
    timerCard.style.display = 'none';
    return;
  }

  const hora = () => new Date().toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ});

  result.innerHTML = `
    <div class="pedido-mesa-badge">
      <div>
        <div class="pedido-mesa-lbl">Mesa</div>
        <div class="pedido-mesa-num">${num}</div>
      </div>
      <div class="pedido-estado"><span class="pedido-estado-dot"></span>Pedido activo</div>
    </div>
    <div class="pedido-info-row">
      ${mesa.mesero ? `<span class="pedido-info-item">üë§ Mesero: <strong>${mesa.mesero}</strong></span>` : ''}
      <span class="pedido-info-item">üïê Desde: <strong>${mesa.tsOcupada ? new Date(mesa.tsOcupada).toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ}) : '‚Äî'}</strong></span>
    </div>
    <div class="pedido-items-card">
      <div class="pedido-items-head">
        <span>Producto</span><span>Cant.</span><span>Subtotal</span>
      </div>
      ${items.map(i => `
        <div class="pedido-item-row">
          <div>
            <div class="item-name">${i.nombre}</div>
            <div class="item-cat-tag">${CAT_ICONS[i.cat||'comida']} ${CAT_NAMES[i.cat||'comida']}</div>
          </div>
          <div class="item-qty">${i.qty}</div>
          <div class="item-sub">${fmt(i.sub)}</div>
        </div>`).join('')}
      <div class="pedido-total-row">
        <span class="total-label">Total acumulado</span>
        <span class="total-amount">${fmt(total)}</span>
      </div>
    </div>`;

  if(animate){ result.style.animation = ''; }
  result.classList.add('visible');
  errEl.classList.remove('visible');

  // Timer en vivo
  timerCard.style.display = 'flex';
  if(timerInterval){ clearInterval(timerInterval); }
  function actualizarTimer(){
    if(!currentMesaTs){ $('timer-display').textContent = '‚Äî'; return; }
    const diff = Math.floor((Date.now() - currentMesaTs) / 1000);
    const h = Math.floor(diff / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = diff % 60;
    const timerEl = $('timer-display');
    timerEl.textContent = h > 0
      ? `${h}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`
      : `${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    timerEl.className = 'timer-val' + (diff >= 5400 ? ' alerta' : '');
  }
  actualizarTimer();
  timerInterval = setInterval(actualizarTimer, 1000);
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
window.$ = id => document.getElementById(id);

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ‚îÄ‚îÄ INIT HOME ‚îÄ‚îÄ
$('screen-home').style.display = 'flex';
$('screen-home').classList.add('active');
</script>
</body>
</html>
