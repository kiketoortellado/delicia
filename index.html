<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Delicias — Menú</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  /* PALETA UNIFICADA - Tema oscuro elegante */
  --bg-deep:#0a0908;
  --bg-primary:#12100e;
  --bg-secondary:#1a1714;
  --bg-tertiary:#24201c;
  --surface:#2a2620;
  --surface-hover:#353028;
  --border-subtle:#3d362f;
  --border-accent:#4a4239;
  
  /* Dorado sofisticado */
  --gold-primary:#d4a84b;
  --gold-light:#e8c87a;
  --gold-bright:#f0d89a;
  --gold-dark:#b8943f;
  --gold-glow:rgba(212,168,75,0.15);
  
  /* Textos */
  --text-primary:#f5f0e8;
  --text-secondary:#c9b99a;
  --text-muted:#8a7f6e;
  --text-subtle:#5c5348;
  
  /* Estados funcionales */
  --success:#2d6a4f;
  --success-light:#40916c;
  --warning:#d4a84b;
  --error:#c0392b;
  --info:#4a7c59;
  
  /* Sombras y efectos */
  --shadow-sm:0 2px 8px rgba(0,0,0,0.4);
  --shadow-md:0 4px 20px rgba(0,0,0,0.5);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.6);
  --shadow-gold:0 0 30px rgba(212,168,75,0.12);
  --shadow-gold-lg:0 0 60px rgba(212,168,75,0.2);
  
  /* Transiciones */
  --transition-fast:0.15s cubic-bezier(0.4,0,0.2,1);
  --transition-base:0.3s cubic-bezier(0.4,0,0.2,1);
  --transition-slow:0.5s cubic-bezier(0.4,0,0.2,1);
  --transition-bounce:0.4s cubic-bezier(0.34,1.56,0.64,1);
}

*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}

body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg-deep);
  color:var(--text-primary);
  min-height:100vh;
  overflow-x:hidden;
  line-height:1.6;
}

/* ════════════════════════════════════════════════════════════ */
/* ICONOS SVG REALISTAS */
/* ════════════════════════════════════════════════════════════ */
.icon{
  width:20px;
  height:20px;
  display:inline-block;
  vertical-align:middle;
  transition:all var(--transition-base);
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
}

.icon-sm{width:16px;height:16px;}
.icon-md{width:24px;height:24px;}
.icon-lg{width:32px;height:32px;}
.icon-xl{width:48px;height:48px;}

/* Iconos específicos */
.icon-logo{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e8c87a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E");
}

.icon-utensils{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e8c87a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E");
}

.icon-menu{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230a0908' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 6h16'/%3E%3Cpath d='M4 12h16'/%3E%3Cpath d='M4 18h16'/%3E%3C/svg%3E");
}

.icon-search{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e8c87a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.3-4.3'/%3E%3C/svg%3E");
}

.icon-arrow-left{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m12 19-7-7 7-7'/%3E%3Cpath d='M19 12H5'/%3E%3C/svg%3E");
}

.icon-arrow-left:hover{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23d4a84b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m12 19-7-7 7-7'/%3E%3Cpath d='M19 12H5'/%3E%3C/svg%3E");
}

.icon-table{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='7' width='18' height='12' rx='2'/%3E%3Cpath d='M3 7v-2a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v2'/%3E%3Cpath d='M12 7v12'/%3E%3Cpath d='M8 7v-3'/%3E%3Cpath d='M16 7v-3'/%3E%3C/svg%3E");
}

.icon-food{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E");
}

.icon-drink{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 8h1a4 4 0 1 1 0 8h-1'/%3E%3Cpath d='M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z'/%3E%3Cline x1='6' x2='6.01' y1='2' y2='2'/%3E%3Cline x1='10' x2='10.01' y1='2' y2='2'/%3E%3Cline x1='14' x2='14.01' y1='2' y2='2'/%3E%3C/svg%3E");
}

.icon-dessert{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='9' r='7'/%3E%3Cpath d='M12 16v7'/%3E%3Cpath d='M9 23h6'/%3E%3Cpath d='M19 9a7 7 0 1 1-14 0'/%3E%3C/svg%3E");
}

.icon-star{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23d4a84b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2'/%3E%3C/svg%3E");
}

.icon-clock{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 6v6l4 2'/%3E%3C/svg%3E");
}

.icon-check{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230a0908' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E");
}

.icon-user{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E");
}

.icon-receipt{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9b99a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z'/%3E%3Cpath d='M16 8h-6'/%3E%3Cpath d='M16 12h-6'/%3E%3Cpath d='M16 16h-6'/%3E%3C/svg%3E");
}

.icon-alert{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c0392b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' x2='12' y1='8' y2='12'/%3E%3Cline x1='12' x2='12.01' y1='16' y2='16'/%3E%3C/svg%3E");
}

.icon-empty{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238a7f6e' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z'/%3E%3Cpath d='M3 6h18'/%3E%3Cpath d='M16 10a4 4 0 0 1-8 0'/%3E%3C/svg%3E");
}

/* ════════════════════════════════════════════════════════════ */
/* TEXTURA DE FONDO ANIMADA */
/* ════════════════════════════════════════════════════════════ */
body::before{
  content:'';
  position:fixed;
  inset:0;
  background-image:
    radial-gradient(ellipse at 20% 20%,var(--gold-glow) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 80%,rgba(212,168,75,0.06) 0%,transparent 50%),
    radial-gradient(ellipse at 50% 50%,rgba(18,16,14,0.8) 0%,transparent 70%),
    url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:0;
  animation:bgPulse 8s ease-in-out infinite;
}

@keyframes bgPulse{
  0%,100%{opacity:1;}
  50%{opacity:0.95;}
}

/* ════════════════════════════════════════════════════════════ */
/* LOADING SCREEN MEJORADO */
/* ════════════════════════════════════════════════════════════ */
#loading{
  position:fixed;
  inset:0;
  background:var(--bg-deep);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:9999;
  gap:24px;
}

.loader-container{
  position:relative;
  width:80px;
  height:80px;
}

.loader-ring{
  position:absolute;
  inset:0;
  border:3px solid var(--border-subtle);
  border-top-color:var(--gold-primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
}

.loader-ring:nth-child(2){
  inset:8px;
  border-color:transparent;
  border-top-color:var(--gold-light);
  animation:spin 1.5s linear infinite reverse;
}

.loader-ring:nth-child(3){
  inset:16px;
  border-color:transparent;
  border-top-color:var(--gold-bright);
  animation:spin 2s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg);}
}

.loader-txt{
  font-size:0.85rem;
  letter-spacing:0.3em;
  text-transform:uppercase;
  color:var(--text-muted);
  animation:textPulse 2s ease-in-out infinite;
}

@keyframes textPulse{
  0%,100%{opacity:0.6;letter-spacing:0.3em;}
  50%{opacity:1;letter-spacing:0.35em;}
}

/* ════════════════════════════════════════════════════════════ */
/* HOME SCREEN - ANIMACIONES PREMIUM */
/* ════════════════════════════════════════════════════════════ */
#screen-home{
  position:relative;
  z-index:1;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:32px 20px;
  text-align:center;
  animation:fadeIn 0.8s ease-out;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(20px);}
  to{opacity:1;transform:translateY(0);}
}

.home-ornament{
  width:80px;
  height:80px;
  margin-bottom:16px;
  animation:float 3s ease-in-out infinite, glowPulse 2s ease-in-out infinite;
  filter:drop-shadow(0 0 20px var(--gold-glow));
}

@keyframes float{
  0%,100%{transform:translateY(0) rotate(0deg);}
  50%{transform:translateY(-12px) rotate(5deg);}
}

@keyframes glowPulse{
  0%,100%{filter:drop-shadow(0 0 20px var(--gold-glow));}
  50%{filter:drop-shadow(0 0 40px var(--shadow-gold));}
}

.home-brand{
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(3.5rem,15vw,6.5rem);
  font-weight:700;
  color:var(--gold-light);
  letter-spacing:0.08em;
  line-height:0.9;
  margin-bottom:8px;
  text-shadow:var(--shadow-gold-lg);
  animation:slideUpFade 0.8s ease-out 0.2s both;
  background:linear-gradient(135deg,var(--gold-bright) 0%,var(--gold-primary) 50%,var(--gold-dark) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

@keyframes slideUpFade{
  from{opacity:0;transform:translateY(30px);}
  to{opacity:1;transform:translateY(0);}
}

.home-sub{
  font-size:0.8rem;
  letter-spacing:0.4em;
  text-transform:uppercase;
  color:var(--text-secondary);
  margin-bottom:48px;
  animation:slideUpFade 0.8s ease-out 0.4s both;
  position:relative;
}

.home-sub::after{
  content:'';
  position:absolute;
  bottom:-12px;
  left:50%;
  transform:translateX(-50%);
  width:60px;
  height:1px;
  background:linear-gradient(90deg,transparent,var(--gold-primary),transparent);
}

.home-divider{
  display:flex;
  align-items:center;
  gap:20px;
  margin-bottom:48px;
  width:100%;
  max-width:320px;
  animation:fadeIn 1s ease-out 0.6s both;
}

.home-divider-line{
  flex:1;
  height:1px;
  background:linear-gradient(90deg,transparent,var(--border-accent),transparent);
  position:relative;
  overflow:hidden;
}

.home-divider-line::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(90deg,transparent,var(--gold-primary),transparent);
  transform:translateX(-100%);
  animation:shimmer 3s infinite;
}

@keyframes shimmer{
  0%{transform:translateX(-100%);}
  50%,100%{transform:translateX(100%);}
}

.home-divider-icon{
  width:20px;
  height:20px;
  animation:rotateStar 4s linear infinite;
}

@keyframes rotateStar{
  from{transform:rotate(0deg);}
  to{transform:rotate(360deg);}
}

.home-btns{
  display:flex;
  flex-direction:column;
  gap:16px;
  width:100%;
  max-width:340px;
  animation:slideUpFade 0.8s ease-out 0.8s both;
}

.btn-home{
  padding:18px 32px;
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-size:0.95rem;
  font-weight:600;
  cursor:pointer;
  transition:all var(--transition-bounce);
  letter-spacing:0.08em;
  position:relative;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  border:none;
  text-transform:uppercase;
}

.btn-home::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,0.1) 0%,transparent 50%,rgba(0,0,0,0.1) 100%);
  opacity:0;
  transition:opacity var(--transition-base);
}

.btn-home:hover::before{
  opacity:1;
}

.btn-home::after{
  content:'';
  position:absolute;
  inset:-2px;
  background:linear-gradient(135deg,var(--gold-primary),var(--gold-light),var(--gold-primary));
  border-radius:14px;
  opacity:0;
  z-index:-1;
  transition:opacity var(--transition-base);
  filter:blur(8px);
}

.btn-home:hover::after{
  opacity:0.5;
}

.btn-menu{
  background:linear-gradient(135deg,var(--gold-primary) 0%,var(--gold-dark) 100%);
  color:var(--bg-deep);
  box-shadow:var(--shadow-md),0 0 0 0 rgba(212,168,75,0.4);
  animation:pulseRing 2s infinite;
}

@keyframes pulseRing{
  0%{box-shadow:var(--shadow-md),0 0 0 0 rgba(212,168,75,0.4);}
  70%{box-shadow:var(--shadow-md),0 0 0 15px rgba(212,168,75,0);}
  100%{box-shadow:var(--shadow-md),0 0 0 0 rgba(212,168,75,0);}
}

.btn-menu:hover{
  transform:translateY(-3px) scale(1.02);
  box-shadow:var(--shadow-lg),0 0 30px rgba(212,168,75,0.3);
  animation:none;
}

.btn-pedido{
  background:transparent;
  color:var(--gold-light);
  border:2px solid var(--gold-primary);
  position:relative;
}

.btn-pedido:hover{
  background:rgba(212,168,75,0.08);
  transform:translateY(-3px);
  border-color:var(--gold-light);
  box-shadow:var(--shadow-gold);
}

.btn-pedido:hover .btn-icon{
  transform:translateX(4px);
}

.btn-icon{
  transition:transform var(--transition-base);
}

.home-footer{
  position:absolute;
  bottom:32px;
  left:0;
  right:0;
  text-align:center;
  animation:fadeIn 1s ease-out 1s both;
}

.personal-link{
  font-size:0.75rem;
  letter-spacing:0.15em;
  text-transform:uppercase;
  color:var(--text-muted);
  text-decoration:none;
  transition:all var(--transition-base);
  position:relative;
  padding-bottom:4px;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

.personal-link::after{
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  width:0;
  height:1px;
  background:var(--gold-primary);
  transition:width var(--transition-base);
}

.personal-link:hover{
  color:var(--gold-light);
  letter-spacing:0.2em;
}

.personal-link:hover::after{
  width:100%;
}

/* ════════════════════════════════════════════════════════════ */
/* SCREENS GENERALES */
/* ════════════════════════════════════════════════════════════ */
.screen{
  display:none;
  position:relative;
  z-index:1;
  min-height:100vh;
  animation:fadeIn 0.5s ease-out;
}

.screen.active{
  display:block;
}

/* ════════════════════════════════════════════════════════════ */
/* HEADER COMÚN MEJORADO */
/* ════════════════════════════════════════════════════════════ */
.screen-header{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(10,9,8,0.95);
  backdrop-filter:blur(20px) saturate(180%);
  border-bottom:1px solid var(--border-subtle);
  padding:16px 20px;
  display:flex;
  align-items:center;
  gap:16px;
  box-shadow:var(--shadow-sm);
}

.btn-back{
  width:44px;
  height:44px;
  border-radius:12px;
  border:2px solid var(--border-subtle);
  background:var(--bg-secondary);
  cursor:pointer;
  transition:all var(--transition-base);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
}

.btn-back::before{
  content:'';
  position:absolute;
  inset:0;
  background:var(--gold-primary);
  opacity:0;
  transition:opacity var(--transition-fast);
}

.btn-back:hover{
  border-color:var(--gold-primary);
  transform:translateX(-3px);
}

.btn-back:hover::before{
  opacity:1;
}

.btn-back .icon{
  position:relative;
  z-index:1;
  transition:all var(--transition-fast);
}

.btn-back:hover .icon{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230a0908' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m12 19-7-7 7-7'/%3E%3Cpath d='M19 12H5'/%3E%3C/svg%3E");
}

.screen-title{
  font-family:'Cormorant Garamond',serif;
  font-size:1.5rem;
  font-weight:700;
  color:var(--gold-light);
  letter-spacing:0.03em;
}

.screen-sub{
  font-size:0.8rem;
  color:var(--text-muted);
  margin-top:2px;
  letter-spacing:0.05em;
}

/* ════════════════════════════════════════════════════════════ */
/* MENÚ - FILTROS Y GRID */
/* ════════════════════════════════════════════════════════════ */
#screen-menu .main{
  padding:24px 16px 48px;
}

@media(min-width:600px){
  #screen-menu .main{
    padding:32px 24px 56px;
  }
}

.cat-filter{
  display:flex;
  gap:10px;
  overflow-x:auto;
  padding:20px 4px 16px;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  margin-bottom:8px;
}

.cat-filter::-webkit-scrollbar{
  display:none;
}

.cat-pill{
  padding:12px 24px;
  border-radius:100px;
  border:2px solid var(--border-subtle);
  background:var(--bg-secondary);
  font-family:'DM Sans',sans-serif;
  font-size:0.85rem;
  font-weight:600;
  color:var(--text-secondary);
  cursor:pointer;
  white-space:nowrap;
  transition:all var(--transition-bounce);
  letter-spacing:0.04em;
  position:relative;
  overflow:hidden;
  display:flex;
  align-items:center;
  gap:8px;
}

.cat-pill::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,var(--gold-primary),var(--gold-light));
  opacity:0;
  transition:opacity var(--transition-base);
}

.cat-pill span{
  position:relative;
  z-index:1;
}

.cat-pill.active{
  background:var(--gold-primary);
  color:var(--bg-deep);
  border-color:var(--gold-primary);
  box-shadow:var(--shadow-gold);
  transform:scale(1.05);
}

.cat-pill:not(.active):hover{
  border-color:var(--gold-primary);
  color:var(--gold-light);
  transform:translateY(-2px);
  background:var(--surface);
}

/* Secciones del menú */
.menu-section{
  margin-bottom:40px;
  animation:fadeInUp 0.6s ease-out both;
}

.menu-section:nth-child(1){animation-delay:0.1s;}
.menu-section:nth-child(2){animation-delay:0.2s;}
.menu-section:nth-child(3){animation-delay:0.3s;}

@keyframes fadeInUp{
  from{
    opacity:0;
    transform:translateY(30px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

.menu-section-title{
  display:flex;
  align-items:center;
  gap:12px;
  font-family:'Cormorant Garamond',serif;
  font-size:1.4rem;
  font-style:italic;
  color:var(--text-secondary);
  margin-bottom:20px;
  padding-bottom:12px;
  border-bottom:1px solid var(--border-subtle);
  position:relative;
}

.menu-section-title::after{
  content:'';
  position:absolute;
  bottom:-1px;
  left:0;
  width:60px;
  height:2px;
  background:linear-gradient(90deg,var(--gold-primary),transparent);
}

.section-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--gold-primary);
  box-shadow:0 0 10px var(--gold-primary);
  animation:dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse{
  0%,100%{transform:scale(1);opacity:1;}
  50%{transform:scale(1.3);opacity:0.7;}
}

.menu-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
}

@media(min-width:500px){
  .menu-grid{
    grid-template-columns:repeat(2,1fr);
    gap:16px;
  }
}

@media(min-width:900px){
  .menu-grid{
    grid-template-columns:repeat(3,1fr);
  }
}

.menu-item{
  background:var(--surface);
  border:2px solid var(--border-subtle);
  border-radius:16px;
  padding:24px;
  transition:all var(--transition-bounce);
  position:relative;
  overflow:hidden;
  cursor:pointer;
}

.menu-item::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:3px;
  background:linear-gradient(90deg,var(--gold-primary),var(--gold-light),var(--gold-primary));
  background-size:200% 100%;
  opacity:0;
  transition:opacity var(--transition-base);
  animation:gradientMove 3s linear infinite;
}

@keyframes gradientMove{
  0%{background-position:0% 50%;}
  100%{background-position:200% 50%;}
}

.menu-item:hover{
  border-color:var(--gold-primary);
  transform:translateY(-4px) scale(1.02);
  box-shadow:var(--shadow-lg),var(--shadow-gold);
}

.menu-item:hover::before{
  opacity:1;
}

.menu-item-icon{
  width:40px;
  height:40px;
  margin-bottom:16px;
  display:block;
  transition:transform var(--transition-bounce);
  opacity:0.8;
}

.menu-item:hover .menu-item-icon{
  transform:scale(1.2) rotate(5deg);
  opacity:1;
}

.menu-item-name{
  font-family:'Cormorant Garamond',serif;
  font-size:1.3rem;
  font-weight:600;
  color:var(--text-primary);
  margin-bottom:8px;
  line-height:1.3;
}

.menu-item-cat{
  font-size:0.75rem;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:6px;
}

.menu-item-price{
  font-family:'Cormorant Garamond',serif;
  font-size:1.5rem;
  font-weight:700;
  color:var(--gold-light);
  display:flex;
  align-items:center;
  gap:8px;
}

.menu-item-price::before{
  content:'';
  flex:1;
  height:1px;
  background:linear-gradient(90deg,var(--border-subtle),transparent);
  margin-right:8px;
}

/* ════════════════════════════════════════════════════════════ */
/* PEDIDO - CONSULTA MEJORADA */
/* ════════════════════════════════════════════════════════════ */
#screen-pedido .main{
  padding:24px 16px 48px;
  max-width:600px;
  margin:0 auto;
}

.mesa-input-wrap{
  background:var(--surface);
  border:2px solid var(--border-subtle);
  border-radius:20px;
  padding:32px;
  margin-bottom:24px;
  text-align:center;
  position:relative;
  overflow:hidden;
  box-shadow:var(--shadow-md);
  animation:fadeInUp 0.5s ease-out;
}

.mesa-input-wrap::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:4px;
  background:linear-gradient(90deg,var(--gold-primary),var(--gold-light),var(--gold-primary));
  background-size:200% 100%;
  animation:gradientMove 3s linear infinite;
}

.mesa-input-label{
  font-family:'Cormorant Garamond',serif;
  font-size:1.8rem;
  color:var(--gold-light);
  margin-bottom:8px;
  font-weight:600;
}

.mesa-input-hint{
  font-size:0.9rem;
  color:var(--text-muted);
  margin-bottom:24px;
  letter-spacing:0.02em;
}

.mesa-input-row{
  display:flex;
  gap:12px;
  max-width:280px;
  margin:0 auto;
}

.mesa-number-input{
  flex:1;
  padding:16px;
  border:2px solid var(--border-subtle);
  border-radius:12px;
  background:var(--bg-secondary);
  color:var(--text-primary);
  font-family:'Cormorant Garamond',serif;
  font-size:2.2rem;
  font-weight:700;
  text-align:center;
  transition:all var(--transition-base);
  -moz-appearance:textfield;
}

.mesa-number-input::-webkit-outer-spin-button,
.mesa-number-input::-webkit-inner-spin-button{
  -webkit-appearance:none;
}

.mesa-number-input:focus{
  outline:none;
  border-color:var(--gold-primary);
  box-shadow:0 0 0 4px var(--gold-glow),var(--shadow-gold);
  transform:scale(1.02);
}

.mesa-number-input::placeholder{
  color:var(--text-subtle);
}

.btn-consultar{
  padding:16px 28px;
  background:linear-gradient(135deg,var(--gold-primary),var(--gold-dark));
  border:none;
  border-radius:12px;
  color:var(--bg-deep);
  font-family:'DM Sans',sans-serif;
  font-weight:700;
  font-size:1rem;
  cursor:pointer;
  white-space:nowrap;
  transition:all var(--transition-bounce);
  box-shadow:var(--shadow-md);
  position:relative;
  overflow:hidden;
  display:flex;
  align-items:center;
  gap:8px;
}

.btn-consultar::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,transparent,rgba(255,255,255,0.2),transparent);
  transform:translateX(-100%);
  transition:transform var(--transition-base);
}

.btn-consultar:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-lg),var(--shadow-gold);
}

.btn-consultar:hover::before{
  transform:translateX(100%);
}

/* QR Chip */
.qr-chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:var(--gold-glow);
  border:2px solid rgba(212,168,75,0.3);
  border-radius:100px;
  padding:10px 20px;
  font-size:0.85rem;
  color:var(--gold-light);
  margin-bottom:20px;
  animation:fadeIn 0.5s ease-out;
  backdrop-filter:blur(10px);
}

/* Resultado del pedido */
.pedido-result{
  display:none;
}

.pedido-result.visible{
  display:block;
  animation:slideUpFade 0.5s ease-out;
}

.pedido-mesa-badge{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--surface);
  border:2px solid var(--border-subtle);
  border-radius:20px 20px 0 0;
  padding:24px;
  border-bottom:none;
  position:relative;
}

.pedido-mesa-badge::before{
  content:'';
  position:absolute;
  top:0;
  left:24px;
  right:24px;
  height:3px;
  background:linear-gradient(90deg,var(--gold-primary),var(--gold-light));
  border-radius:0 0 4px 4px;
}

.pedido-mesa-num{
  font-family:'Cormorant Garamond',serif;
  font-size:3rem;
  font-weight:700;
  color:var(--gold-light);
  line-height:1;
  text-shadow:var(--shadow-gold);
}

.pedido-mesa-lbl{
  font-size:0.75rem;
  letter-spacing:0.15em;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:4px;
  display:flex;
  align-items:center;
  gap:6px;
}

.pedido-estado{
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:rgba(45,106,79,0.15);
  border:2px solid rgba(45,106,79,0.3);
  border-radius:100px;
  padding:8px 16px;
  font-size:0.85rem;
  font-weight:600;
  color:var(--success-light);
}

.pedido-estado-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--success-light);
  animation:pulseDot 1.5s infinite;
  box-shadow:0 0 8px var(--success-light);
}

@keyframes pulseDot{
  0%,100%{transform:scale(1);opacity:1;}
  50%{transform:scale(0.6);opacity:0.5;}
}

.pedido-info-row{
  background:var(--bg-secondary);
  border:2px solid var(--border-subtle);
  border-top:none;
  padding:20px 24px;
  display:flex;
  gap:24px;
  flex-wrap:wrap;
}

.pedido-info-item{
  font-size:0.9rem;
  color:var(--text-secondary);
  display:flex;
  align-items:center;
  gap:8px;
}

.pedido-info-item strong{
  color:var(--text-primary);
  font-weight:600;
}

.pedido-items-card{
  background:var(--surface);
  border:2px solid var(--border-subtle);
  border-top:none;
  border-radius:0 0 20px 20px;
  overflow:hidden;
  box-shadow:var(--shadow-md);
}

.pedido-items-head{
  padding:20px 24px;
  font-size:0.8rem;
  letter-spacing:0.15em;
  text-transform:uppercase;
  color:var(--text-muted);
  border-bottom:2px solid var(--border-subtle);
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:12px;
  font-weight:700;
}

.pedido-item-row{
  padding:20px 24px;
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:12px;
  align-items:center;
  border-bottom:1px solid var(--border-subtle);
  transition:all var(--transition-fast);
}

.pedido-item-row:last-of-type{
  border-bottom:none;
}

.pedido-item-row:hover{
  background:rgba(212,168,75,0.03);
  transform:translateX(4px);
}

.item-name{
  font-size:1rem;
  color:var(--text-primary);
  font-weight:500;
}

.item-cat-tag{
  font-size:0.75rem;
  color:var(--text-muted);
  margin-top:4px;
  display:flex;
  align-items:center;
  gap:6px;
}

.item-qty{
  background:var(--gold-glow);
  border:2px solid rgba(212,168,75,0.2);
  border-radius:10px;
  padding:6px 14px;
  font-family:'Cormorant Garamond',serif;
  font-size:1.2rem;
  font-weight:700;
  color:var(--gold-light);
  text-align:center;
  min-width:44px;
  transition:all var(--transition-base);
}

.pedido-item-row:hover .item-qty{
  transform:scale(1.1);
  background:rgba(212,168,75,0.15);
}

.item-sub{
  font-size:1rem;
  font-weight:600;
  color:var(--text-secondary);
  text-align:right;
  transition:color var(--transition-fast);
  font-family:'Cormorant Garamond',serif;
}

.pedido-item-row:hover .item-sub{
  color:var(--gold-light);
}

.pedido-total-row{
  background:var(--bg-secondary);
  padding:24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-top:2px solid var(--border-accent);
}

.total-label{
  font-size:0.85rem;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color:var(--text-muted);
  font-weight:600;
}

.total-amount{
  font-family:'Cormorant Garamond',serif;
  font-size:2.2rem;
  font-weight:700;
  color:var(--gold-light);
  text-shadow:var(--shadow-gold);
}

.pedido-timer-card{
  background:var(--surface);
  border:2px solid var(--border-subtle);
  border-radius:20px;
  padding:24px;
  margin-top:16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:var(--shadow-md);
  animation:fadeIn 0.5s ease-out;
}

.timer-label{
  font-size:0.8rem;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:4px;
}

.timer-val{
  font-family:'Cormorant Garamond',serif;
  font-size:1.8rem;
  font-weight:700;
  color:var(--text-secondary);
  font-variant-numeric:tabular-nums;
  transition:all var(--transition-base);
}

.timer-val.alerta{
  color:var(--error);
  animation:alertPulse 1s infinite;
  text-shadow:0 0 10px rgba(192,57,43,0.5);
}

@keyframes alertPulse{
  0%,100%{opacity:1;}
  50%{opacity:0.6;}
}

.pedido-empty{
  text-align:center;
  padding:60px 24px;
  background:var(--surface);
  border:2px solid var(--border-subtle);
  border-radius:20px;
  animation:fadeIn 0.5s ease-out;
}

.pedido-empty-icon{
  width:64px;
  height:64px;
  margin:0 auto 16px;
  opacity:0.5;
  animation:bounce 2s infinite;
}

@keyframes bounce{
  0%,100%{transform:translateY(0);}
  50%{transform:translateY(-10px);}
}

.pedido-empty-txt{
  font-size:1.1rem;
  color:var(--text-muted);
  line-height:1.6;
}

.error-msg{
  background:rgba(192,57,43,0.1);
  border:2px solid rgba(192,57,43,0.25);
  border-radius:12px;
  padding:16px 20px;
  font-size:0.95rem;
  color:var(--error);
  margin-top:16px;
  display:none;
  align-items:center;
  gap:8px;
}

.error-msg.visible{
  display:flex;
  animation:shake 0.5s ease-out;
}

@keyframes shake{
  0%,100%{transform:translateX(0);}
  20%,60%{transform:translateX(-5px);}
  40%,80%{transform:translateX(5px);}
}

/* ════════════════════════════════════════════════════════════ */
/* TOAST MEJORADO */
/* ════════════════════════════════════════════════════════════ */
.toast{
  position:fixed;
  bottom:24px;
  right:16px;
  background:var(--surface);
  border:2px solid var(--gold-primary);
  color:var(--text-primary);
  padding:16px 24px;
  border-radius:16px;
  font-size:0.95rem;
  z-index:9999;
  box-shadow:var(--shadow-lg),var(--shadow-gold);
  animation:toastSlide 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  display:flex;
  align-items:center;
  gap:12px;
  max-width:360px;
  backdrop-filter:blur(10px);
}

@keyframes toastSlide{
  from{
    opacity:0;
    transform:translateX(100%) scale(0.8);
  }
  to{
    opacity:1;
    transform:translateX(0) scale(1);
  }
}

.toast::before{
  content:'';
  width:28px;
  height:28px;
  background:var(--gold-primary);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230a0908' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E");
  background-size:16px;
  background-position:center;
  background-repeat:no-repeat;
}

/* ════════════════════════════════════════════════════════════ */
/* RESPONSIVE */
/* ════════════════════════════════════════════════════════════ */
@media(max-width:400px){
  .home-brand{
    font-size:3.5rem;
  }
  
  .btn-home{
    padding:16px 24px;
    font-size:0.9rem;
  }
  
  .mesa-input-wrap{
    padding:24px 20px;
  }
  
  .pedido-mesa-num{
    font-size:2.4rem;
  }
}

@media(min-width:768px){
  .screen-header{
    padding:20px 32px;
  }
  
  .screen-title{
    font-size:1.8rem;
  }
  
  #screen-pedido .main{
    padding:40px 24px 64px;
  }
}

/* ════════════════════════════════════════════════════════════ */
/* BÚSQUEDA EN MENÚ */
/* ════════════════════════════════════════════════════════════ */
.menu-search-wrap{
  position:relative;
  margin:16px 0 4px;
}

.menu-search-icon{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  pointer-events:none;
}

.menu-search-input{
  width:100%;
  padding:14px 16px 14px 46px;
  border:2px solid var(--border-subtle);
  border-radius:14px;
  background:var(--bg-secondary);
  color:var(--text-primary);
  font-family:'DM Sans',sans-serif;
  font-size:1rem;
  transition:all var(--transition-base);
}

.menu-search-input::placeholder{
  color:var(--text-subtle);
}

.menu-search-input:focus{
  outline:none;
  border-color:var(--gold-primary);
  box-shadow:0 0 0 4px var(--gold-glow);
}

/* Scrollbar personalizado */
::-webkit-scrollbar{
  width:8px;
  height:8px;
}

::-webkit-scrollbar-track{
  background:var(--bg-secondary);
}

::-webkit-scrollbar-thumb{
  background:var(--border-subtle);
  border-radius:4px;
}

::-webkit-scrollbar-thumb:hover{
  background:var(--gold-primary);
}

/* Selection */
::selection{
  background:var(--gold-primary);
  color:var(--bg-deep);
}
</style>
</head>
<body>

<!-- LOADING MEJORADO -->
<div id="loading">
  <div class="loader-container">
    <div class="loader-ring"></div>
    <div class="loader-ring"></div>
    <div class="loader-ring"></div>
  </div>
  <div class="loader-txt">Cargando menú...</div>
</div>

<!-- ══════════════ HOME ══════════════ -->
<div id="screen-home" class="screen">
  <div class="home-ornament">
    <span class="icon icon-utensils icon-xl"></span>
  </div>
  <div class="home-brand">Delicias</div>
  <div class="home-sub">Restaurante · Menú del día</div>
  <div class="home-divider">
    <div class="home-divider-line"></div>
    <div class="home-divider-icon">
      <span class="icon icon-star"></span>
    </div>
    <div class="home-divider-line"></div>
  </div>
  <div class="home-btns">
    <button class="btn-home btn-menu" onclick="irA('menu')">
      <span class="icon icon-menu icon-sm"></span>
      Ver Menú
    </button>
    <button class="btn-home btn-pedido" onclick="irA('pedido')">
      <span class="icon icon-search icon-sm btn-icon"></span>
      Consultar mi Pedido
    </button>
  </div>
  <div class="home-footer">
    <a href="admin.html" class="personal-link">
      Acceso Personal
      <span class="icon icon-arrow-left icon-sm" style="transform:rotate(180deg);"></span>
    </a>
  </div>
</div>

<!-- ══════════════ MENÚ ══════════════ -->
<div id="screen-menu" class="screen">
  <div class="screen-header">
    <button class="btn-back" onclick="irA('home')">
      <span class="icon icon-arrow-left"></span>
    </button>
    <div>
      <div class="screen-title">Nuestro Menú</div>
      <div class="screen-sub" id="menu-count">Cargando productos...</div>
    </div>
  </div>
  <div class="main">
    <div class="menu-search-wrap">
      <span class="icon icon-search icon-sm menu-search-icon"></span>
      <input class="menu-search-input" type="text" id="search-input" placeholder="Buscar plato..." oninput="buscarMenu(this.value)" autocomplete="off"/>
    </div>
    <div class="cat-filter" id="cat-filter">
      <button class="cat-pill active" data-cat="todos" onclick="filtrarMenu('todos',this)">
        <span class="icon icon-utensils icon-sm"></span>
        <span>Todos</span>
      </button>
      <button class="cat-pill" data-cat="comida" onclick="filtrarMenu('comida',this)">
        <span class="icon icon-food icon-sm"></span>
        <span>Comidas</span>
      </button>
      <button class="cat-pill" data-cat="bebida" onclick="filtrarMenu('bebida',this)">
        <span class="icon icon-drink icon-sm"></span>
        <span>Bebidas</span>
      </button>
      <button class="cat-pill" data-cat="postre" onclick="filtrarMenu('postre',this)">
        <span class="icon icon-dessert icon-sm"></span>
        <span>Postres</span>
      </button>
    </div>
    <div id="menu-body"></div>
  </div>
</div>

<!-- ══════════════ PEDIDO ══════════════ -->
<div id="screen-pedido" class="screen">
  <div class="screen-header">
    <button class="btn-back" onclick="irA('home')">
      <span class="icon icon-arrow-left"></span>
    </button>
    <div>
      <div class="screen-title">Consultar Pedido</div>
      <div class="screen-sub">Ingresá el número de tu mesa</div>
    </div>
  </div>
  <div class="main">
    <!-- chip QR si viene ?mesa=X -->
    <div id="qr-chip-wrap" style="text-align:center;margin-bottom:8px;display:none;">
      <span class="qr-chip">
        <span class="icon icon-table icon-sm"></span>
        Mesa detectada por QR
      </span>
    </div>

    <div class="mesa-input-wrap">
      <div class="mesa-input-label">Ingresá el número de tu mesa</div>
      <div class="mesa-input-hint">El mesero debe indicarte el número de mesa</div>
      <div class="mesa-input-row">
        <input class="mesa-number-input" type="number" id="inp-mesa-num"
          min="1" max="12" placeholder="—"
          onkeydown="if(event.key==='Enter')consultarPedido()"/>
        <button class="btn-consultar" onclick="consultarPedido()">
          <span class="icon icon-search icon-sm"></span>
          Consultar
        </button>
      </div>
      <div class="error-msg" id="pedido-error" style="display:none;">
        <span class="icon icon-alert icon-sm"></span>
        <span id="error-text"></span>
      </div>
    </div>

    <div class="pedido-result" id="pedido-result"></div>

    <!-- Timer en vivo -->
    <div class="pedido-timer-card" id="timer-card" style="display:none;">
      <div>
        <div class="timer-label">Tiempo en mesa</div>
        <div class="timer-val" id="timer-display">—</div>
      </div>
      <div style="width:48px;height:48px;opacity:0.6;">
        <span class="icon icon-clock icon-lg" style="width:100%;height:100%;"></span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, onChildChanged, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyCdKSf2g1cIyXrD6k_u1aR9TMln9HaPJro",
  authDomain:"delicia-restaurante.firebaseapp.com",
  databaseURL:"https://delicia-restaurante-default-rtdb.firebaseio.com",
  projectId:"delicia-restaurante",
  storageBucket:"delicia-restaurante.firebasestorage.app",
  messagingSenderId:"653903447900",
  appId:"1:653903447900:web:85cffda9d703e464af6399"
};

const CURRENCY = 'Gs.';
const TZ = 'America/Asuncion';
const fmt = n => CURRENCY + ' ' + Math.round(n).toLocaleString('es-PY');
const MESA_KEY = 'delicias_last_mesa';

const CAT_ICONS = { 
  comida:'icon-food', 
  bebida:'icon-drink', 
  postre:'icon-dessert' 
};
const CAT_NAMES = { 
  comida:'Comidas', 
  bebida:'Bebidas', 
  postre:'Postres' 
};
const CAT_ORDER = ['comida','bebida','postre'];

let productos = [];
let mesas = {};
let catMenuActiva = 'todos';
let timerInterval = null;
let currentMesaTs = null;
let currentMesaNum = null;
let searchQuery = '';

// ── UTILS (definidas primero para que estén disponibles en todo el script) ──
window.$ = id => document.getElementById(id);

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast'; 
  el.innerHTML = `<span>${msg}</span>`;
  document.body.appendChild(el);
  setTimeout(() => {
    el.style.animation = 'toastSlide 0.3s ease reverse';
    setTimeout(() => el.remove(), 300);
  }, 3000);
}

// ── INIT ──
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// Cargar productos - usando onChildChanged para actualizaciones granulares
onValue(ref(db,'productos'), snap => {
  const r = snap.val();
  const nuevos = r ? (Array.isArray(r) ? r : Object.values(r)) : [];
  const cambio = JSON.stringify(nuevos) !== JSON.stringify(productos);
  productos = nuevos;
  if(cambio) renderMenu();
  $('loading').style.display = 'none';
  if(currentMesaNum) consultarMesa(currentMesaNum, false);
});

// Cargar cada mesa individualmente para mayor eficiencia
for(let i = 1; i <= 12; i++){
  onValue(ref(db, `mesas/${i}`), snap => {
    const data = snap.val();
    if(data !== null){
      const prevOcupada = mesas[i]?.ocupada;
      mesas[i] = data;
      // Notificar actualización si el usuario está viendo esta mesa
      if(currentMesaNum === i){
        consultarMesa(i, false);
        // Badge de "actualizado" si ya había pedido visible
        if(prevOcupada && data.ocupada){
          mostrarBadgeActualizado();
        }
      }
    }
  });
}

// ── QR: detectar ?mesa=X en URL (fix: sin DOMContentLoaded en módulos) ──
const urlParams = new URLSearchParams(window.location.search);
const mesaQR = urlParams.get('mesa');
if(mesaQR && parseInt(mesaQR) >= 1 && parseInt(mesaQR) <= 12){
  irA('pedido');
  $('inp-mesa-num').value = parseInt(mesaQR);
  $('qr-chip-wrap').style.display = 'block';
  setTimeout(() => consultarPedido(), 800);
} else {
  // Recordar última mesa usada
  const lastMesa = localStorage.getItem(MESA_KEY);
  if(lastMesa) $('inp-mesa-num').value = lastMesa;
}

// ── NAVEGACIÓN ──
window.irA = function(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  if(screen === 'home'){
    $('screen-home').style.display = 'flex';
    $('screen-home').classList.add('active');
  } else {
    $('screen-home').style.display = 'none';
    $('screen-'+screen).classList.add('active');
  }
  if(screen !== 'pedido'){
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
    currentMesaNum = null; currentMesaTs = null;
    $('timer-card').style.display = 'none';
    $('pedido-result').innerHTML = '';
    $('pedido-result').classList.remove('visible');
    $('pedido-error').style.display = 'none';
    $('pedido-error').classList.remove('visible');
    $('inp-mesa-num').value = '';
  }
  if(screen === 'menu'){
    searchQuery = '';
    const si = $('search-input');
    if(si) si.value = '';
    renderMenuFiltrado();
  }
  window.scrollTo(0,0);
};

// ── BADGE DE ACTUALIZACIÓN EN TIEMPO REAL ──
function mostrarBadgeActualizado(){
  let badge = $('pedido-update-badge');
  if(!badge){
    badge = document.createElement('div');
    badge.id = 'pedido-update-badge';
    badge.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--gold-primary);color:var(--bg-deep);padding:10px 20px;border-radius:100px;font-size:0.85rem;font-weight:700;z-index:9998;animation:fadeIn 0.3s ease;letter-spacing:0.05em;';
    badge.textContent = '↻ Pedido actualizado';
    document.body.appendChild(badge);
  }
  clearTimeout(badge._timeout);
  badge._timeout = setTimeout(() => badge.remove(), 3000);
}

// ── BÚSQUEDA EN MENÚ ──
window.buscarMenu = function(val){
  searchQuery = val.trim().toLowerCase();
  renderMenuFiltrado();
};

// ── RENDER MENÚ ──
function renderMenu(){
  const count = productos.length;
  $('menu-count').textContent = count + ' producto' + (count !== 1 ? 's' : '') + ' disponibles';
  renderMenuFiltrado();
}

function renderMenuFiltrado(){
  const cat = catMenuActiva;
  const body = $('menu-body');
  if(!productos.length){ 
    body.innerHTML = '<div style="text-align:center;padding:48px;color:var(--text-muted);font-size:1.1rem;">Sin productos disponibles.</div>'; 
    return; 
  }

  const catsToShow = cat === 'todos' ? CAT_ORDER : [cat];
  let html = '';

  catsToShow.forEach((c, idx) => {
    let items = productos.filter(p => (p.cat || 'comida') === c);
    if(searchQuery) items = items.filter(p => p.nombre.toLowerCase().includes(searchQuery));
    if(!items.length) return;
    html += `<div class="menu-section" style="animation-delay:${idx * 0.1}s">
      <div class="menu-section-title">
        <span class="section-dot"></span>
        <span class="icon ${CAT_ICONS[c]} icon-md"></span>
        ${CAT_NAMES[c]}
      </div>
      <div class="menu-grid">
        ${items.map(p => `
          <div class="menu-item">
            <span class="icon ${CAT_ICONS[p.cat || 'comida']} menu-item-icon"></span>
            <div class="menu-item-name">${p.nombre}</div>
            <div class="menu-item-cat">
              <span class="icon ${CAT_ICONS[p.cat || 'comida']} icon-sm"></span>
              ${CAT_NAMES[p.cat || 'comida']}
            </div>
            <div class="menu-item-price">${fmt(p.precio)}</div>
          </div>`).join('')}
      </div>
    </div>`;
  });

  if(!html && searchQuery){
    body.innerHTML = `<div style="text-align:center;padding:48px;color:var(--text-muted);">Sin resultados para "<strong>${searchQuery}</strong>".</div>`;
    return;
  }

  body.innerHTML = html || '<div style="text-align:center;padding:48px;color:var(--text-muted);">Sin productos en esta categoría.</div>';
}

window.filtrarMenu = function(cat, el){
  catMenuActiva = cat;
  document.querySelectorAll('.cat-pill').forEach(p => p.classList.toggle('active', p === el));
  renderMenuFiltrado();
};

// ── CONSULTAR PEDIDO ──
window.consultarPedido = function(){
  const num = parseInt($('inp-mesa-num').value);
  const errEl = $('pedido-error');
  const errText = $('error-text');
  
  errEl.style.display = 'none';
  errEl.classList.remove('visible');

  if(isNaN(num) || $('inp-mesa-num').value === ''){
    errText.textContent = 'Ingresá un número de mesa para consultar.';
    errEl.style.display = 'flex';
    errEl.classList.add('visible');
    return;
  }

  if(num < 1 || num > 12){
    errText.textContent = 'Ingresá un número de mesa válido (1 al 12).';
    errEl.style.display = 'flex';
    errEl.classList.add('visible');
    return;
  }

  // Guardar última mesa usada en localStorage
  localStorage.setItem(MESA_KEY, num);

  errEl.style.display = 'none';
  errEl.classList.remove('visible');
  consultarMesa(num, true);
};

function consultarMesa(num, animate){
  const mesa = mesas[num];
  const result = $('pedido-result');
  const errEl = $('pedido-error');
  const timerCard = $('timer-card');

  if(!mesa || !mesa.ocupada){
    result.innerHTML = `
      <div class="pedido-empty">
        <div class="pedido-empty-icon">
          <span class="icon icon-table icon-xl"></span>
        </div>
        <div class="pedido-empty-txt" style="font-size:1.1rem;color:var(--text-secondary);margin-bottom:8px;font-weight:600;">Mesa ${num} sin pedido activo</div>
        <div class="pedido-empty-txt">Esta mesa está libre o aún no tiene pedidos registrados.</div>
      </div>`;
    result.classList.add('visible');
    timerCard.style.display = 'none';
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
    currentMesaNum = num; currentMesaTs = null;
    return;
  }

  currentMesaNum = num;
  currentMesaTs  = mesa.tsOcupada || null;

  const pedido = mesa.pedidoActual || {};
  const items = Object.entries(pedido).map(([pid, qty]) => {
    const p = productos.find(p => String(p.id) === String(pid));
    if(!p || qty <= 0) return null;
    return { ...p, qty, sub: p.precio * qty };
  }).filter(Boolean);

  const total = items.reduce((s, i) => s + i.sub, 0);

  if(!items.length){
    result.innerHTML = `
      <div class="pedido-empty">
        <div class="pedido-empty-icon">
          <span class="icon icon-receipt icon-xl"></span>
        </div>
        <div class="pedido-empty-txt">Mesa ${num} ocupada pero sin productos aún.</div>
      </div>`;
    result.classList.add('visible');
    timerCard.style.display = 'none';
    return;
  }

  const horaStr = mesa.tsOcupada ? new Date(mesa.tsOcupada).toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ}) : '—';

  result.innerHTML = `
    <div class="pedido-mesa-badge">
      <div>
        <div class="pedido-mesa-lbl">
          <span class="icon icon-table icon-sm"></span> Mesa
        </div>
        <div class="pedido-mesa-num">${num}</div>
      </div>
      <div class="pedido-estado">
        <span class="pedido-estado-dot"></span>
        Pedido activo
      </div>
    </div>
    <div class="pedido-info-row">
      ${mesa.mesero ? `<span class="pedido-info-item"><span class="icon icon-user icon-sm"></span> <strong>Mesero: ${mesa.mesero}</strong></span>` : ''}
      <span class="pedido-info-item"><span class="icon icon-clock icon-sm"></span> <strong>Desde: ${horaStr}</strong></span>
    </div>
    <div class="pedido-items-card">
      <div class="pedido-items-head">
        <span>Producto</span>
        <span>Cant.</span>
        <span>Subtotal</span>
      </div>
      ${items.map(i => `
        <div class="pedido-item-row">
          <div>
            <div class="item-name">${i.nombre}</div>
            <div class="item-cat-tag">
              <span class="icon ${CAT_ICONS[i.cat||'comida']} icon-sm"></span>
              ${CAT_NAMES[i.cat||'comida']}
            </div>
          </div>
          <div class="item-qty">${i.qty}</div>
          <div class="item-sub">${fmt(i.sub)}</div>
        </div>`).join('')}
      <div class="pedido-total-row">
        <span class="total-label">Total acumulado</span>
        <span class="total-amount">${fmt(total)}</span>
      </div>
    </div>`;

  result.classList.add('visible');
  errEl.style.display = 'none';
  errEl.classList.remove('visible');

  timerCard.style.display = 'flex';
  if(timerInterval){ clearInterval(timerInterval); }
  
  function actualizarTimer(){
    if(!currentMesaTs){ 
      $('timer-display').textContent = '—'; 
      return; 
    }
    const diff = Math.floor((Date.now() - currentMesaTs) / 1000);
    const h = Math.floor(diff / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = diff % 60;
    const timerEl = $('timer-display');
    timerEl.textContent = h > 0
      ? `${h}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`
      : `${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    timerEl.className = 'timer-val' + (diff >= 5400 ? ' alerta' : '');
  }
  
  actualizarTimer();
  timerInterval = setInterval(actualizarTimer, 1000);
}

// ── INIT HOME ──
$('screen-home').style.display = 'flex';
$('screen-home').classList.add('active');
</script>
</body>
</html>
