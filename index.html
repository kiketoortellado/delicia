<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Delicias â€” Mesas</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#f5f2ee;--surface:#fff;--surface2:#faf8f5;--border:#e8e2da;
  --accent:#c0392b;--accent2:#e74c3c;--text:#1a1612;--text2:#5a5248;--text3:#9a928a;
  --green:#27ae60;--orange:#e67e22;--red:#c0392b;--blue:#2980b9;--purple:#8e44ad;
  --cook-bg:#1a1a2e;--cook-surface:#16213e;--cook-card:#0f3460;--cook-accent:#e94560;
  --cook-text:#eaeaea;--cook-text2:#a0a0b0;--cook-border:#2a2a4a;--cook-green:#00d4aa;
  --shadow:0 2px 16px rgba(0,0,0,.08);--shadow-lg:0 8px 32px rgba(0,0,0,.12);
  --radius:12px;--radius-sm:8px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;}
.spinner{width:44px;height:44px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-size:.9rem;color:var(--text3);}

/* â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center;z-index:999;
  background-image:radial-gradient(ellipse at 20% 50%,rgba(192,57,43,.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(184,134,11,.06) 0%,transparent 60%);}
#login-screen.show{display:flex;}
.login-card{background:var(--surface);border-radius:20px;padding:36px 24px;box-shadow:var(--shadow-lg);width:100%;max-width:420px;text-align:center;border:1px solid var(--border);}
@media(min-width:480px){.login-card{padding:52px 48px;}}
.login-logo{font-family:'Playfair Display',serif;font-size:2.4rem;color:var(--accent);margin-bottom:4px;}
.login-sub{color:var(--text3);font-size:.85rem;letter-spacing:.12em;text-transform:uppercase;margin-bottom:36px;}
.login-field{text-align:left;margin-bottom:18px;}
.login-field label{display:block;font-size:.78rem;font-weight:600;color:var(--text2);letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px;}
.login-field input{width:100%;padding:12px 16px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.95rem;background:var(--surface2);color:var(--text);transition:border-color .2s;}
.login-field input:focus{outline:none;border-color:var(--accent);}
.login-btn{width:100%;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius-sm);font-size:1rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:background .2s,transform .1s;margin-top:8px;}
.login-btn:hover{background:var(--accent2);}
.login-btn:active{transform:scale(.98);}
.login-err{color:var(--red);font-size:.85rem;margin-top:12px;min-height:20px;}

/* â•â•â• SYNC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-right:5px;animation:pulse 2s infinite;}
.sync-dot.offline{background:var(--red);animation:none;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 14px;
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.05);}
@media(min-width:768px){header{padding:0 28px;height:64px;flex-wrap:nowrap;}}
.header-brand h1{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--accent);}
@media(min-width:768px){.header-brand h1{font-size:1.5rem;}}
.header-brand span{display:none;color:var(--text3);font-size:.78rem;letter-spacing:.1em;text-transform:uppercase;}
@media(min-width:900px){.header-brand span{display:inline;}}
.header-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
#fecha-lbl{display:none;font-size:.82rem;color:var(--text3);}
@media(min-width:1000px){#fecha-lbl{display:inline;}}
.user-pill{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:.8rem;}
.role-badge{font-size:.66rem;font-weight:700;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.05em;}
.role-badge.admin{background:rgba(192,57,43,.12);color:var(--accent);}
.role-badge.mesero{background:rgba(41,128,185,.12);color:var(--blue);}
.role-badge.cocinero{background:rgba(231,76,60,.15);color:#e67e22;}
.btn-ghost{padding:7px 10px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:transparent;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:500;color:var(--text2);cursor:pointer;transition:all .2s;}
@media(min-width:768px){.btn-ghost{padding:7px 14px;font-size:.83rem;}}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:rgba(192,57,43,.04);}
.btn-primary{padding:8px 12px;border:none;border-radius:var(--radius-sm);background:var(--accent);color:#fff;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:background .2s;}
@media(min-width:768px){.btn-primary{padding:8px 18px;font-size:.85rem;}}
.btn-primary:hover{background:var(--accent2);}
.cierre-btn{background:#1a1612;color:#fff;border:none;padding:7px 12px;border-radius:var(--radius-sm);
  font-family:'DM Sans',sans-serif;font-weight:700;font-size:.78rem;cursor:pointer;
  transition:opacity .2s;display:flex;align-items:center;gap:5px;}
@media(min-width:768px){.cierre-btn{padding:8px 14px;font-size:.83rem;}}
.cierre-btn:hover{opacity:.82;}

/* â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;gap:2px;background:var(--surface);padding:14px 14px 0;border-bottom:1px solid var(--border);overflow-x:auto;}
@media(min-width:768px){.tabs{padding:14px 28px 0;}}
.tab{padding:10px 16px;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:.86rem;font-weight:500;color:var(--text3);cursor:pointer;white-space:nowrap;border-bottom:2.5px solid transparent;transition:all .2s;border-radius:6px 6px 0 0;}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600;}
.tab.admin-only.active{color:var(--purple);border-bottom-color:var(--purple);}

/* â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{padding:16px;margin:0 auto;}
@media(min-width:768px){.main{padding:24px;}}
@media(min-width:1024px){.main{padding:28px 32px;}}
.section-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
@media(min-width:768px){.section-title{font-size:1.25rem;margin-bottom:20px;}}
.badge{font-family:'DM Sans',sans-serif;font-size:.72rem;font-weight:600;padding:3px 10px;border-radius:20px;background:rgba(192,57,43,.1);color:var(--accent);}

/* â•â•â• MESAS GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•= */
.mesas-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
@media(min-width:600px){.mesas-grid{grid-template-columns:repeat(3,1fr);gap:14px;}}
@media(min-width:900px){.mesas-grid{grid-template-columns:repeat(4,1fr);gap:18px;}}
@media(min-width:1200px){.mesas-grid{grid-template-columns:repeat(6,1fr);gap:20px;}}

/* â•â•â• TARJETA MESA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•= */
.mesa-card{background:var(--surface);border-radius:var(--radius);border:1.5px solid var(--border);
  padding:14px 12px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden;
  min-height:120px;display:flex;flex-direction:column;justify-content:space-between;}
@media(min-width:900px){.mesa-card{padding:22px 20px;min-height:160px;}}
@media(min-width:1200px){.mesa-card{padding:26px 22px;min-height:185px;}}
.mesa-card::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:var(--green);}
.mesa-card.ocupada::before{background:var(--accent);}
.mesa-card.ocupada{border-color:rgba(192,57,43,.3);background:rgba(192,57,43,.02);}
.mesa-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-3px);}
.mesa-num{font-family:'Playfair Display',serif;font-size:2rem;color:var(--text);font-weight:700;line-height:1;}
@media(min-width:900px){.mesa-num{font-size:2.8rem;}}
@media(min-width:1200px){.mesa-num{font-size:3.2rem;}}
.mesa-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin-bottom:8px;}
.mesa-status{display:inline-flex;align-items:center;gap:4px;font-size:.7rem;font-weight:600;padding:3px 8px;border-radius:20px;text-transform:uppercase;}
@media(min-width:900px){.mesa-status{font-size:.78rem;padding:4px 11px;}}
.mesa-status.libre{background:rgba(39,174,96,.1);color:var(--green);}
.mesa-status.ocupada{background:rgba(192,57,43,.1);color:var(--accent);}
.mesa-status::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.mesa-mesero{font-size:.72rem;color:var(--text3);margin-top:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
@media(min-width:900px){.mesa-mesero{font-size:.8rem;}}
.mesa-total{font-size:.9rem;font-weight:600;color:var(--text2);margin-top:2px;}
@media(min-width:900px){.mesa-total{font-size:1rem;}}
.mesa-timer{font-size:.76rem;font-weight:700;color:var(--orange);margin-top:3px;display:flex;align-items:center;gap:3px;font-variant-numeric:tabular-nums;}
@media(min-width:900px){.mesa-timer{font-size:.86rem;}}
.mesa-timer.alerta{color:var(--red);animation:timerPulse 1s infinite;}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.45}}

/* â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(26,22,18,.55);z-index:200;display:none;align-items:flex-start;justify-content:center;padding:0;overflow-y:auto;backdrop-filter:blur(3px);}
@media(min-width:600px){.modal-overlay{padding:14px;}}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:0;width:100%;max-width:100%;box-shadow:var(--shadow-lg);animation:slideUp .25s ease;margin:0;min-height:100vh;}
@media(min-width:600px){.modal{border-radius:16px;max-width:740px;margin:auto;min-height:unset;}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-header{padding:14px 16px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:10;}
@media(min-width:600px){.modal-header{padding:20px 26px 16px;position:static;}}
.modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;}
@media(min-width:600px){.modal-title{font-size:1.35rem;}}
.modal-close{width:34px;height:34px;border:none;background:var(--surface2);border-radius:8px;cursor:pointer;font-size:1rem;color:var(--text2);transition:background .2s;}
.modal-close:hover{background:var(--border);}
.modal-body{padding:14px 16px;}
@media(min-width:600px){.modal-body{padding:20px 26px;}}

/* â•â•â• FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field{margin-bottom:13px;}
.field label{display:block;font-size:.75rem;font-weight:600;color:var(--text2);letter-spacing:.05em;text-transform:uppercase;margin-bottom:5px;}
.field input,.field select{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.92rem;background:var(--surface2);color:var(--text);transition:border-color .2s;}
.field input:focus,.field select:focus{outline:none;border-color:var(--accent);}

/* â•â•â• CATEGORIAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cat-tabs{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.cat-tab{padding:5px 11px;border:1.5px solid var(--border);border-radius:20px;background:var(--surface2);font-family:'DM Sans',sans-serif;font-size:.74rem;font-weight:600;cursor:pointer;transition:all .18s;color:var(--text2);}
.cat-tab.active{color:#fff;border-color:transparent;}
.cat-tab[data-cat="todos"].active{background:var(--accent);}
.cat-tab[data-cat="bebida"].active{background:var(--blue);}
.cat-tab[data-cat="comida"].active{background:var(--green);}
.cat-tab[data-cat="postre"].active{background:var(--purple);}

/* â•â•â• PEDIDO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pedido-layout{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:560px){.pedido-layout{grid-template-columns:1fr;}}
.productos-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:280px;overflow-y:auto;}
.producto-btn{padding:8px 7px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.79rem;font-weight:500;color:var(--text2);transition:all .18s;text-align:left;}
.producto-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(192,57,43,.04);}
.producto-btn .prod-name{font-weight:600;color:var(--text);display:block;}
.producto-btn .prod-price{color:var(--text3);font-size:.73rem;}
.orden-panel{background:var(--surface2);border-radius:var(--radius-sm);padding:12px;border:1px solid var(--border);}
.orden-panel h4{font-size:.74rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:9px;}
.orden-items{min-height:60px;max-height:220px;overflow-y:auto;}
.orden-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:.84rem;}
.orden-item:last-child{border-bottom:none;}
.orden-item-name{flex:1;color:var(--text);font-weight:500;}
.orden-item-qty{display:flex;align-items:center;gap:4px;}
.qty-btn{width:22px;height:22px;border:1.5px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;font-size:.85rem;font-weight:700;color:var(--text2);transition:all .15s;}
.qty-btn:hover{border-color:var(--accent);color:var(--accent);}
.qty-num{font-weight:700;width:18px;text-align:center;font-size:.84rem;}
.orden-item-price{font-weight:600;min-width:80px;text-align:right;font-size:.8rem;}
.orden-total{border-top:2px solid var(--border);margin-top:9px;padding-top:9px;display:flex;justify-content:space-between;align-items:center;}
.total-amount{font-family:'Playfair Display',serif;font-size:1.25rem;color:var(--accent);}

/* â•â•â• CLIENTES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cliente-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 13px;margin-bottom:8px;}
.cliente-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.cliente-num{font-family:'Playfair Display',serif;font-size:.92rem;color:var(--accent);font-weight:700;}
.cliente-items-list{font-size:.79rem;color:var(--text3);}
.mesero-badge{display:inline-flex;align-items:center;gap:4px;font-size:.74rem;color:var(--text3);background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 8px;margin-top:4px;}

/* â•â•â• ACCIONES MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-actions{display:flex;gap:7px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.btn-success{background:var(--green);color:#fff;border:none;padding:9px 16px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:600;font-size:.84rem;cursor:pointer;transition:opacity .2s;}
.btn-success:hover{opacity:.85;}
.btn-danger{background:var(--accent);color:#fff;border:none;padding:9px 16px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:600;font-size:.84rem;cursor:pointer;transition:opacity .2s;}
.btn-danger:hover{opacity:.85;}
.btn-warning{background:var(--orange);color:#fff;border:none;padding:9px 16px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:600;font-size:.84rem;cursor:pointer;transition:opacity .2s;}
.btn-warning:hover{opacity:.85;}
.btn-blue{background:var(--blue);color:#fff;border:none;padding:9px 16px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:600;font-size:.84rem;cursor:pointer;transition:opacity .2s;}
.btn-blue:hover{opacity:.85;}

/* â•â•â• PRODUCTOS ADMIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.add-prod-form{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:18px;display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end;}
@media(min-width:700px){.add-prod-form{grid-template-columns:2fr 1fr 1fr auto;}}
@media(max-width:500px){.add-prod-form{grid-template-columns:1fr;}}
.productos-admin{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:11px;}
.prod-card{background:var(--surface);border-radius:var(--radius-sm);border:1px solid var(--border);padding:13px;display:flex;align-items:center;justify-content:space-between;}
.pname{font-weight:600;color:var(--text);font-size:.9rem;}
.pprice{font-size:.82rem;color:var(--text3);margin-top:2px;}
.pcat{font-size:.68rem;font-weight:700;padding:1px 7px;border-radius:10px;margin-top:3px;display:inline-block;}
.pcat.bebida{background:rgba(41,128,185,.12);color:var(--blue);}
.pcat.comida{background:rgba(39,174,96,.12);color:var(--green);}
.pcat.postre{background:rgba(142,68,173,.12);color:var(--purple);}
.prod-card-actions{display:flex;gap:6px;}
.icon-btn{width:32px;height:32px;border:1.5px solid var(--border);border-radius:7px;background:#fff;cursor:pointer;font-size:.84rem;transition:all .15s;}
.icon-btn:hover{border-color:var(--accent);}

/* â•â•â• HISTORIAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.report-summary{display:grid;grid-template-columns:repeat(2,1fr);gap:9px;margin-bottom:14px;}
@media(min-width:600px){.report-summary{grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px;}}
.stat-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);padding:13px;}
@media(min-width:600px){.stat-card{padding:18px;}}
.stat-val{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);}
@media(min-width:600px){.stat-val{font-size:1.7rem;}}
.stat-lbl{font-size:.67rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-top:2px;}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.history-table{width:100%;border-collapse:collapse;font-size:.84rem;min-width:550px;}
.history-table th{padding:9px 12px;text-align:left;border-bottom:2px solid var(--border);font-size:.7rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);font-weight:600;}
.history-table td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text2);}
.history-table tr:hover td{background:var(--surface2);}
.history-table .total-row td{font-weight:700;color:var(--text);border-top:2px solid var(--border);border-bottom:none;}
.empty-state{text-align:center;padding:46px 20px;color:var(--text3);}
.empty-state .icon{font-size:2.8rem;margin-bottom:10px;}

/* â•â•â• ADMIN PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.admin-grid{display:grid;grid-template-columns:1fr;gap:14px;}
@media(min-width:900px){.admin-grid{grid-template-columns:1fr 1fr;gap:18px;}}
.admin-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;}
.admin-card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.admin-card-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--text);}
.admin-card-body{padding:14px 18px;}
.user-list{display:flex;flex-direction:column;gap:9px;margin-top:4px;}
.user-item{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 13px;}
.user-info .uname{font-weight:600;color:var(--text);font-size:.88rem;}
.user-info .ufull{font-size:.75rem;color:var(--text3);margin-top:1px;}
.user-item-actions{display:flex;gap:5px;align-items:center;}
.add-user-form{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:12px;display:grid;grid-template-columns:1fr 1fr;gap:9px;}
@media(max-width:500px){.add-user-form{grid-template-columns:1fr;}}
.activity-list{display:flex;flex-direction:column;gap:7px;max-height:380px;overflow-y:auto;}
.activity-item{display:flex;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.activity-item:last-child{border-bottom:none;}
.activity-dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0;}
.activity-dot.accion-pedido{background:var(--green);}
.activity-dot.accion-pago{background:var(--orange);}
.activity-dot.accion-login{background:var(--blue);}
.activity-dot.accion-producto{background:var(--purple);}
.activity-dot.accion-admin{background:var(--accent);}
.activity-content{flex:1;}
.activity-msg{font-size:.82rem;color:var(--text2);}
.activity-user{font-weight:600;color:var(--text);}
.activity-meta{font-size:.72rem;color:var(--text3);margin-top:1px;}

/* â•â•â• BOTTOM NAV MÃ“VIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1.5px solid var(--border);z-index:150;box-shadow:0 -4px 20px rgba(0,0,0,.08);}
.bottom-nav-inner{display:flex;align-items:stretch;}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:9px 4px;border:none;background:transparent;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.62rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;gap:3px;transition:color .2s;min-height:56px;}
.bnav-btn .bnav-icon{font-size:1.25rem;line-height:1;}
.bnav-btn.active{color:var(--accent);}
.bnav-btn.admin-nav.active{color:var(--purple);}
@media(max-width:767px){.tabs{display:none!important;}.bottom-nav{display:block;}.main{padding-bottom:70px!important;}}
@media(min-width:768px){.bottom-nav{display:none!important;}.tabs{display:flex!important;}}

/* â•â•â• TICKET â€” 80mm EXACTO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* 80mm = 302.36px @ 96dpi */
#ticket-print{display:none;}
@media print{
  @page{
    size:80mm auto;
    margin:0;
  }
  *{-webkit-print-color-adjust:exact!important;color-adjust:exact!important;print-color-adjust:exact!important;}
  body>*:not(#ticket-print){display:none!important;}
  #ticket-print{
    display:block!important;
    position:fixed;inset:0;
    background:#fff;
    z-index:99999;
  }
}
.ticket-wrap{
  width:72mm;          /* Ã¡rea imprimible = 80mm - 4mm mÃ¡rgenes c/lado */
  max-width:302px;     /* fallback pantalla */
  margin:0 auto;
  font-family:'Courier New',Courier,monospace;
  font-size:11pt;      /* ~14.67px */
  line-height:1.45;
  color:#000;
  background:#fff;
  padding:3mm 4mm;     /* margen interno estÃ¡ndar TPV */
}
.ticket-title{text-align:center;font-size:15pt;font-weight:900;letter-spacing:2px;margin-bottom:0;}
.ticket-sub{text-align:center;font-size:9pt;margin-bottom:4mm;color:#444;}
.ticket-div{
  border:none;
  border-top:1px dashed #000;
  margin:3mm 0;
  width:100%;
}
.ticket-row{
  display:flex;
  justify-content:space-between;
  margin:1mm 0;
  font-size:10pt;
}
.ticket-row.bold{font-weight:700;}
.ticket-row.total{
  font-weight:900;
  font-size:13pt;
  border-top:2px solid #000;
  margin-top:3mm;
  padding-top:2mm;
}
.ticket-center{text-align:center;font-size:9pt;margin-top:4mm;color:#555;}
.ticket-cat-hdr{
  font-size:9pt;
  font-weight:700;
  margin-top:4mm;
  margin-bottom:1mm;
  text-transform:uppercase;
  letter-spacing:1px;
  border-bottom:1px solid #ccc;
  padding-bottom:1mm;
}
.ticket-item-name{flex:1;padding-right:4mm;word-break:break-word;}
.ticket-item-price{white-space:nowrap;text-align:right;font-weight:700;}
.ticket-corte{
  border:none;
  border-top:2px dashed #000;
  margin:6mm 0 0;
  width:100%;
}

/* â•â•â• VISTA COCINERO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#cocina-app{display:none;}
#cocina-app.show{display:flex;flex-direction:column;min-height:100vh;background:var(--cook-bg);}
.cocina-header{background:var(--cook-surface);border-bottom:2px solid var(--cook-border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.cocina-brand{display:flex;align-items:center;gap:12px;}
.cocina-logo{font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--cook-accent);}
.cocina-subtitle{font-size:.75rem;letter-spacing:.14em;text-transform:uppercase;color:var(--cook-text2);}
.cocina-user-pill{background:rgba(233,69,96,.15);border:1px solid rgba(233,69,96,.3);border-radius:20px;padding:5px 14px;font-size:.8rem;color:var(--cook-accent);font-weight:600;}
.cocina-salir{padding:8px 14px;background:transparent;border:1.5px solid var(--cook-border);border-radius:8px;color:var(--cook-text2);font-family:'DM Sans',sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s;}
.cocina-salir:hover{border-color:var(--cook-accent);color:var(--cook-accent);}
.cocina-hist-btn{padding:8px 14px;background:rgba(233,69,96,.12);border:1.5px solid rgba(233,69,96,.35);border-radius:8px;color:var(--cook-accent);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;}
.cocina-hist-btn:hover{background:rgba(233,69,96,.22);border-color:var(--cook-accent);}
.cocina-main{padding:18px;flex:1;}
@media(min-width:768px){.cocina-main{padding:20px 24px;}}
.cocina-titulo{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--cook-text);margin-bottom:20px;display:flex;align-items:center;gap:12px;}
.cocina-badge{background:var(--cook-accent);color:#fff;font-size:.78rem;font-weight:700;padding:3px 12px;border-radius:20px;}
/* SIEMPRE 5 tarjetas mÃ¡x en pantalla â€” layout fijo */
.cocina-grid{display:grid;gap:14px;grid-template-columns:1fr;}
@media(min-width:500px){.cocina-grid{grid-template-columns:repeat(2,1fr);}}
@media(min-width:900px){.cocina-grid{grid-template-columns:repeat(3,1fr);gap:16px;}}
@media(min-width:1300px){.cocina-grid{grid-template-columns:repeat(5,1fr);gap:18px;}}

/* Tarjeta cocina */
.cocina-card{background:var(--cook-surface);border:2px solid var(--cook-border);border-radius:14px;overflow:hidden;transition:all .25s;position:relative;}
.cocina-card.nueva{border-color:var(--cook-accent);box-shadow:0 0 24px rgba(233,69,96,.25);animation:pulseCard 2s ease-in-out infinite;}
@keyframes pulseCard{0%,100%{box-shadow:0 0 24px rgba(233,69,96,.25)}50%{box-shadow:0 0 40px rgba(233,69,96,.45)}}
.cocina-card-header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.04);}
.cocina-mesa-num{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:var(--cook-text);line-height:1;}
.cocina-mesa-lbl{font-size:.68rem;letter-spacing:.12em;text-transform:uppercase;color:var(--cook-text2);margin-bottom:2px;}
.cocina-timer-big{font-size:1rem;font-weight:700;color:var(--cook-green);font-variant-numeric:tabular-nums;display:flex;align-items:center;gap:5px;}
.cocina-timer-big.alerta{color:var(--cook-accent);}
.cocina-card-body{padding:14px 20px 20px;}
.cocina-items-list{display:flex;flex-direction:column;gap:8px;}
.cocina-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,.05);border-radius:8px;border-left:3px solid var(--cook-green);}
.cocina-item-qty{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:var(--cook-accent);min-width:42px;text-align:center;line-height:1;}
.cocina-item-name{font-size:1.05rem;font-weight:600;color:var(--cook-text);}
.cocina-item-cat{font-size:.68rem;letter-spacing:.08em;text-transform:uppercase;color:var(--cook-text2);margin-top:1px;}
.cocina-card-footer{padding:12px 20px 16px;border-top:1px solid var(--cook-border);}
.cocina-mesero{font-size:.8rem;color:var(--cook-text2);}

.cocina-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;color:var(--cook-text2);text-align:center;}
.cocina-empty-icon{font-size:4rem;margin-bottom:16px;opacity:.4;}
.cocina-empty-txt{font-size:1.1rem;opacity:.6;}

/* â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:80px;right:16px;background:var(--text);color:#fff;padding:10px 16px;border-radius:var(--radius-sm);font-size:.84rem;z-index:9999;animation:toastIn .3s ease;box-shadow:var(--shadow-lg);max-width:300px;}
@media(min-width:768px){.toast{bottom:24px;right:24px;}}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px;}
.hidden{display:none!important;}


/* â•â•â• CLIENTE WEB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#cliente-app{display:none;min-height:100vh;padding:20px 14px;background:var(--bg);}
#cliente-app.show{display:block;}
.cliente-shell{max-width:780px;margin:0 auto;}
.cliente-card{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;box-shadow:var(--shadow);}
.cliente-title{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--accent);margin-bottom:6px;}
.cliente-subtitle{color:var(--text3);margin-bottom:18px;font-size:.92rem;}
.cliente-actions{display:grid;grid-template-columns:1fr;gap:10px;}
@media(min-width:560px){.cliente-actions{grid-template-columns:1fr 1fr;}}
.cliente-btn{border:1.5px solid var(--border);background:var(--surface2);color:var(--text);border-radius:12px;padding:14px 16px;font-size:1rem;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;text-align:left;}
.cliente-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(192,57,43,.05);}
.cliente-view{display:none;margin-top:14px;}
.cliente-view.show{display:block;}
.cliente-menu-list{display:grid;grid-template-columns:1fr;gap:8px;}
@media(min-width:560px){.cliente-menu-list{grid-template-columns:1fr 1fr;}}
.cliente-menu-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.cliente-pill{display:inline-block;background:rgba(41,128,185,.12);color:var(--blue);font-size:.72rem;font-weight:700;padding:2px 9px;border-radius:12px;text-transform:uppercase;letter-spacing:.05em;}
.cliente-result{margin-top:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface2);padding:12px;}
.cliente-result-item{display:flex;justify-content:space-between;gap:8px;padding:4px 0;border-bottom:1px solid var(--border);font-size:.9rem;}
.cliente-result-item:last-child{border-bottom:none;}
.cliente-result-total{display:flex;justify-content:space-between;align-items:center;border-top:2px solid var(--border);margin-top:8px;padding-top:8px;font-weight:700;color:var(--accent);}
.cliente-back{margin-top:12px;}
.cliente-mini-link{margin-top:14px;font-size:.84rem;color:var(--text3);}
.cliente-mini-link button{border:none;background:transparent;color:var(--accent);font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;}

</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="spinner"></div>
  <div class="loading-txt">Conectando con Firebase...</div>
</div>

<!-- CLIENTE WEB -->
<div id="cliente-app">
  <div class="cliente-shell">
    <div class="cliente-card">
      <div class="cliente-title">ğŸ½ Delicias</div>
      <div class="cliente-subtitle">Bienvenido. Selecciona una opciÃ³n para revisar el menÃº o consultar tu pedido.</div>
      <div id="cliente-home" class="cliente-view show">
        <div class="cliente-actions">
          <button class="cliente-btn" onclick="abrirClienteMenu()">ğŸ“– Revisar menÃº</button>
          <button class="cliente-btn" onclick="abrirConsultaPedido()">ğŸ” Consultar pedido</button>
        </div>
      </div>

      <div id="cliente-menu-view" class="cliente-view">
        <div class="section-title" style="margin-bottom:12px;font-size:1.1rem;">MenÃº disponible</div>
        <div class="cliente-menu-list" id="cliente-menu-list"></div>
        <div class="cliente-back"><button class="btn-ghost" onclick="volverInicioCliente()">â† Volver</button></div>
      </div>

      <div id="cliente-consulta-view" class="cliente-view">
        <div class="field" style="margin-bottom:8px;">
          <label>NÃºmero de mesa</label>
          <input type="number" id="cliente-mesa-input" min="1" step="1" placeholder="Ej: 4"/>
        </div>
        <button class="btn-primary" onclick="consultarPedidoCliente()">Consultar</button>
        <div id="cliente-pedido-resultado"></div>
        <div class="cliente-back"><button class="btn-ghost" onclick="volverInicioCliente()">â† Volver</button></div>
      </div>

      <div class="cliente-mini-link">Â¿Eres del personal? <button onclick="mostrarLogin()">Ingresar aquÃ­</button></div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">ğŸ½ Delicias</div>
    <div class="login-sub">Administrador de Mesas</div>
    <div class="login-field"><label>Usuario</label><input type="text" id="inp-user" placeholder="usuario" autocomplete="username"/></div>
    <div class="login-field"><label>ContraseÃ±a</label><input type="password" id="inp-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
    <button class="login-btn" onclick="doLogin()">Ingresar</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- TICKET (solo impresiÃ³n) -->
<div id="ticket-print"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- APP NORMAL (Admin / Mesero)                               -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="hidden">
  <header>
    <div class="header-brand">
      <h1>ğŸ½ Delicias</h1>
      <span>Administrador de Mesas</span>
    </div>
    <div class="header-actions">
      <span><span class="sync-dot" id="sync-dot"></span><span id="sync-txt" style="font-size:.74rem;color:var(--text3)">En lÃ­nea</span></span>
      <span id="fecha-lbl"></span>
      <div class="user-pill"><span id="header-username">â€”</span><span class="role-badge" id="header-role">â€”</span></div>
      <button class="btn-ghost" id="btn-cierre" onclick="cierreCaja()">ğŸ“Š Cierre de Caja</button>
      <button class="btn-ghost" onclick="doLogout()">Salir</button>
    </div>
  </header>

  <div class="tabs" id="tabs-bar">
    <button class="tab active" onclick="setTab('mesas',this)">ğŸª‘ Mesas</button>
    <button class="tab" onclick="setTab('productos',this)">ğŸ›’ Productos</button>
    <button class="tab" onclick="setTab('historial',this)">ğŸ“‹ Historial</button>
    <button class="tab admin-only hidden" id="tab-admin-btn" onclick="setTab('admin',this)">âš™ï¸ Admin</button>
  </div>

  <div class="main">
    <!-- MESAS -->
    <div id="tab-mesas">
      <div class="section-title">Mesas del Restaurante <span class="badge" id="badge-mesas">0 ocupadas</span></div>
      <div class="mesas-grid" id="mesas-grid"></div>
    </div>

    <!-- PRODUCTOS -->
    <div id="tab-productos" class="hidden">
      <div class="section-title">GestiÃ³n de Productos</div>
      <div id="add-prod-wrap">
        <div class="add-prod-form">
          <div class="field" style="margin:0"><label>Nombre</label><input type="text" id="prod-nombre" placeholder="Ej: Mojito"/></div>
          <div class="field" style="margin:0"><label>Precio (Gs.)</label><input type="number" id="prod-precio" placeholder="0" step="1" min="0"/></div>
          <div class="field" style="margin:0">
            <label>CategorÃ­a</label>
            <select id="prod-cat">
              <option value="comida">ğŸ• Comida</option>
              <option value="bebida">ğŸ¥¤ Bebida</option>
              <option value="postre">ğŸ¨ Postre</option>
            </select>
          </div>
          <button class="btn-primary" onclick="agregarProducto()" style="height:42px;align-self:end">+ AÃ±adir</button>
        </div>
      </div>
      <div class="productos-admin" id="productos-admin-list"></div>
    </div>

    <!-- HISTORIAL -->
    <div id="tab-historial" class="hidden">
      <div class="section-title">Historial de Ventas â€” Noche</div>
      <div class="report-summary">
        <div class="stat-card"><div class="stat-val" id="stat-clientes">0</div><div class="stat-lbl">Clientes Atendidos</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-mesas-h">0</div><div class="stat-lbl">Mesas Usadas</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-total">Gs. 0</div><div class="stat-lbl">Ingreso Total</div></div>
      </div>
      <div class="table-wrap" style="background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);">
        <div id="historial-container"></div>
      </div>
      <div id="btn-limpiar-wrap" style="margin-top:12px;text-align:right;display:none">
        <button class="btn-danger" onclick="limpiarHistorial()">ğŸ—‘ Limpiar historial de noche</button>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="tab-admin" class="hidden">
      <div class="section-title">âš™ï¸ Panel de AdministraciÃ³n</div>
      <div class="admin-grid">
        <div class="admin-card">
          <div class="admin-card-header">
            <span class="admin-card-title">ğŸ‘¥ Usuarios del Sistema</span>
            <button class="btn-primary" onclick="toggleAddUser()" style="font-size:.78rem;padding:5px 11px">+ Nuevo</button>
          </div>
          <div class="admin-card-body">
            <div id="add-user-wrap-panel" class="hidden">
              <div class="add-user-form">
                <div class="field" style="margin:0"><label>Nombre completo</label><input type="text" id="nu-nombre" placeholder="Ej: Juan PÃ©rez"/></div>
                <div class="field" style="margin:0"><label>Usuario</label><input type="text" id="nu-user" placeholder="juanp"/></div>
                <div class="field" style="margin:0"><label>ContraseÃ±a</label><input type="password" id="nu-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
                <div class="field" style="margin:0"><label>Confirmar</label><input type="password" id="nu-pass2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
                <div class="field" style="margin:0;grid-column:1/-1">
                  <label>Rol</label>
                  <select id="nu-role" style="width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.92rem;background:var(--surface2);color:var(--text);">
                    <option value="mesero">ğŸ½ Mesero</option>
                    <option value="cocinero">ğŸ‘¨â€ğŸ³ Cocinero/a</option>
                  </select>
                </div>
              </div>
              <div style="display:flex;gap:7px;margin-bottom:12px;">
                <button class="btn-success" onclick="crearUsuario()">âœ… Crear</button>
                <button class="btn-ghost" onclick="toggleAddUser()">Cancelar</button>
              </div>
            </div>
            <div class="user-list" id="users-list"></div>
          </div>
        </div>
        <div class="admin-card">
          <div class="admin-card-header">
            <span class="admin-card-title">ğŸ“ Registro de Actividad</span>
            <button class="btn-ghost" onclick="limpiarActividad()" style="font-size:.75rem;padding:4px 9px">Limpiar</button>
          </div>
          <div class="admin-card-body">
            <div class="activity-list" id="activity-list">
              <div class="empty-state"><div class="icon">ğŸ“</div><p>Sin actividad.</p></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NAV INFERIOR MÃ“VIL -->
<div class="bottom-nav" id="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="bnav-btn active" id="bnav-mesas" onclick="setTabMobile('mesas',this)"><span class="bnav-icon">ğŸª‘</span>Mesas</button>
    <button class="bnav-btn" id="bnav-productos" onclick="setTabMobile('productos',this)"><span class="bnav-icon">ğŸ›’</span>Productos</button>
    <button class="bnav-btn" id="bnav-historial" onclick="setTabMobile('historial',this)"><span class="bnav-icon">ğŸ“‹</span>Historial</button>
    <button class="bnav-btn admin-nav hidden" id="bnav-admin" onclick="setTabMobile('admin',this)"><span class="bnav-icon">âš™ï¸</span>Admin</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- APP COCINA (Cocinero/a)                                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="cocina-app">
  <div class="cocina-header">
    <div class="cocina-brand">
      <div>
        <div class="cocina-logo">ğŸ³ Cocina</div>
        <div class="cocina-subtitle">Delicias â€” Pedidos activos</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <span><span class="sync-dot" id="sync-dot-cocina"></span><span id="sync-txt-cocina" style="font-size:.74rem;color:var(--cook-text2)">En lÃ­nea</span></span>
      <div class="cocina-user-pill" id="cocina-user-lbl">ğŸ‘¨â€ğŸ³ â€”</div>
      <button class="cocina-hist-btn" onclick="abrirHistorialCocina()">ğŸ“‹ Pedidos Anteriores</button>
      <button class="cocina-salir" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <div class="cocina-main">
    <div class="cocina-titulo">
      Pedidos de Comida
      <span class="cocina-badge" id="cocina-badge">0 mesas</span>
    </div>
    <div class="cocina-grid" id="cocina-grid">
      <div class="cocina-empty">
        <div class="cocina-empty-icon">ğŸ½</div>
        <div class="cocina-empty-txt">Sin pedidos activos</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL MESA -->
<div class="modal-overlay" id="modal-mesa">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modal-title">Mesa 1</div>
        <div style="font-size:.76rem;color:var(--text3);margin-top:1px" id="modal-subtitle"></div>
      </div>
      <button class="modal-close" onclick="cerrarModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="field"><label>Mesero responsable</label>
        <input type="text" id="inp-mesero" readonly style="background:#f0ede9;cursor:default"/></div>
      <div class="pedido-layout">
        <div>
          <div style="font-size:.74rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:6px;">Productos</div>
          <div class="cat-tabs" id="cat-tabs-modal">
            <button class="cat-tab active" data-cat="todos" onclick="filtrarCat('todos',this)">ğŸ½ Todos</button>
            <button class="cat-tab" data-cat="bebida" onclick="filtrarCat('bebida',this)">ğŸ¥¤ Bebidas</button>
            <button class="cat-tab" data-cat="comida" onclick="filtrarCat('comida',this)">ğŸ• Comidas</button>
            <button class="cat-tab" data-cat="postre" onclick="filtrarCat('postre',this)">ğŸ¨ Postres</button>
          </div>
          <div class="productos-grid" id="productos-grid"></div>
        </div>
        <div>
          <div class="orden-panel">
            <h4>Pedido actual</h4>
            <div class="orden-items" id="orden-items"><div style="color:var(--text3);font-size:.82rem;padding:7px 0">Sin productos</div></div>
            <div class="orden-total"><span style="font-weight:600;color:var(--text2);font-size:.86rem">Total</span><span class="total-amount" id="pedido-total">Gs. 0</span></div>
          </div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <div style="font-size:.74rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:7px;">Clientes esta noche en esta mesa</div>
        <div id="clientes-mesa-list"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-success" onclick="confirmarPedido()">âœ… Confirmar pedido</button>
        <button class="btn-warning" onclick="marcarPagado()">ğŸ’° Pagado â€” Liberar</button>
        <button class="btn-blue" onclick="verHistorialMesa()">ğŸ“‹ Historial</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR PRODUCTO -->
<div class="modal-overlay" id="modal-edit-prod">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">Editar Producto</div><button class="modal-close" onclick="cerrarEditProd()">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-prod-id"/>
      <div class="field"><label>Nombre</label><input type="text" id="edit-prod-nombre"/></div>
      <div class="field"><label>Precio (Gs.)</label><input type="number" id="edit-prod-precio" step="1" min="0"/></div>
      <div class="field"><label>CategorÃ­a</label>
        <select id="edit-prod-cat">
          <option value="comida">ğŸ• Comida</option>
          <option value="bebida">ğŸ¥¤ Bebida</option>
          <option value="postre">ğŸ¨ Postre</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn-primary" onclick="guardarEditProd()">Guardar</button>
        <button class="btn-ghost" onclick="cerrarEditProd()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL COCINA -->
<div class="modal-overlay" id="modal-hist-cocina" style="z-index:300;">
  <div class="modal" style="max-width:680px;background:var(--cook-surface);border:1px solid var(--cook-border);">
    <div class="modal-header" style="background:var(--cook-surface);border-bottom:1px solid var(--cook-border);">
      <div class="modal-title" style="color:var(--cook-text);font-family:'Playfair Display',serif;">ğŸ“‹ Pedidos Anteriores â€” Cocina</div>
      <button class="modal-close" style="background:rgba(255,255,255,.07);color:var(--cook-text2);" onclick="$('modal-hist-cocina').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
      <div id="hist-cocina-body"></div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL MESA -->
<div class="modal-overlay" id="modal-hist-mesa">
  <div class="modal" style="max-width:600px">
    <div class="modal-header"><div class="modal-title" id="hist-mesa-title">Historial Mesa</div><button class="modal-close" onclick="$('modal-hist-mesa').classList.remove('open')">âœ•</button></div>
    <div class="modal-body"><div id="hist-mesa-body"></div></div>
  </div>
</div>

<!-- MODAL CAMBIAR CONTRASEÃ‘A -->
<div class="modal-overlay" id="modal-cambiar-pass">
  <div class="modal" style="max-width:380px">
    <div class="modal-header"><div class="modal-title">Cambiar ContraseÃ±a</div><button class="modal-close" onclick="$('modal-cambiar-pass').classList.remove('open')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="cp-user-id"/>
      <div id="cp-user-name" style="font-weight:600;color:var(--text2);margin-bottom:12px;font-size:.88rem;"></div>
      <div class="field"><label>Nueva contraseÃ±a</label><input type="password" id="cp-pass"/></div>
      <div class="field"><label>Confirmar</label><input type="password" id="cp-pass2"/></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn-primary" onclick="guardarNuevaPass()">Guardar</button>
        <button class="btn-ghost" onclick="$('modal-cambiar-pass').classList.remove('open')">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp }  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyCdKSf2g1cIyXrD6k_u1aR9TMln9HaPJro",
  authDomain:"delicia-restaurante.firebaseapp.com",
  databaseURL:"https://delicia-restaurante-default-rtdb.firebaseio.com",
  projectId:"delicia-restaurante",
  storageBucket:"delicia-restaurante.firebasestorage.app",
  messagingSenderId:"653903447900",
  appId:"1:653903447900:web:85cffda9d703e464af6399"
};
const fbApp = initializeApp(firebaseConfig);
const db    = getDatabase(fbApp);

// â”€â”€ CONSTANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CURRENCY    = 'Gs.';
const TOTAL_MESAS = 12;
const SESSION_KEY = 'delicias_sess_v4';
const TZ          = 'America/Asuncion';
const MASTER      = {id:'admin',username:'ADMIN',nombre:'Administrador',role:'admin'};

const CAT_DEFAULT = {
  'Coca Cola':'bebida','Pizza':'comida','Lomito':'comida','Jugos':'bebida',
  'Cerveza':'bebida','Agua':'bebida','Hamburguesa':'comida','Papas fritas':'comida',
  'Helado':'postre','Flan':'postre','TiramisÃº':'postre'
};
const CAT_LABELS  = {bebida:'ğŸ¥¤ Bebida',comida:'ğŸ• Comida',postre:'ğŸ¨ Postre'};

const fmt = n => CURRENCY+' '+Math.round(n).toLocaleString('es-PY');

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state  = {mesas:{},productos:[],historial:[],usuarios:[],actividad:[]};
let sesion = null;
let mesaAbierta = null;
let pedidoActual = {};
let catActiva = 'todos';
let timerInterval = null;
let cocinaTimerInterval = null;
let clienteConsultaMesaActual = null;
let clienteTimerInterval = null;

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.$ = id => document.getElementById(id);
const html = (id,h) => { const e=$(id); if(e) e.innerHTML=h; };

function toast(msg){
  const el=document.createElement('div');
  el.className='toast';el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}
function hora(){ return new Date().toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ}); }
function fechaHora(){ return new Date().toLocaleString('es-PY',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',timeZone:TZ}); }

// â”€â”€ SESIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const saveSession  = s => localStorage.setItem(SESSION_KEY,JSON.stringify(s));
const loadSession  = () => { try{ return JSON.parse(localStorage.getItem(SESSION_KEY)); }catch(e){ return null; } };
const clearSession = () => localStorage.removeItem(SESSION_KEY);

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot(){
  $('loading-screen').style.display='flex';
  try{
    await cargarDatos();
    suscribirCambios();
    if(!clienteTimerInterval){
      clienteTimerInterval=setInterval(()=>{
        if($('cliente-app')?.classList.contains('show')) renderConsultaPedidoCliente();
      },1000);
    }
    $('loading-screen').style.display='none';
    const saved=loadSession();
    if(saved && (saved.id==='admin'||state.usuarios.find(u=>u.id===saved.id))){
      sesion=saved; mostrarSegunRol();
    } else { clearSession(); mostrarClienteApp(); }
  }catch(err){
    console.error(err);
    $('loading-screen').style.display='none';
    mostrarClienteApp();
    toast('âš ï¸ Error de conexiÃ³n.');
  }
}

function mostrarLogin(){
  $('cliente-app').classList.remove('show');
  $('login-screen').classList.add('show');
  $('app').classList.add('hidden');
  $('cocina-app').classList.remove('show');
}
function ocultarLogin(){ $('login-screen').classList.remove('show'); }

function mostrarClienteApp(){
  ocultarLogin();
  detenerTimers();
  detenerTimersCocina();
  $('app').classList.add('hidden');
  $('cocina-app').classList.remove('show');
  $('cliente-app').classList.add('show');
  volverInicioCliente();
  renderClienteMenu();
}

function mostrarClienteView(viewId){
  ['cliente-home','cliente-menu-view','cliente-consulta-view'].forEach(id=>$(id).classList.remove('show'));
  $(viewId).classList.add('show');
}

function formatearTiempo(ms){
  if(!ms||ms<0) return '00m 00s';
  const sec=Math.floor(ms/1000);
  const h2=Math.floor(sec/3600),mn=Math.floor((sec%3600)/60),s=sec%60;
  return h2>0 ? `${h2}h ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s` : `${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
}

function renderClienteMenu(){
  const prods=[...state.productos].sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
  if(!prods.length){ html('cliente-menu-list','<div style="color:var(--text3);font-size:.9rem;">Sin productos disponibles por ahora.</div>'); return; }
  html('cliente-menu-list',prods.map(p=>`<div class="cliente-menu-item"><div><div style="font-weight:600;color:var(--text);">${p.nombre}</div><span class="cliente-pill">${CAT_LABELS[p.cat||'comida']||p.cat||'Comida'}</span></div><div style="font-weight:700;color:var(--accent);">${fmt(p.precio)}</div></div>`).join(''));
}

function renderConsultaPedidoCliente(){
  if(!clienteConsultaMesaActual) return;
  const mesa=state.mesas[clienteConsultaMesaActual];
  const box=$('cliente-pedido-resultado');
  if(!mesa||!mesa.ocupada||!mesa.pedidoActual||!Object.keys(mesa.pedidoActual).length){
    box.innerHTML='<div class="cliente-result" style="color:var(--text3);">No hay un pedido activo para esa mesa.</div>';
    clienteConsultaMesaActual=null;
    return;
  }

  const items=Object.entries(mesa.pedidoActual)
    .map(([pid,qty])=>{
      const p=state.productos.find(x=>String(x.id)===String(pid));
      if(!p||qty<=0) return null;
      return {nombre:p.nombre,qty,sub:p.precio*qty};
    })
    .filter(Boolean);

  if(!items.length){
    box.innerHTML='<div class="cliente-result" style="color:var(--text3);">No hay productos cargados para esa mesa.</div>';
    return;
  }

  const total=items.reduce((acc,it)=>acc+it.sub,0);
  const inicio=mesa.tsOcupada||Date.now();
  const horaSolicitud=new Date(inicio).toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ});
  const tiempo=formatearTiempo(Date.now()-inicio);

  box.innerHTML=`<div class="cliente-result">
    <div style="font-weight:700;color:var(--text);margin-bottom:4px;">Mesa ${clienteConsultaMesaActual}</div>
    <div style="font-size:.86rem;color:var(--text2);margin-bottom:8px;">ğŸ• Hora de solicitud: ${horaSolicitud} Â· â± Tiempo: ${tiempo}</div>
    ${items.map(it=>`<div class="cliente-result-item"><span>${it.qty}Ã— ${it.nombre}</span><strong>${fmt(it.sub)}</strong></div>`).join('')}
    <div class="cliente-result-total"><span>Total a pagar</span><span>${fmt(total)}</span></div>
  </div>`;
}

window.abrirClienteMenu = function(){ renderClienteMenu(); mostrarClienteView('cliente-menu-view'); };
window.abrirConsultaPedido = function(){ clienteConsultaMesaActual=null; $('cliente-mesa-input').value=''; $('cliente-pedido-resultado').innerHTML=''; mostrarClienteView('cliente-consulta-view'); $('cliente-mesa-input').focus(); };
window.volverInicioCliente = function(){ clienteConsultaMesaActual=null; $('cliente-pedido-resultado').innerHTML=''; mostrarClienteView('cliente-home'); };
window.consultarPedidoCliente = function(){
  const mesaNum=Number($('cliente-mesa-input').value);
  if(!Number.isInteger(mesaNum)||mesaNum<1||mesaNum>TOTAL_MESAS){
    $('cliente-pedido-resultado').innerHTML=`<div class="cliente-result" style="color:var(--red);">Ingresa un nÃºmero de mesa vÃ¡lido (1 a ${TOTAL_MESAS}).</div>`;
    return;
  }
  clienteConsultaMesaActual=mesaNum;
  renderConsultaPedidoCliente();
};

function mostrarSegunRol(){
  $('cliente-app').classList.remove('show');
  if(sesion.role==='cocinero'){
    ocultarLogin();
    $('app').classList.add('hidden');
    mostrarCocina();
  } else {
    ocultarLogin();
    $('cocina-app').classList.remove('show');
    mostrarApp();
  }
}

// â”€â”€ VISTA NORMAL (Admin / Mesero) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarApp(){
  $('app').classList.remove('hidden');
  $('header-username').textContent = sesion.nombre||sesion.username;
  $('header-role').textContent     = sesion.role==='admin'?'Admin':'Mesero';
  $('header-role').className       = 'role-badge '+(sesion.role==='admin'?'admin':'mesero');
  $('fecha-lbl').textContent       = new Date().toLocaleDateString('es-PY',{weekday:'long',year:'numeric',month:'long',day:'numeric',timeZone:TZ});
  if(sesion.role==='admin'){
    $('tab-admin-btn').classList.remove('hidden');
    $('btn-limpiar-wrap').style.display='block';
    $('btn-cierre').style.display='flex';
    $('add-prod-wrap').style.display='';
    const ba=$('bnav-admin'); if(ba) ba.classList.remove('hidden');
  } else {
    $('tab-admin-btn').classList.add('hidden');
    $('btn-limpiar-wrap').style.display='none';
    $('btn-cierre').style.display='none';
    $('add-prod-wrap').style.display='none';
    const ba=$('bnav-admin'); if(ba) ba.classList.add('hidden');
  }
  $('inp-mesero').value = sesion.nombre||sesion.username;
  renderMesas();
  renderProductosAdmin();
  renderHistorial();
  iniciarTimers();
  registrarActividad('accion-login','IngresÃ³ al sistema');
}

// â”€â”€ VISTA COCINA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarCocina(){
  $('cocina-app').classList.add('show');
  $('cocina-user-lbl').textContent = 'ğŸ‘¨â€ğŸ³ '+(sesion.nombre||sesion.username);
  renderCocina();
  iniciarTimersCocina();
  registrarActividad('accion-login','IngresÃ³ como Cocinero/a');
}

function iniciarTimersCocina(){
  detenerTimersCocina();
  cocinaTimerInterval = setInterval(actualizarTimersCocina, 1000);
}
function detenerTimersCocina(){
  if(cocinaTimerInterval){ clearInterval(cocinaTimerInterval); cocinaTimerInterval=null; }
}
function actualizarTimersCocina(){
  const ahora = Date.now();
  for(let i=1;i<=TOTAL_MESAS;i++){
    const el = document.getElementById(`cocina-timer-${i}`);
    if(!el) continue;
    const m = state.mesas[i];
    if(!m||!m.ocupada||!m.tsOcupada){ el.textContent=''; el.className='cocina-timer-big'; continue; }
    const diff = Math.floor((ahora - m.tsOcupada)/1000);
    const h2=Math.floor(diff/3600), mn=Math.floor((diff%3600)/60), s=diff%60;
    el.textContent = h2>0
      ? `â± ${h2}h ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`
      : `â± ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    el.className = 'cocina-timer-big'+(diff>=5400?' alerta':'');
  }
}

// â”€â”€ COLA COCINA (Ãºltimas 5, mÃ¡s nuevas primero) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Muestra los 5 pedidos mÃ¡s NUEVOS en pantalla.
// "Pedidos Anteriores" = los que quedaron fuera (posiciÃ³n 6+) + los ya pagados/liberados.
let historialCocinaLocal = []; // acumula: {mesaNum, mesero, hora, items, tipo:'oculta'|'pagada'}

function renderCocina(){
  const mesasConComida = [];
  for(let i=1;i<=TOTAL_MESAS;i++){
    const m=state.mesas[i];
    if(!m||!m.ocupada||!m.pedidoActual) continue;
    const itemsComida = Object.entries(m.pedidoActual).filter(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return p && (p.cat||'comida')==='comida' && qty>0;
    });
    if(itemsComida.length>0){
      mesasConComida.push({num:i, mesa:m, items:itemsComida, ts: m.tsOcupada||0});
    }
  }

  // Ordenar DESC: los mÃ¡s nuevos primero
  mesasConComida.sort((a,b)=>b.ts-a.ts);

  // Las 5 mÃ¡s nuevas se muestran en pantalla
  const visibles  = mesasConComida.slice(0,5);
  // Las que quedan fuera (posiciÃ³n 6+) van al historial como "ocultas"
  const ocultas   = mesasConComida.slice(5);

  // Sincronizar ocultas al historial local (evitar duplicados por mesaNum)
  ocultas.forEach(({num, mesa, items})=>{
    const yaEsta = historialCocinaLocal.some(h=>h.mesaNum===num && h.tipo==='oculta');
    if(!yaEsta){
      historialCocinaLocal.unshift({
        mesaNum: num,
        mesero: mesa.mesero||'â€”',
        hora: hora(),
        tipo: 'oculta',
        items: items.map(([pid,qty])=>{
          const p=state.productos.find(p=>String(p.id)===String(pid));
          return {nombre:p?p.nombre:'?',qty};
        })
      });
    }
  });
  // Si una mesa oculta volviÃ³ a ser visible (se liberaron mesas delante), limpiar su entrada 'oculta'
  const numsVisibles = visibles.map(v=>v.num);
  historialCocinaLocal = historialCocinaLocal.filter(h=>
    !(h.tipo==='oculta' && numsVisibles.includes(h.mesaNum))
  );

  const badge=$('cocina-badge');
  if(badge){
    const total=mesasConComida.length;
    const oculN=ocultas.length;
    badge.textContent=total===0?'Sin pedidos'
      :`${total} pedido${total!==1?'s':''}${oculN>0?` Â· ${oculN} oculto${oculN!==1?'s':''}`:'' }`;
  }

  if(!visibles.length){
    html('cocina-grid',`<div class="cocina-empty">
      <div class="cocina-empty-icon">ğŸ½</div>
      <div class="cocina-empty-txt">Sin pedidos de comida activos</div>
    </div>`);
    return;
  }

  html('cocina-grid', visibles.map(({num,mesa,items},idx)=>{
    const itemsHtml = items.map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      if(!p) return '';
      return `<div class="cocina-item">
        <div class="cocina-item-qty">${qty}</div>
        <div>
          <div class="cocina-item-name">${p.nombre}</div>
        </div>
      </div>`;
    }).join('');

    // idx 0 = mÃ¡s nuevo = reciÃ©n llegado (resaltado)
    const esNuevo = idx===0;
    const borderColor = esNuevo ? 'var(--cook-accent)' : 'var(--cook-border)';
    const extraClass  = esNuevo ? 'nueva' : '';

    return `<div class="cocina-card ${extraClass}" style="border-color:${borderColor};">
      <div class="cocina-card-header">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <div style="background:${esNuevo?'var(--cook-accent)':'rgba(255,255,255,.1)'};color:${esNuevo?'#fff':'var(--cook-text2)'};font-family:'DM Sans',sans-serif;font-size:.7rem;font-weight:800;padding:2px 8px;border-radius:20px;margin-top:4px;letter-spacing:.06em;white-space:nowrap;">${esNuevo?'ğŸ†• NUEVO':'#'+(idx+1)}</div>
          <div>
            <div class="cocina-mesa-lbl">Mesa</div>
            <div class="cocina-mesa-num">${num}</div>
          </div>
        </div>
        <div id="cocina-timer-${num}" class="cocina-timer-big"></div>
      </div>
      <div class="cocina-card-body">
        <div class="cocina-items-list">${itemsHtml}</div>
      </div>
      ${mesa.mesero?`<div class="cocina-card-footer"><div class="cocina-mesero">ğŸ‘¤ ${mesa.mesero}</div></div>`:''}
    </div>`;
  }).join(''));

  actualizarTimersCocina();
}

// â”€â”€ HISTORIAL COCINA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Captura pedidos PAGADOS (mesa liberada â†’ pasa a historial como tipo 'pagada')
// y elimina cualquier entrada 'oculta' de esa misma mesa (ya que se solucionÃ³)
function capturarHistorialCocina(mesaNum, mesa, pedido){
  const itemsComida = Object.entries(pedido).filter(([pid,qty])=>{
    const p=state.productos.find(p=>String(p.id)===String(pid));
    return p && (p.cat||'comida')==='comida' && qty>0;
  });
  if(!itemsComida.length) return;

  // Eliminar entrada 'oculta' de esta mesa si la habÃ­a
  historialCocinaLocal = historialCocinaLocal.filter(h=>!(h.mesaNum===mesaNum && h.tipo==='oculta'));

  // Agregar como 'pagada' al inicio
  historialCocinaLocal.unshift({
    mesaNum,
    mesero: mesa.mesero||'â€”',
    hora: hora(),
    tipo: 'pagada',
    items: itemsComida.map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return {nombre:p?p.nombre:'?',qty};
    })
  });
  if(historialCocinaLocal.length>80) historialCocinaLocal=historialCocinaLocal.slice(0,80);
}

window.abrirHistorialCocina = function(){
  const body=$('hist-cocina-body'); if(!body) return;
  if(!historialCocinaLocal.length){
    body.innerHTML=`<div style="text-align:center;padding:40px 20px;color:var(--cook-text2);">
      <div style="font-size:3rem;opacity:.35;margin-bottom:12px;">ğŸ“‹</div>
      <div>Sin pedidos anteriores en esta sesiÃ³n</div>
    </div>`;
  } else {
    const tipoBadge={
      oculta:`<span style="background:rgba(230,126,34,.18);color:#e67e22;border:1px solid rgba(230,126,34,.3);border-radius:20px;padding:2px 9px;font-size:.7rem;font-weight:700;">EN COLA</span>`,
      pagada:`<span style="background:rgba(39,174,96,.15);color:#27ae60;border:1px solid rgba(39,174,96,.3);border-radius:20px;padding:2px 9px;font-size:.7rem;font-weight:700;">âœ“ ENTREGADO</span>`
    };
    body.innerHTML = historialCocinaLocal.map(h=>`
      <div style="background:rgba(255,255,255,.04);border:1px solid var(--cook-border);border-radius:10px;padding:14px 16px;margin-bottom:9px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px;">
          <div style="display:flex;align-items:center;gap:9px;">
            <span style="font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--cook-text);font-weight:700;">Mesa ${h.mesaNum}</span>
            ${tipoBadge[h.tipo]||''}
          </div>
          <div style="font-size:.74rem;color:var(--cook-text2);">ğŸ• ${h.hora}&nbsp;Â·&nbsp;ğŸ‘¤ ${h.mesero}</div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:7px;">
          ${h.items.map(it=>`
            <div style="background:rgba(233,69,96,.1);border:1px solid rgba(233,69,96,.2);border-radius:7px;padding:5px 12px;font-size:.9rem;color:var(--cook-text);font-weight:600;">
              <span style="color:var(--cook-accent);font-family:'Playfair Display',serif;font-size:1.1rem;">${it.qty}Ã—</span> ${it.nombre}
            </div>`).join('')}
        </div>
      </div>`).join('');
  }
  $('modal-hist-cocina').classList.add('open');
};

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doLogin = function(){
  const u=$('inp-user').value.trim().toUpperCase();
  const p=$('inp-pass').value.trim();
  $('login-err').textContent='';
  if(u==='ADMIN'&&p==='1234RD'){ sesion={...MASTER}; saveSession(sesion); mostrarSegunRol(); return; }
  const found=state.usuarios.find(x=>x.username.toUpperCase()===u&&x.password===p);
  if(found){
    sesion={id:found.id,username:found.username,nombre:found.nombre,role:found.role||'mesero'};
    saveSession(sesion);
    mostrarSegunRol();
  } else $('login-err').textContent='Usuario o contraseÃ±a incorrectos.';
};

window.doLogout = function(){
  if(sesion) registrarActividad('accion-login','CerrÃ³ sesiÃ³n');
  clearSession(); sesion=null;
  detenerTimers();
  detenerTimersCocina();
  $('app').classList.add('hidden');
  $('cocina-app').classList.remove('show');
  mostrarClienteApp();
  $('inp-user').value=''; $('inp-pass').value=''; $('login-err').textContent='';
  setTabDirect('mesas');
};

$('inp-pass').addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });
$('inp-user').addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });
$('cliente-mesa-input').addEventListener('keydown',e=>{ if(e.key==='Enter') window.consultarPedidoCliente(); });

// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mesaDefault(){ return {ocupada:false,mesero:'',pedidoActual:{},clientesNoche:[],tsOcupada:null}; }

function productosDefault(){
  return [
    {id:1,nombre:'Coca Cola',precio:150,cat:'bebida'},
    {id:2,nombre:'Pizza',precio:850,cat:'comida'},
    {id:3,nombre:'Lomito',precio:950,cat:'comida'},
    {id:4,nombre:'Jugos',precio:120,cat:'bebida'},
    {id:5,nombre:'Cerveza',precio:200,cat:'bebida'},
    {id:6,nombre:'Agua',precio:80,cat:'bebida'},
    {id:7,nombre:'Hamburguesa',precio:700,cat:'comida'},
    {id:8,nombre:'Papas fritas',precio:350,cat:'comida'},
    {id:9,nombre:'Helado',precio:180,cat:'postre'},
    {id:10,nombre:'Flan',precio:120,cat:'postre'},
    {id:11,nombre:'TiramisÃº',precio:250,cat:'postre'},
  ];
}

async function cargarDatos(){
  const [msSnap,prSnap,hiSnap,usSnap,acSnap]=await Promise.all([
    get(ref(db,'mesas')),get(ref(db,'productos')),
    get(ref(db,'historial')),get(ref(db,'usuarios')),get(ref(db,'actividad'))
  ]);
  if(msSnap.exists()){ state.mesas=msSnap.val();
    for(let i=1;i<=TOTAL_MESAS;i++) if(!state.mesas[i]){state.mesas[i]=mesaDefault();await set(ref(db,`mesas/${i}`),state.mesas[i]);}
  } else {
    for(let i=1;i<=TOTAL_MESAS;i++) state.mesas[i]=mesaDefault();
    await set(ref(db,'mesas'),state.mesas);
  }
  if(prSnap.exists()){ const r=prSnap.val(); state.productos=Array.isArray(r)?r:Object.values(r);
    let migrado=false;
    state.productos.forEach(p=>{ if(!p.cat){ p.cat=CAT_DEFAULT[p.nombre]||'comida'; migrado=true; } });
    if(migrado) await set(ref(db,'productos'),state.productos);
  } else { state.productos=productosDefault(); await set(ref(db,'productos'),state.productos); }
  if(hiSnap.exists()){ const r=hiSnap.val(); state.historial=Array.isArray(r)?r:Object.values(r); } else state.historial=[];
  if(usSnap.exists()){ const r=usSnap.val(); state.usuarios=Array.isArray(r)?r:Object.values(r); } else state.usuarios=[];
  if(acSnap.exists()){ const r=acSnap.val(); state.actividad=Array.isArray(r)?r:Object.values(r); } else state.actividad=[];
}

function suscribirCambios(){
  let prevMesas = {}; // para detectar cambios de ocupadaâ†’libre en cocina
  onValue(ref(db,'mesas'),snap=>{
    if(snap.exists()){
      const newMesas=snap.val();
      // Si es cocinero, detectar mesas que pasaron de ocupadaâ†’libre y capturar historial
      if(sesion?.role==='cocinero'){
        for(let i=1;i<=TOTAL_MESAS;i++){
          const prev=prevMesas[i], next=newMesas[i];
          if(prev&&prev.ocupada&&next&&!next.ocupada&&prev.pedidoActual&&Object.keys(prev.pedidoActual).length){
            capturarHistorialCocina(i, prev, prev.pedidoActual);
          }
        }
      }
      prevMesas={...newMesas};
      state.mesas=newMesas;
      renderMesas();
      if(mesaAbierta) renderClientesMesa(mesaAbierta);
      if(sesion?.role==='cocinero') renderCocina();
      renderConsultaPedidoCliente();
    }
    setSyncOk(true);
  },()=>setSyncOk(false));
  onValue(ref(db,'productos'),snap=>{ if(snap.exists()){const r=snap.val();state.productos=Array.isArray(r)?r:Object.values(r);}renderProductosAdmin();if(mesaAbierta)renderProductosGrid();renderClienteMenu();renderConsultaPedidoCliente(); });
  onValue(ref(db,'historial'),snap=>{ if(snap.exists()){const r=snap.val();state.historial=Array.isArray(r)?r:Object.values(r);}else state.historial=[];renderHistorial(); });
  onValue(ref(db,'usuarios'),snap=>{ if(snap.exists()){const r=snap.val();state.usuarios=Array.isArray(r)?r:Object.values(r);}else state.usuarios=[];renderUsersList(); });
  onValue(ref(db,'actividad'),snap=>{ if(snap.exists()){const r=snap.val();state.actividad=Array.isArray(r)?r:Object.values(r);}else state.actividad=[];renderActividad(); });
}

function setSyncOk(ok){
  // App normal
  const dot=$('sync-dot'),txt=$('sync-txt'); if(dot){ dot.className='sync-dot'+(ok?'':' offline'); txt.textContent=ok?'En lÃ­nea':'Sin conexiÃ³n'; }
  // Cocina
  const dotC=$('sync-dot-cocina'),txtC=$('sync-txt-cocina'); if(dotC){ dotC.className='sync-dot'+(ok?'':' offline'); txtC.textContent=ok?'En lÃ­nea':'Sin conexiÃ³n'; }
}

const saveMesa      = num => set(ref(db,`mesas/${num}`),state.mesas[num]);
const saveProductos = ()  => set(ref(db,'productos'),state.productos);
const saveHistorial = ()  => set(ref(db,'historial'),state.historial);
const saveUsuarios  = ()  => set(ref(db,'usuarios'),state.usuarios);

// â”€â”€ TIMERS NORMAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function iniciarTimers(){ detenerTimers(); timerInterval=setInterval(actualizarTimers,1000); }
function detenerTimers(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }

function actualizarTimers(){
  const ahora=Date.now();
  for(let i=1;i<=TOTAL_MESAS;i++){
    const el=document.getElementById(`timer-mesa-${i}`); if(!el) continue;
    const m=state.mesas[i];
    if(!m||!m.ocupada||!m.tsOcupada){ el.textContent=''; el.className='mesa-timer'; continue; }
    const diff=Math.floor((ahora-m.tsOcupada)/1000);
    const h2=Math.floor(diff/3600),mn=Math.floor((diff%3600)/60),s=diff%60;
    el.textContent=h2>0?`â± ${h2}h ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`:`â± ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    el.className='mesa-timer'+(diff>=5400?' alerta':'');
  }
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setTab = function(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['mesas','productos','historial','admin'].forEach(t=>$('tab-'+t).classList.toggle('hidden',t!==tab));
};
window.setTabMobile = function(tab,el){
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['mesas','productos','historial','admin'].forEach(t=>$('tab-'+t).classList.toggle('hidden',t!==tab));
};
function setTabDirect(tab){
  ['mesas','productos','historial','admin'].forEach(t=>$('tab-'+t).classList.toggle('hidden',t!==tab));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
}

// â”€â”€ RENDER MESAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcTotal(pedido){
  if(!pedido) return 0;
  return Object.entries(pedido).reduce((s,[pid,qty])=>{
    const p=state.productos.find(p=>String(p.id)===String(pid));
    return s+(p?p.precio*qty:0);
  },0);
}

function renderMesas(){
  if(sesion?.role==='cocinero') return; // no aplica
  let h='',ocp=0;
  for(let i=1;i<=TOTAL_MESAS;i++){
    const m=state.mesas[i]||mesaDefault();
    const tot=calcTotal(m.pedidoActual);
    if(m.ocupada) ocp++;
    h+=`<div class="mesa-card ${m.ocupada?'ocupada':''}" onclick="abrirMesa(${i})">
      <div class="mesa-top">
        <div class="mesa-label">Mesa</div>
        <div class="mesa-num">${i}</div>
      </div>
      <div class="mesa-bottom">
        <div class="mesa-status ${m.ocupada?'ocupada':'libre'}">${m.ocupada?'Ocupada':'Libre'}</div>
        ${m.mesero?`<div class="mesa-mesero">ğŸ‘¤ ${m.mesero}</div>`:''}
        ${m.ocupada&&tot>0?`<div class="mesa-total">${fmt(tot)}</div>`:''}
        <div class="mesa-timer" id="timer-mesa-${i}"></div>
      </div>
    </div>`;
  }
  html('mesas-grid',h);
  const b=$('badge-mesas'); if(b) b.textContent=`${ocp} ocupada${ocp!==1?'s':''}`;
  actualizarTimers();
}

// â”€â”€ MODAL MESA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.abrirMesa = function(num){
  mesaAbierta=num;
  const m=state.mesas[num]||mesaDefault();
  pedidoActual={...(m.pedidoActual||{})};
  $('modal-title').textContent=`Mesa ${num}`;
  $('modal-subtitle').textContent=m.ocupada?'ğŸ”´ Ocupada':'ğŸŸ¢ Disponible';
  $('inp-mesero').value=sesion?sesion.nombre||sesion.username:'';
  catActiva='todos';
  document.querySelectorAll('#cat-tabs-modal .cat-tab').forEach(t=>t.classList.toggle('active',t.dataset.cat==='todos'));
  renderProductosGrid();
  renderPedidoActual();
  renderClientesMesa(num);
  $('modal-mesa').classList.add('open');
};
window.cerrarModal = function(){ $('modal-mesa').classList.remove('open'); mesaAbierta=null; };

window.filtrarCat = function(cat,el){
  catActiva=cat;
  document.querySelectorAll('#cat-tabs-modal .cat-tab').forEach(t=>t.classList.toggle('active',t===el));
  renderProductosGrid();
};

function renderProductosGrid(){
  const prods=catActiva==='todos'?state.productos:state.productos.filter(p=>(p.cat||'comida')===catActiva);
  if(!prods.length){ html('productos-grid','<div style="color:var(--text3);grid-column:1/-1;font-size:.82rem;padding:10px 0">Sin productos en esta categorÃ­a.</div>'); return; }
  html('productos-grid',prods.map(p=>
    `<button class="producto-btn" onclick="addProd(${p.id})">
      <span class="prod-name">${p.nombre}</span>
      <span class="prod-price">${fmt(p.precio)}</span>
    </button>`).join(''));
}

window.addProd = function(pid){ pedidoActual[pid]=(pedidoActual[pid]||0)+1; renderPedidoActual(); };
window.cambiarQty = function(pid,d){
  pedidoActual[pid]=(pedidoActual[pid]||0)+d;
  if(pedidoActual[pid]<=0) delete pedidoActual[pid];
  renderPedidoActual();
};

function renderPedidoActual(){
  const items=Object.entries(pedidoActual);
  if(!items.length){ html('orden-items','<div style="color:var(--text3);font-size:.82rem;padding:7px 0">Sin productos</div>'); $('pedido-total').textContent=fmt(0); return; }
  let total=0,h='';
  for(const [pid,qty] of items){
    const p=state.productos.find(p=>String(p.id)===String(pid)); if(!p) continue;
    const sub=p.precio*qty; total+=sub;
    h+=`<div class="orden-item">
      <span class="orden-item-name">${p.nombre}</span>
      <span class="orden-item-qty">
        <button class="qty-btn" onclick="cambiarQty(${pid},-1)">âˆ’</button>
        <span class="qty-num">${qty}</span>
        <button class="qty-btn" onclick="cambiarQty(${pid},1)">+</button>
      </span>
      <span class="orden-item-price">${fmt(sub)}</span>
    </div>`;
  }
  html('orden-items',h); $('pedido-total').textContent=fmt(total);
}

window.confirmarPedido = async function(){
  if(!mesaAbierta) return;
  if(!Object.keys(pedidoActual).length){ toast('AÃ±ade al menos un producto.'); return; }
  const mesero=sesion?sesion.nombre||sesion.username:'';
  const m=state.mesas[mesaAbierta];
  const yaOcupada=m.ocupada;
  m.pedidoActual={...pedidoActual};
  m.mesero=mesero; m.ocupada=true; m.ultimoUsuario=sesion?.username||'';
  if(!yaOcupada) m.tsOcupada=Date.now();
  await saveMesa(mesaAbierta);
  $('modal-subtitle').textContent='ğŸ”´ Ocupada';
  await registrarActividad('accion-pedido',`ConfirmÃ³ pedido en Mesa ${mesaAbierta} (${fmt(calcTotal(pedidoActual))})`);
  toast(`âœ… Pedido confirmado â€” Mesa ${mesaAbierta}`);
};

window.marcarPagado = async function(){
  if(!mesaAbierta) return;
  const m=state.mesas[mesaAbierta];
  const mesero=sesion?sesion.nombre||sesion.username:'';
  let ticketData=null;
  if(Object.keys(pedidoActual).length>0){
    const cn=m.clientesNoche||[];
    const detalles=Object.entries(pedidoActual).map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return p?{nombre:p.nombre,qty,precio:p.precio,sub:p.precio*qty,cat:p.cat||'comida'}:null;
    }).filter(Boolean);
    const total=calcTotal(pedidoActual);
    const tiempoOcupada=m.tsOcupada?Math.floor((Date.now()-m.tsOcupada)/60000):null;
    cn.push({num:cn.length+1,detalles,total,mesero,usuario:sesion?.username||'',hora:hora(),tiempoMin:tiempoOcupada});
    m.clientesNoche=cn;
    state.historial.push({mesa:mesaAbierta,clienteNum:cn.length,detalles,total,mesero,usuario:sesion?.username||'',hora:hora()});
    await saveHistorial();
    await registrarActividad('accion-pago',`MarcÃ³ Mesa ${mesaAbierta} como pagada â€” ${fmt(total)}`);
    ticketData={mesa:mesaAbierta,clienteNum:cn.length,detalles,total,mesero,hora:hora()};
    // Capturar en historial cocina ANTES de limpiar la mesa
    capturarHistorialCocina(mesaAbierta, m, pedidoActual);
  }
  m.ocupada=false; m.pedidoActual={}; m.mesero=''; m.ultimoUsuario=''; m.tsOcupada=null;
  await saveMesa(mesaAbierta);
  pedidoActual={};
  cerrarModal();
  toast(`ğŸ’° Mesa ${mesaAbierta} liberada âœ…`);
  if(ticketData) setTimeout(()=>imprimirTicket(ticketData),300);
};

function renderClientesMesa(num){
  const m=state.mesas[num];
  const cl=m&&m.clientesNoche?m.clientesNoche:[];
  if(!cl.length){ html('clientes-mesa-list','<div style="color:var(--text3);font-size:.8rem;">Sin clientes registrados esta noche.</div>'); return; }
  html('clientes-mesa-list',cl.map(c=>`
    <div class="cliente-item">
      <div class="cliente-header">
        <span class="cliente-num">Cliente ${c.num}Â°</span>
        <span style="font-size:.85rem;font-weight:600;color:var(--text2)">${fmt(c.total)}</span>
      </div>
      <div class="cliente-items-list">${c.detalles.map(d=>`${d.qty}x ${d.nombre} = ${fmt(d.sub)}`).join(' Â· ')}</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;margin-top:3px;">
        ${c.mesero?`<span class="mesero-badge">ğŸ‘¤ ${c.mesero}</span>`:''}
        ${c.usuario?`<span class="mesero-badge" style="color:var(--blue)">ğŸ–¥ ${c.usuario}</span>`:''}
        ${c.tiempoMin!=null?`<span class="mesero-badge">â± ${c.tiempoMin}min</span>`:''}
      </div>
    </div>`).join(''));
}

window.verHistorialMesa = function(){
  if(!mesaAbierta) return;
  const cl=(state.mesas[mesaAbierta]?.clientesNoche)||[];
  $('hist-mesa-title').textContent=`Historial Completo â€” Mesa ${mesaAbierta}`;
  if(!cl.length){ html('hist-mesa-body','<div class="empty-state"><div class="icon">ğŸ“‹</div><p>Sin historial esta noche.</p></div>'); }
  else{
    let tot=0;
    let h='<table class="history-table"><thead><tr><th>Cliente</th><th>Detalle</th><th>Mesero</th><th>Tiempo</th><th>Total</th></tr></thead><tbody>';
    cl.forEach(c=>{ tot+=c.total;
      h+=`<tr><td>Cliente ${c.num}Â°</td><td>${c.detalles.map(d=>`${d.qty}Ã— ${d.nombre}`).join(', ')}</td><td>${c.mesero||'â€”'}</td><td>${c.tiempoMin!=null?c.tiempoMin+'min':'â€”'}</td><td>${fmt(c.total)}</td></tr>`;
    });
    h+=`<tr class="total-row"><td colspan="4">Total Mesa ${mesaAbierta}</td><td>${fmt(tot)}</td></tr></tbody></table>`;
    html('hist-mesa-body',h);
  }
  $('modal-hist-mesa').classList.add('open');
};

// â”€â”€ TICKET 80mm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function imprimirTicket(t){
  // Agrupar por categorÃ­a
  const cats={bebida:[],comida:[],postre:[]};
  t.detalles.forEach(d=>{ const c=d.cat||'comida'; (cats[c]=cats[c]||[]).push(d); });

  const catNames={comida:'COMIDAS',bebida:'BEBIDAS',postre:'POSTRES'};
  let itemsHtml='';
  ['comida','bebida','postre'].forEach(cat=>{
    if(!cats[cat]||!cats[cat].length) return;
    itemsHtml+=`<div class="ticket-cat-hdr">${catNames[cat]}</div>`;
    cats[cat].forEach(d=>{
      // Truncar nombre si es muy largo para 80mm
      const nombre = d.nombre.length>20 ? d.nombre.slice(0,19)+'â€¦' : d.nombre;
      itemsHtml+=`<div class="ticket-row">
        <span class="ticket-item-name">${d.qty}x ${nombre}</span>
        <span class="ticket-item-price">${fmt(d.sub)}</span>
      </div>`;
    });
  });

  const now=new Date();
  const fechaTk=now.toLocaleDateString('es-PY',{day:'2-digit',month:'2-digit',year:'numeric',timeZone:TZ});
  const horaTk=now.toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:TZ});

  $('ticket-print').innerHTML=`
  <div class="ticket-wrap">
    <div class="ticket-title">RESTAURANTE</div>
    <div class="ticket-title" style="font-size:17pt;letter-spacing:4px;">DELICIAS</div>
    <div class="ticket-div"></div>
    <div class="ticket-row bold"><span>Mesa:</span><span>${t.mesa}</span></div>
    <div class="ticket-row bold"><span>Cliente:</span><span>${t.clienteNum}Â°</span></div>
    <div class="ticket-row"><span>Mesero:</span><span>${t.mesero||'â€”'}</span></div>
    <div class="ticket-row"><span>Fecha:</span><span>${fechaTk}</span></div>
    <div class="ticket-row"><span>Hora:</span><span>${horaTk}</span></div>
    <div class="ticket-div"></div>
    ${itemsHtml}
    <div class="ticket-div"></div>
    <div class="ticket-row total"><span>TOTAL</span><span>${fmt(t.total)}</span></div>
    <div class="ticket-div"></div>
    <div class="ticket-center">Â¡Gracias por su visita!</div>
    <div class="ticket-center">Vuelva pronto ğŸ½</div>
    <hr class="ticket-corte"/>
  </div>`;

  window.print();
}

// â”€â”€ PRODUCTOS ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProductosAdmin(){
  if(sesion?.role==='cocinero') return;
  html('productos-admin-list',state.productos.length
    ? state.productos.map(p=>`
        <div class="prod-card">
          <div>
            <div class="pname">${p.nombre}</div>
            <div class="pprice">${fmt(p.precio)}</div>
            <span class="pcat ${p.cat||'comida'}">${CAT_LABELS[p.cat||'comida']||p.cat}</span>
          </div>
          <div class="prod-card-actions">
            ${sesion?.role==='admin'?`
              <button class="icon-btn" onclick="abrirEditProd(${p.id})">âœï¸</button>
              <button class="icon-btn" onclick="eliminarProd(${p.id})">ğŸ—‘ï¸</button>`:''}
          </div>
        </div>`).join('')
    : '<div style="color:var(--text3)">Sin productos.</div>');
}

window.agregarProducto = async function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin puede aÃ±adir productos.'); return; }
  const nombre=$('prod-nombre').value.trim();
  const precio=parseInt($('prod-precio').value);
  const cat   =$('prod-cat').value;
  if(!nombre){ toast('Ingresa el nombre.'); return; }
  if(isNaN(precio)||precio<0){ toast('Precio invÃ¡lido.'); return; }
  const id=state.productos.length?Math.max(...state.productos.map(p=>p.id))+1:1;
  state.productos.push({id,nombre,precio,cat});
  await saveProductos();
  $('prod-nombre').value=''; $('prod-precio').value='';
  await registrarActividad('accion-producto',`AÃ±adiÃ³ "${nombre}" (${CAT_LABELS[cat]}) â€” ${fmt(precio)}`);
  toast(`"${nombre}" aÃ±adido.`);
};

window.eliminarProd = async function(id){
  if(sesion?.role!=='admin'){ toast('Solo el Admin.'); return; }
  if(!confirm('Â¿Eliminar este producto?')) return;
  const p=state.productos.find(p=>p.id===id);
  state.productos=state.productos.filter(p=>p.id!==id);
  await saveProductos();
  await registrarActividad('accion-producto',`EliminÃ³ producto "${p?.nombre}"`);
  toast('Producto eliminado.');
};

window.abrirEditProd = function(id){
  const p=state.productos.find(p=>p.id===id); if(!p) return;
  $('edit-prod-id').value=id; $('edit-prod-nombre').value=p.nombre;
  $('edit-prod-precio').value=p.precio; $('edit-prod-cat').value=p.cat||'comida';
  $('modal-edit-prod').classList.add('open');
};

window.guardarEditProd = async function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin.'); return; }
  const id=parseInt($('edit-prod-id').value);
  const nombre=$('edit-prod-nombre').value.trim();
  const precio=parseInt($('edit-prod-precio').value);
  const cat   =$('edit-prod-cat').value;
  if(!nombre||isNaN(precio)){ toast('Completa los campos.'); return; }
  const p=state.productos.find(p=>p.id===id);
  if(p){ p.nombre=nombre; p.precio=precio; p.cat=cat; }
  await saveProductos();
  cerrarEditProd();
  await registrarActividad('accion-producto',`EditÃ³ "${nombre}" â†’ ${fmt(precio)} (${CAT_LABELS[cat]})`);
  toast('Producto actualizado.');
};
window.cerrarEditProd = ()=>$('modal-edit-prod').classList.remove('open');

// â”€â”€ USUARIOS ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleAddUser = function(){
  const w=$('add-user-wrap-panel'); w.classList.toggle('hidden');
  if(!w.classList.contains('hidden')){ $('nu-nombre').focus(); ['nu-nombre','nu-user','nu-pass','nu-pass2'].forEach(i=>$(i).value=''); }
};

window.crearUsuario = async function(){
  const nombre=$('nu-nombre').value.trim();
  const username=$('nu-user').value.trim().toUpperCase();
  const pass=$('nu-pass').value, pass2=$('nu-pass2').value;
  const role=$('nu-role').value; // 'mesero' o 'cocinero'
  if(!nombre||!username||!pass){ toast('Completa todos los campos.'); return; }
  if(pass!==pass2){ toast('Las contraseÃ±as no coinciden.'); return; }
  if(username==='ADMIN'){ toast('Nombre reservado.'); return; }
  if(state.usuarios.find(u=>u.username.toUpperCase()===username)){ toast('Usuario ya existe.'); return; }
  const nu={id:'u_'+Date.now(),nombre,username,password:pass,role,creadoPor:sesion?.username||'admin',creadoEn:fechaHora()};
  state.usuarios.push(nu);
  await saveUsuarios();
  toggleAddUser();
  const roleLbl = role==='cocinero'?'Cocinero/a':'Mesero';
  await registrarActividad('accion-admin',`CreÃ³ usuario ${roleLbl}: "${nombre}" (${username})`);
  toast(`âœ… Usuario "${nombre}" (${roleLbl}) creado.`);
};

window.eliminarUsuario = async function(id){
  const u=state.usuarios.find(u=>u.id===id); if(!u) return;
  if(!confirm(`Â¿Eliminar a "${u.nombre}"?`)) return;
  state.usuarios=state.usuarios.filter(u=>u.id!==id);
  await saveUsuarios();
  await registrarActividad('accion-admin',`EliminÃ³ usuario "${u.nombre}"`);
  toast('Usuario eliminado.');
};

window.abrirCambiarPass = function(id){
  const u=state.usuarios.find(u=>u.id===id); if(!u) return;
  $('cp-user-id').value=id; $('cp-user-name').textContent=`ğŸ‘¤ ${u.nombre} (${u.username})`;
  $('cp-pass').value=''; $('cp-pass2').value='';
  $('modal-cambiar-pass').classList.add('open');
};

window.guardarNuevaPass = async function(){
  const id=$('cp-user-id').value, pass=$('cp-pass').value, pass2=$('cp-pass2').value;
  if(!pass){ toast('Ingresa la contraseÃ±a.'); return; }
  if(pass!==pass2){ toast('No coinciden.'); return; }
  const u=state.usuarios.find(u=>u.id===id); if(u) u.password=pass;
  await saveUsuarios();
  $('modal-cambiar-pass').classList.remove('open');
  await registrarActividad('accion-admin',`CambiÃ³ contraseÃ±a de "${u?.nombre}"`);
  toast('ContraseÃ±a actualizada.');
};

function renderUsersList(){
  const list=$('users-list'); if(!list) return;
  let h=`<div class="user-item">
    <div class="user-info"><div class="uname">ğŸ‘‘ Administrador</div><div class="ufull">ADMIN Â· <span style="color:var(--accent);font-weight:600">Admin Principal</span></div></div>
    <span class="role-badge admin">Admin</span>
  </div>`;
  if(!state.usuarios.length) h+='<div style="color:var(--text3);font-size:.82rem;text-align:center;padding:12px;">Sin usuarios creados.</div>';
  else h+=state.usuarios.map(u=>{
    const isCocinero=u.role==='cocinero';
    const badgeClass=isCocinero?'cocinero':'mesero';
    const badgeLabel=isCocinero?'Cocinero/a':'Mesero';
    const icon=isCocinero?'ğŸ‘¨â€ğŸ³':'ğŸ‘¤';
    return `<div class="user-item">
      <div class="user-info"><div class="uname">${icon} ${u.nombre}</div><div class="ufull">${u.username} Â· ${u.creadoEn||'â€”'}</div></div>
      <div class="user-item-actions">
        <span class="role-badge ${badgeClass}">${badgeLabel}</span>
        <button class="icon-btn" onclick="abrirCambiarPass('${u.id}')">ğŸ”‘</button>
        <button class="icon-btn" onclick="eliminarUsuario('${u.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
  list.innerHTML=h;
}

// â”€â”€ ACTIVIDAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registrarActividad(tipo,msg){
  if(!sesion) return;
  const e={tipo,msg,usuario:sesion.nombre||sesion.username,role:sesion.role,fechaHora:fechaHora(),ts:Date.now()};
  state.actividad.unshift(e);
  if(state.actividad.length>200) state.actividad=state.actividad.slice(0,200);
  await set(ref(db,'actividad'),state.actividad);
}
function renderActividad(){
  const list=$('activity-list'); if(!list) return;
  if(!state.actividad.length){ list.innerHTML='<div class="empty-state"><div class="icon">ğŸ“</div><p>Sin actividad.</p></div>'; return; }
  list.innerHTML=state.actividad.slice(0,80).map(a=>{
    const roleLabel={admin:'ğŸ‘‘ Admin',mesero:'ğŸ‘¤ Mesero',cocinero:'ğŸ‘¨â€ğŸ³ Cocinero/a'}[a.role]||a.role;
    return `<div class="activity-item">
      <div class="activity-dot ${a.tipo}"></div>
      <div class="activity-content">
        <div class="activity-msg"><span class="activity-user">${a.usuario}</span> â€” ${a.msg}</div>
        <div class="activity-meta">${a.fechaHora} Â· ${roleLabel}</div>
      </div>
    </div>`;
  }).join('');
}
window.limpiarActividad = async function(){
  if(!confirm('Â¿Limpiar el registro de actividad?')) return;
  state.actividad=[]; await set(ref(db,'actividad'),[]); toast('Actividad limpiada.');
};

// â”€â”€ HISTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistorial(){
  if(sesion?.role==='cocinero') return;
  const h=state.historial||[];
  let total=0; const mesasSet=new Set(); const byMesa={};
  h.forEach(r=>{ if(!byMesa[r.mesa]) byMesa[r.mesa]=[]; byMesa[r.mesa].push(r); total+=r.total; mesasSet.add(r.mesa); });
  const sc=$('stat-clientes'),sm=$('stat-mesas-h'),st=$('stat-total');
  if(sc) sc.textContent=h.length; if(sm) sm.textContent=mesasSet.size; if(st) st.textContent=fmt(total);
  if(!h.length){ html('historial-container','<div class="empty-state"><div class="icon">ğŸ“‹</div><p>Sin ventas esta noche.</p></div>'); return; }
  let t='<table class="history-table"><thead><tr><th>Mesa</th><th>Cliente</th><th>Hora</th><th>Productos</th><th>Mesero</th><th>Usuario</th><th>Total</th></tr></thead><tbody>';
  Object.keys(byMesa).sort((a,b)=>+a-+b).forEach(mesa=>{
    let tm=0; byMesa[mesa].forEach(r=>{ tm+=r.total;
      t+=`<tr><td><strong>Mesa ${mesa}</strong></td><td>${r.clienteNum}Â°</td><td>${r.hora}</td>
        <td>${r.detalles.map(d=>`${d.qty}Ã— ${d.nombre}`).join(', ')}</td>
        <td>${r.mesero||'â€”'}</td><td style="color:var(--blue);font-weight:500">${r.usuario||'â€”'}</td>
        <td>${fmt(r.total)}</td></tr>`;
    });
    t+=`<tr class="total-row"><td colspan="6">Subtotal Mesa ${mesa}</td><td>${fmt(tm)}</td></tr>`;
  });
  t+=`<tr class="total-row" style="background:rgba(192,57,43,.04)"><td colspan="6">ğŸ’° INGRESO TOTAL</td><td style="color:var(--accent);font-size:.95rem">${fmt(total)}</td></tr></tbody></table>`;
  html('historial-container',t);
}

window.limpiarHistorial = async function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin.'); return; }
  if(!confirm('Â¿Limpiar todo el historial de la noche?')) return;
  state.historial=[];
  await set(ref(db,'historial'),[]);
  for(let i=1;i<=TOTAL_MESAS;i++){ state.mesas[i].clientesNoche=[]; await saveMesa(i); }
  await registrarActividad('accion-admin','LimpiÃ³ el historial de ventas de la noche');
  toast('Historial limpiado.');
};

// â”€â”€ CIERRE DE CAJA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.cierreCaja = function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin puede hacer cierre de caja.'); return; }
  const h=state.historial||[];
  if(!h.length){ toast('No hay ventas registradas hoy.'); return; }
  registrarActividad('accion-admin','EjecutÃ³ Cierre de Caja â€” descargÃ³ XLSX del dÃ­a');
  cargarYExportar(h, true);
};

window.exportCSV = function(){
  const h=state.historial||[];
  if(!h.length){ toast('No hay ventas para exportar.'); return; }
  cargarYExportar(h, false);
};

function cargarYExportar(hist, esCierre){
  const script=document.createElement('script');
  script.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  script.onload=()=>generarXLSX(hist, esCierre);
  script.onerror=()=>toast('âš ï¸ Error cargando librerÃ­a XLSX.');
  document.head.appendChild(script);
}

function generarXLSX(hist, esCierre){
  const XLSX=window.XLSX;
  const wb=XLSX.utils.book_new();
  const fecha=new Date().toLocaleDateString('es-PY',{timeZone:TZ});
  const C={
    rojo:'C0392B',rojoMedio:'E74C3C',rojoClaro:'FADBD8',
    grisOscuro:'2C2C2C',grisClaro:'F2EDE8',blanco:'FFFFFF',
    naranja:'E67E22',naranjaClr:'FEF0E7',
    verde:'1E8449',verdeClr:'D5F5E3',
    azul:'2980B9',azulClr:'D6EAF8',
    morado:'8E44AD',moradoClr:'F5EEF8',
  };
  const st=(bg,fg='000000',bold=false,sz=10,border=false,align='left',numFmt='')=>({
    fill:{fgColor:{rgb:bg}},font:{color:{rgb:fg},bold,sz,name:'Arial'},
    alignment:{horizontal:align,vertical:'center',wrapText:true},
    border:border?{top:{style:'thin',color:{rgb:'CCCCCC'}},bottom:{style:'thin',color:{rgb:'CCCCCC'}},left:{style:'thin',color:{rgb:'CCCCCC'}},right:{style:'thin',color:{rgb:'CCCCCC'}}}:{},
    numFmt
  });
  const sc=(r,c)=>XLSX.utils.encode_cell({r,c});

  const byMesa={};let totalGlobal=0;
  hist.forEach(r=>{ if(!byMesa[r.mesa]) byMesa[r.mesa]=[]; byMesa[r.mesa].push(r); totalGlobal+=r.total; });

  const ws1d=[];
  ws1d.push(['ğŸ½ RESTAURANTE DELICIAS â€” HISTORIAL DE VENTAS','','','','','','','','','']);
  ws1d.push([`Fecha: ${fecha}   |   ${esCierre?'CIERRE DE CAJA':'ExportaciÃ³n parcial'}   |   Total: ${fmt(totalGlobal)}`,'','','','','','','','','']);
  ws1d.push(['']);
  ws1d.push(['Mesa','Cliente','Hora','CategorÃ­a','Producto','Cant.','Precio Unit.','Subtotal','Mesero','Usuario']);

  const mesaKeys=Object.keys(byMesa).sort((a,b)=>+a-+b);
  let altRow=false;
  mesaKeys.forEach(mesa=>{
    byMesa[mesa].forEach(r=>{
      r.detalles.forEach(d=>{
        ws1d.push([`Mesa ${mesa}`,`${r.clienteNum}Â°`,r.hora,CAT_LABELS[d.cat||'comida']||d.cat||'',
          d.nombre,d.qty,Math.round(d.precio),Math.round(d.sub),r.mesero||'â€”',r.usuario||'â€”']);
      });
      altRow=!altRow;
    });
    const totM=byMesa[mesa].reduce((s,r)=>s+r.total,0);
    ws1d.push([`SUBTOTAL MESA ${mesa}`,'','','','','','',Math.round(totM),'','']);
    ws1d.push(['']);
  });
  ws1d.push(['']);
  ws1d.push(['ğŸ’° INGRESO TOTAL DE LA NOCHE','','','','','','',Math.round(totalGlobal),'','']);

  const ws1=XLSX.utils.aoa_to_sheet(ws1d);
  ws1['!cols']=[{wch:13},{wch:9},{wch:7},{wch:11},{wch:20},{wch:7},{wch:16},{wch:15},{wch:16},{wch:14}];
  const ms1=[{s:{r:0,c:0},e:{r:0,c:9}},{s:{r:1,c:0},e:{r:1,c:9}}];

  let ri=4;
  mesaKeys.forEach(mesa=>{
    const lineas=byMesa[mesa].reduce((s,r)=>s+r.detalles.length,0);
    ri+=lineas;
    ms1.push({s:{r:ri,c:0},e:{r:ri,c:6}});
    ri+=2;
  });
  const lastR=ws1d.length-1;
  ms1.push({s:{r:lastR,c:0},e:{r:lastR,c:6}});
  ws1['!merges']=ms1;

  ws1[sc(0,0)]={v:ws1d[0][0],t:'s',s:st(C.rojo,C.blanco,true,14,false,'center')};
  ws1[sc(1,0)]={v:ws1d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Mesa','Cliente','Hora','CategorÃ­a','Producto','Cant.','Precio Unit.','Subtotal','Mesero','Usuario'].forEach((h2,ci)=>{
    ws1[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')};
  });

  let ri2=4; let alt=false;
  mesaKeys.forEach(mesa=>{
    byMesa[mesa].forEach(r=>{
      r.detalles.forEach(d=>{
        const catC={comida:C.grisClaro,bebida:C.azulClr,postre:C.moradoClr}[d.cat||'comida']||C.blanco;
        const bg=alt?catC:C.blanco;
        const row=ws1d[ri2];
        row.forEach((v,ci)=>{
          const isN=ci===5||ci===6||ci===7;
          ws1[sc(ri2,ci)]={v:isN?Number(v):v,t:isN?'n':'s',s:st(bg,'000000',false,10,true,isN?'right':'left',isN?'#,##0':'')};
        });
        ri2++;
      });
      alt=!alt;
    });
    const stRow=ws1d[ri2];
    ws1[sc(ri2,0)]={v:stRow[0],t:'s',s:st(C.naranjaClr,C.naranja,true,10,true,'left')};
    for(let ci=1;ci<=6;ci++) ws1[sc(ri2,ci)]={v:'',t:'s',s:st(C.naranjaClr,C.naranja,true,10,true)};
    ws1[sc(ri2,7)]={v:Number(stRow[7]),t:'n',s:st(C.naranjaClr,C.naranja,true,10,true,'right','#,##0')};
    ws1[sc(ri2,8)]={v:'',t:'s',s:st(C.naranjaClr,C.naranja,true,10,true)};
    ws1[sc(ri2,9)]={v:'',t:'s',s:st(C.naranjaClr,C.naranja,true,10,true)};
    ri2+=2;
  });
  ws1[sc(lastR,0)]={v:'ğŸ’° INGRESO TOTAL DE LA NOCHE',t:'s',s:st(C.verde,C.blanco,true,12,true,'left')};
  for(let ci=1;ci<=6;ci++) ws1[sc(lastR,ci)]={v:'',t:'s',s:st(C.verde,C.blanco,true,12,true)};
  ws1[sc(lastR,7)]={v:Math.round(totalGlobal),t:'n',s:st(C.verde,C.blanco,true,12,true,'right','#,##0')};
  ws1[sc(lastR,8)]={v:'',t:'s',s:st(C.verde,C.blanco,true,12,true)};
  ws1[sc(lastR,9)]={v:'',t:'s',s:st(C.verde,C.blanco,true,12,true)};
  ws1['!rows']=[]; ws1['!rows'][0]={hpt:26}; ws1['!rows'][1]={hpt:15}; ws1['!rows'][3]={hpt:18};
  XLSX.utils.book_append_sheet(wb,ws1,'Detalle de Ventas');

  // Hoja 2: Resumen por Mesa
  const ws2d=[
    ['ğŸ½ RESTAURANTE DELICIAS â€” RESUMEN POR MESA','','','',''],
    [`Fecha: ${fecha}`,'','','',''],[''],
    ['Mesa','Clientes','Bebidas (Gs.)','Comidas (Gs.)','Postres (Gs.)','Total (Gs.)','% del Total']
  ];
  mesaKeys.forEach(mesa=>{
    const rs=byMesa[mesa]; const cl=rs.length;
    const tot=rs.reduce((s,r)=>s+r.total,0);
    const beb=rs.reduce((s,r)=>s+r.detalles.filter(d=>(d.cat||'comida')==='bebida').reduce((a,d)=>a+d.sub,0),0);
    const com=rs.reduce((s,r)=>s+r.detalles.filter(d=>(d.cat||'comida')==='comida').reduce((a,d)=>a+d.sub,0),0);
    const pos=rs.reduce((s,r)=>s+r.detalles.filter(d=>(d.cat||'comida')==='postre').reduce((a,d)=>a+d.sub,0),0);
    ws2d.push([`Mesa ${mesa}`,cl,Math.round(beb),Math.round(com),Math.round(pos),Math.round(tot),totalGlobal>0?tot/totalGlobal:0]);
  });
  ws2d.push(['']);
  ws2d.push(['TOTAL',hist.length,
    Math.round(mesaKeys.reduce((s,m)=>s+byMesa[m].reduce((a,r)=>a+r.detalles.filter(d=>(d.cat||'comida')==='bebida').reduce((x,d)=>x+d.sub,0),0),0)),
    Math.round(mesaKeys.reduce((s,m)=>s+byMesa[m].reduce((a,r)=>a+r.detalles.filter(d=>(d.cat||'comida')==='comida').reduce((x,d)=>x+d.sub,0),0),0)),
    Math.round(mesaKeys.reduce((s,m)=>s+byMesa[m].reduce((a,r)=>a+r.detalles.filter(d=>(d.cat||'comida')==='postre').reduce((x,d)=>x+d.sub,0),0),0)),
    Math.round(totalGlobal),1
  ]);
  const ws2=XLSX.utils.aoa_to_sheet(ws2d);
  ws2['!cols']=[{wch:12},{wch:10},{wch:16},{wch:16},{wch:16},{wch:16},{wch:12}];
  ws2['!merges']=[{s:{r:0,c:0},e:{r:0,c:6}},{s:{r:1,c:0},e:{r:1,c:6}}];
  ws2[sc(0,0)]={v:ws2d[0][0],t:'s',s:st(C.rojo,C.blanco,true,13,false,'center')};
  ws2[sc(1,0)]={v:ws2d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Mesa','Clientes','Bebidas (Gs.)','Comidas (Gs.)','Postres (Gs.)','Total (Gs.)','% del Total'].forEach((h2,ci)=>{
    ws2[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')};
  });
  mesaKeys.forEach((mesa,idx)=>{
    const ri3=4+idx; const bg=idx%2===0?C.azulClr:C.blanco; const row=ws2d[ri3];
    ws2[sc(ri3,0)]={v:row[0],t:'s',s:st(bg,'000000',false,10,true,'left')};
    ws2[sc(ri3,1)]={v:Number(row[1]),t:'n',s:st(bg,'000000',false,10,true,'center')};
    [2,3,4,5].forEach(ci=>ws2[sc(ri3,ci)]={v:Number(row[ci]),t:'n',s:st(bg,'000000',false,10,true,'right','#,##0')});
    ws2[sc(ri3,6)]={v:Number(row[6]),t:'n',s:st(bg,'000000',false,10,true,'center','0.0%')};
  });
  const totRi=4+mesaKeys.length+1;
  ws2[sc(totRi,0)]={v:'TOTAL',t:'s',s:st(C.verde,C.blanco,true,11,true,'left')};
  ws2[sc(totRi,1)]={v:hist.length,t:'n',s:st(C.verde,C.blanco,true,11,true,'center')};
  [2,3,4,5].forEach(ci=>ws2[sc(totRi,ci)]={v:Number(ws2d[totRi][ci]),t:'n',s:st(C.verde,C.blanco,true,11,true,'right','#,##0')});
  ws2[sc(totRi,6)]={v:1,t:'n',s:st(C.verde,C.blanco,true,11,true,'center','0.0%')};
  ws2['!rows']=[]; ws2['!rows'][0]={hpt:24}; ws2['!rows'][3]={hpt:17};
  XLSX.utils.book_append_sheet(wb,ws2,'Resumen por Mesa');

  // Hoja 3: Por CategorÃ­a
  const catTotals={bebida:0,comida:0,postre:0};
  hist.forEach(r=>r.detalles.forEach(d=>{ catTotals[d.cat||'comida']=(catTotals[d.cat||'comida']||0)+d.sub; }));
  const ws3d=[
    ['ğŸ½ RESTAURANTE DELICIAS â€” VENTAS POR CATEGORÃA','',''],
    [`Fecha: ${fecha}`,'',''],[''],
    ['CategorÃ­a','Total Vendido (Gs.)','% del Total'],
    ['ğŸ¥¤ Bebidas',Math.round(catTotals.bebida),totalGlobal>0?catTotals.bebida/totalGlobal:0],
    ['ğŸ• Comidas',Math.round(catTotals.comida),totalGlobal>0?catTotals.comida/totalGlobal:0],
    ['ğŸ¨ Postres',Math.round(catTotals.postre),totalGlobal>0?catTotals.postre/totalGlobal:0],
    [''],['TOTAL',Math.round(totalGlobal),1]
  ];
  const ws3=XLSX.utils.aoa_to_sheet(ws3d);
  ws3['!cols']=[{wch:16},{wch:20},{wch:14}];
  ws3['!merges']=[{s:{r:0,c:0},e:{r:0,c:2}},{s:{r:1,c:0},e:{r:1,c:2}}];
  ws3[sc(0,0)]={v:ws3d[0][0],t:'s',s:st(C.rojo,C.blanco,true,13,false,'center')};
  ws3[sc(1,0)]={v:ws3d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['CategorÃ­a','Total Vendido (Gs.)','% del Total'].forEach((h2,ci)=>{ ws3[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')}; });
  const catColors={4:C.azulClr,5:C.grisClaro,6:C.moradoClr};
  [4,5,6].forEach(ri=>{
    const row=ws3d[ri]; const bg=catColors[ri];
    ws3[sc(ri,0)]={v:row[0],t:'s',s:st(bg,'000000',false,11,true,'left')};
    ws3[sc(ri,1)]={v:Number(row[1]),t:'n',s:st(bg,'000000',true,11,true,'right','#,##0')};
    ws3[sc(ri,2)]={v:Number(row[2]),t:'n',s:st(bg,'000000',false,11,true,'center','0.0%')};
  });
  ws3[sc(8,0)]={v:'TOTAL',t:'s',s:st(C.verde,C.blanco,true,12,true,'left')};
  ws3[sc(8,1)]={v:Math.round(totalGlobal),t:'n',s:st(C.verde,C.blanco,true,12,true,'right','#,##0')};
  ws3[sc(8,2)]={v:1,t:'n',s:st(C.verde,C.blanco,true,12,true,'center','0.0%')};
  ws3['!rows']=[]; ws3['!rows'][0]={hpt:24}; ws3['!rows'][3]={hpt:18};
  XLSX.utils.book_append_sheet(wb,ws3,'Ventas por CategorÃ­a');

  // Hoja 4: Actividad
  const ws4d=[['ğŸ½ RESTAURANTE DELICIAS â€” ACTIVIDAD DE USUARIOS','','',''],
    [`Fecha: ${fecha}`,'','',''],[''],['Fecha/Hora','Usuario','Rol','AcciÃ³n']];
  (state.actividad||[]).slice(0,500).forEach(a=>{
    const roleLbl={admin:'Admin',mesero:'Mesero',cocinero:'Cocinero/a'}[a.role]||a.role;
    ws4d.push([a.fechaHora||'â€”',a.usuario||'â€”',roleLbl,a.msg||'â€”']);
  });
  const ws4=XLSX.utils.aoa_to_sheet(ws4d);
  ws4['!cols']=[{wch:17},{wch:18},{wch:12},{wch:52}];
  ws4['!merges']=[{s:{r:0,c:0},e:{r:0,c:3}},{s:{r:1,c:0},e:{r:1,c:3}}];
  ws4[sc(0,0)]={v:ws4d[0][0],t:'s',s:st(C.rojo,C.blanco,true,13,false,'center')};
  ws4[sc(1,0)]={v:ws4d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Fecha/Hora','Usuario','Rol','AcciÃ³n'].forEach((h2,ci)=>{ ws4[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')}; });
  (state.actividad||[]).slice(0,500).forEach((a,idx)=>{
    const ri=4+idx; const bg=idx%2===0?C.grisClaro:C.blanco;
    const roleLbl={admin:'Admin',mesero:'Mesero',cocinero:'Cocinero/a'}[a.role]||a.role;
    [a.fechaHora,a.usuario,roleLbl,a.msg].forEach((v,ci)=>{
      ws4[sc(ri,ci)]={v:v||'',t:'s',s:st(bg,ci===2&&a.role==='admin'?C.rojo:'000000',ci===2&&a.role==='admin',9,true,'left')};
    });
  });
  ws4['!rows']=[]; ws4['!rows'][0]={hpt:24}; ws4['!rows'][3]={hpt:17};
  XLSX.utils.book_append_sheet(wb,ws4,'Actividad de Usuarios');

  const fechaArch=new Date().toISOString().slice(0,10);
  const nombre=esCierre?`Cierre_Caja_Delicias_${fechaArch}.xlsx`:`Restaurante_Delicias_${fechaArch}.xlsx`;
  XLSX.writeFile(wb,nombre);
  toast(`ğŸ“Š ${esCierre?'Cierre de Caja':'Excel'} descargado âœ…`);
  if(sesion) registrarActividad('accion-admin',`DescargÃ³ ${esCierre?'Cierre de Caja':'XLSX'}: ${nombre}`);
}

// â”€â”€ CERRAR MODALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('modal-mesa').addEventListener('click',function(e){if(e.target===this)window.cerrarModal();});
$('modal-edit-prod').addEventListener('click',function(e){if(e.target===this)window.cerrarEditProd();});
$('modal-hist-mesa').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
$('modal-hist-cocina').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
$('modal-cambiar-pass').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});

boot();
</script>
</body>
</html>
