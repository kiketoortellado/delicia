<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Delicias â€” Administrador de Mesas</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#f5f2ee;--surface:#fff;--surface2:#faf8f5;--border:#e8e2da;
  --accent:#c0392b;--accent2:#e74c3c;--text:#1a1612;--text2:#5a5248;--text3:#9a928a;
  --green:#27ae60;--orange:#e67e22;--red:#c0392b;--blue:#2980b9;--purple:#8e44ad;
  --shadow:0 2px 16px rgba(0,0,0,.08);--shadow-lg:0 8px 32px rgba(0,0,0,.12);
  --radius:12px;--radius-sm:8px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* LOADING */
#loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:9999;gap:16px;}
.spinner{width:44px;height:44px;border:4px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-size:.9rem;color:var(--text3);}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;
  justify-content:center;z-index:999;
  background-image:radial-gradient(ellipse at 20% 50%,rgba(192,57,43,.06) 0%,transparent 60%),
                   radial-gradient(ellipse at 80% 20%,rgba(184,134,11,.06) 0%,transparent 60%);}
#login-screen.show{display:flex;}
.login-card{background:var(--surface);border-radius:20px;padding:52px 48px;
  box-shadow:var(--shadow-lg);width:100%;max-width:420px;text-align:center;border:1px solid var(--border);}
.login-logo{font-family:'Playfair Display',serif;font-size:2.4rem;color:var(--accent);margin-bottom:4px;}
.login-sub{color:var(--text3);font-size:.85rem;letter-spacing:.12em;text-transform:uppercase;margin-bottom:36px;}
.login-field{text-align:left;margin-bottom:18px;}
.login-field label{display:block;font-size:.78rem;font-weight:600;color:var(--text2);
  letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px;}
.login-field input{width:100%;padding:12px 16px;border:1.5px solid var(--border);
  border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.95rem;
  background:var(--surface2);color:var(--text);transition:border-color .2s;}
.login-field input:focus{outline:none;border-color:var(--accent);}
.login-btn{width:100%;padding:14px;background:var(--accent);color:#fff;border:none;
  border-radius:var(--radius-sm);font-size:1rem;font-weight:600;cursor:pointer;
  font-family:'DM Sans',sans-serif;transition:background .2s,transform .1s;margin-top:8px;}
.login-btn:hover{background:var(--accent2);}
.login-btn:active{transform:scale(.98);}
.login-err{color:var(--red);font-size:.85rem;margin-top:12px;min-height:20px;}

/* SYNC */
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--green);
  display:inline-block;margin-right:5px;animation:pulse 2s infinite;}
.sync-dot.offline{background:var(--red);animation:none;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* HEADER */
header{background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.header-brand h1{font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--accent);}
.header-brand span{color:var(--text3);font-size:.78rem;letter-spacing:.1em;text-transform:uppercase;}
.header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);
  border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-size:.82rem;}
.user-pill .role-badge{font-size:.68rem;font-weight:700;padding:2px 7px;border-radius:10px;
  text-transform:uppercase;letter-spacing:.05em;}
.role-badge.admin{background:rgba(192,57,43,.12);color:var(--accent);}
.role-badge.mesero{background:rgba(41,128,185,.12);color:var(--blue);}
.btn-ghost{padding:7px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:transparent;font-family:'DM Sans',sans-serif;font-size:.83rem;font-weight:500;
  color:var(--text2);cursor:pointer;transition:all .2s;}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:rgba(192,57,43,.04);}
.btn-primary{padding:8px 18px;border:none;border-radius:var(--radius-sm);background:var(--accent);
  color:#fff;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:background .2s;}
.btn-primary:hover{background:var(--accent2);}

/* TABS */
.tabs{display:flex;gap:2px;background:var(--surface);padding:14px 24px 0;border-bottom:1px solid var(--border);overflow-x:auto;}
.tab{padding:10px 18px;border:none;background:transparent;font-family:'DM Sans',sans-serif;
  font-size:.86rem;font-weight:500;color:var(--text3);cursor:pointer;white-space:nowrap;
  border-bottom:2.5px solid transparent;transition:all .2s;border-radius:6px 6px 0 0;}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600;}
.tab.admin-only{color:var(--purple);}
.tab.admin-only.active{color:var(--purple);border-bottom-color:var(--purple);}

/* MAIN */
.main{padding:24px;max-width:1400px;margin:0 auto;}
.section-title{font-family:'Playfair Display',serif;font-size:1.25rem;color:var(--text);
  margin-bottom:20px;display:flex;align-items:center;gap:10px;}
.badge{font-family:'DM Sans',sans-serif;font-size:.73rem;font-weight:600;
  padding:3px 10px;border-radius:20px;background:rgba(192,57,43,.1);color:var(--accent);}

/* MESAS */
.mesas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;}
.mesa-card{background:var(--surface);border-radius:var(--radius);border:1.5px solid var(--border);
  padding:18px 16px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden;}
.mesa-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--green);}
.mesa-card.ocupada::before{background:var(--accent);}
.mesa-card.ocupada{border-color:rgba(192,57,43,.3);background:rgba(192,57,43,.02);}
.mesa-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px);}
.mesa-num{font-family:'Playfair Display',serif;font-size:2.1rem;color:var(--text);font-weight:700;}
.mesa-label{font-size:.68rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin-bottom:10px;}
.mesa-status{display:inline-flex;align-items:center;gap:5px;font-size:.73rem;font-weight:600;
  padding:3px 9px;border-radius:20px;text-transform:uppercase;}
.mesa-status.libre{background:rgba(39,174,96,.1);color:var(--green);}
.mesa-status.ocupada{background:rgba(192,57,43,.1);color:var(--accent);}
.mesa-status::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.mesa-mesero{font-size:.76rem;color:var(--text3);margin-top:6px;}
.mesa-total{font-size:.95rem;font-weight:600;color:var(--text2);margin-top:3px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(26,22,18,.55);z-index:200;
  display:none;align-items:flex-start;justify-content:center;padding:16px;overflow-y:auto;backdrop-filter:blur(3px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:16px;width:100%;max-width:720px;
  box-shadow:var(--shadow-lg);animation:slideUp .25s ease;margin:auto;}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-header{padding:22px 26px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.35rem;}
.modal-close{width:34px;height:34px;border:none;background:var(--surface2);border-radius:8px;
  cursor:pointer;font-size:1rem;color:var(--text2);transition:background .2s;}
.modal-close:hover{background:var(--border);}
.modal-body{padding:22px 26px;}

/* FORM */
.field{margin-bottom:14px;}
.field label{display:block;font-size:.76rem;font-weight:600;color:var(--text2);
  letter-spacing:.05em;text-transform:uppercase;margin-bottom:5px;}
.field input,.field select{width:100%;padding:10px 13px;border:1.5px solid var(--border);
  border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.92rem;
  background:var(--surface2);color:var(--text);transition:border-color .2s;}
.field input:focus,.field select:focus{outline:none;border-color:var(--accent);}

/* PEDIDO */
.pedido-layout{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
@media(max-width:580px){.pedido-layout{grid-template-columns:1fr;}}
.productos-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;max-height:300px;overflow-y:auto;}
.producto-btn{padding:9px 7px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--surface2);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.8rem;
  font-weight:500;color:var(--text2);transition:all .18s;text-align:left;}
.producto-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(192,57,43,.04);}
.producto-btn .prod-name{font-weight:600;color:var(--text);display:block;}
.producto-btn .prod-price{color:var(--text3);font-size:.75rem;}
.orden-panel{background:var(--surface2);border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border);}
.orden-panel h4{font-size:.76rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:10px;}
.orden-items{min-height:70px;max-height:220px;overflow-y:auto;}
.orden-item{display:flex;align-items:center;justify-content:space-between;padding:7px 0;
  border-bottom:1px solid var(--border);font-size:.86rem;}
.orden-item:last-child{border-bottom:none;}
.orden-item-name{flex:1;color:var(--text);font-weight:500;}
.orden-item-qty{display:flex;align-items:center;gap:5px;}
.qty-btn{width:22px;height:22px;border:1.5px solid var(--border);border-radius:5px;background:#fff;
  cursor:pointer;font-size:.85rem;font-weight:700;color:var(--text2);transition:all .15s;}
.qty-btn:hover{border-color:var(--accent);color:var(--accent);}
.qty-num{font-weight:700;width:18px;text-align:center;}
.orden-item-price{font-weight:600;min-width:86px;text-align:right;font-size:.83rem;}
.orden-total{border-top:2px solid var(--border);margin-top:10px;padding-top:10px;
  display:flex;justify-content:space-between;align-items:center;}
.total-amount{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--accent);}

/* CLIENTES */
.clientes-list{margin-top:8px;}
.cliente-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:12px 14px;margin-bottom:8px;}
.cliente-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.cliente-num{font-family:'Playfair Display',serif;font-size:.95rem;color:var(--accent);font-weight:700;}
.cliente-items-list{font-size:.8rem;color:var(--text3);}
.mesero-badge{display:inline-flex;align-items:center;gap:5px;font-size:.76rem;color:var(--text3);
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 9px;margin-top:5px;}

/* ACCIONES */
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:18px;padding-top:18px;border-top:1px solid var(--border);}
.btn-success{background:var(--green);color:#fff;border:none;padding:9px 18px;border-radius:var(--radius-sm);
  font-family:'DM Sans',sans-serif;font-weight:600;font-size:.86rem;cursor:pointer;transition:opacity .2s;}
.btn-success:hover{opacity:.85;}
.btn-danger{background:var(--accent);color:#fff;border:none;padding:9px 18px;border-radius:var(--radius-sm);
  font-family:'DM Sans',sans-serif;font-weight:600;font-size:.86rem;cursor:pointer;transition:opacity .2s;}
.btn-danger:hover{opacity:.85;}
.btn-warning{background:var(--orange);color:#fff;border:none;padding:9px 18px;border-radius:var(--radius-sm);
  font-family:'DM Sans',sans-serif;font-weight:600;font-size:.86rem;cursor:pointer;transition:opacity .2s;}
.btn-warning:hover{opacity:.85;}
.btn-blue{background:var(--blue);color:#fff;border:none;padding:9px 18px;border-radius:var(--radius-sm);
  font-family:'DM Sans',sans-serif;font-weight:600;font-size:.86rem;cursor:pointer;transition:opacity .2s;}
.btn-blue:hover{opacity:.85;}
.btn-purple{background:var(--purple);color:#fff;border:none;padding:9px 18px;border-radius:var(--radius-sm);
  font-family:'DM Sans',sans-serif;font-weight:600;font-size:.86rem;cursor:pointer;transition:opacity .2s;}
.btn-purple:hover{opacity:.85;}

/* PRODUCTOS ADMIN */
.add-prod-form{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);
  padding:18px;margin-bottom:20px;display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end;}
@media(max-width:560px){.add-prod-form{grid-template-columns:1fr;}}
.productos-admin{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px;}
.prod-card{background:var(--surface);border-radius:var(--radius-sm);border:1px solid var(--border);
  padding:14px;display:flex;align-items:center;justify-content:space-between;}
.pname{font-weight:600;color:var(--text);}
.pprice{font-size:.83rem;color:var(--text3);margin-top:2px;}
.prod-card-actions{display:flex;gap:6px;}
.icon-btn{width:32px;height:32px;border:1.5px solid var(--border);border-radius:7px;
  background:#fff;cursor:pointer;font-size:.85rem;transition:all .15s;}
.icon-btn:hover{border-color:var(--accent);}

/* HISTORIAL */
.report-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;margin-bottom:20px;}
.stat-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);padding:18px;}
.stat-val{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--accent);}
.stat-lbl{font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-top:3px;}
.history-table{width:100%;border-collapse:collapse;font-size:.86rem;}
.history-table th{padding:9px 13px;text-align:left;border-bottom:2px solid var(--border);
  font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);font-weight:600;}
.history-table td{padding:9px 13px;border-bottom:1px solid var(--border);color:var(--text2);}
.history-table tr:hover td{background:var(--surface2);}
.history-table .total-row td{font-weight:700;color:var(--text);border-top:2px solid var(--border);border-bottom:none;}
.empty-state{text-align:center;padding:50px 20px;color:var(--text3);}
.empty-state .icon{font-size:2.8rem;margin-bottom:10px;}

/* â”€â”€ PANEL ADMIN â”€â”€ */
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){.admin-grid{grid-template-columns:1fr;}}

.admin-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;}
.admin-card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;justify-content:space-between;background:var(--surface2);}
.admin-card-title{font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--text);}
.admin-card-body{padding:16px 20px;}

/* USUARIOS */
.user-list{display:flex;flex-direction:column;gap:10px;margin-top:4px;}
.user-item{display:flex;align-items:center;justify-content:space-between;
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;}
.user-info .uname{font-weight:600;color:var(--text);font-size:.9rem;}
.user-info .ufull{font-size:.78rem;color:var(--text3);margin-top:2px;}
.user-item-actions{display:flex;gap:6px;align-items:center;}

/* ACTIVIDAD */
.activity-list{display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto;}
.activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);}
.activity-item:last-child{border-bottom:none;}
.activity-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0;}
.activity-dot.accion-pedido{background:var(--green);}
.activity-dot.accion-pago{background:var(--orange);}
.activity-dot.accion-login{background:var(--blue);}
.activity-dot.accion-producto{background:var(--purple);}
.activity-dot.accion-admin{background:var(--accent);}
.activity-content{flex:1;}
.activity-msg{font-size:.84rem;color:var(--text2);}
.activity-meta{font-size:.74rem;color:var(--text3);margin-top:2px;}
.activity-user{font-weight:600;color:var(--text);}

/* ADD USER FORM */
.add-user-form{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:16px;margin-bottom:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:500px){.add-user-form{grid-template-columns:1fr;}}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:#fff;
  padding:11px 18px;border-radius:var(--radius-sm);font-size:.86rem;z-index:9999;
  animation:toastIn .3s ease;box-shadow:var(--shadow-lg);max-width:320px;}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px;}
.hidden{display:none!important;}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:500px){.two-col{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="spinner"></div>
  <div class="loading-txt">Conectando con Firebase...</div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">ğŸ½ Delicias</div>
    <div class="login-sub">Administrador de Mesas</div>
    <div class="login-field"><label>Usuario</label>
      <input type="text" id="inp-user" placeholder="usuario" autocomplete="username"/></div>
    <div class="login-field"><label>ContraseÃ±a</label>
      <input type="password" id="inp-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
    <button class="login-btn" onclick="doLogin()">Ingresar</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <header>
    <div class="header-brand">
      <h1>ğŸ½ Delicias</h1>
      <span>Administrador de Mesas</span>
    </div>
    <div class="header-actions">
      <span><span class="sync-dot" id="sync-dot"></span>
        <span id="sync-txt" style="font-size:.76rem;color:var(--text3)">En lÃ­nea</span></span>
      <div class="user-pill">
        <span id="header-username">â€”</span>
        <span class="role-badge" id="header-role">â€”</span>
      </div>
      <button class="btn-ghost" id="btn-export" onclick="exportCSV()">ğŸ“Š CSV</button>
      <button class="btn-ghost" onclick="doLogout()">Salir</button>
    </div>
  </header>

  <div class="tabs" id="tabs-bar">
    <button class="tab active" onclick="setTab('mesas',this)">ğŸª‘ Mesas</button>
    <button class="tab" onclick="setTab('productos',this)">ğŸ›’ Productos</button>
    <button class="tab" onclick="setTab('historial',this)">ğŸ“‹ Historial</button>
    <button class="tab admin-only hidden" id="tab-admin-btn" onclick="setTab('admin',this)">âš™ï¸ AdministraciÃ³n</button>
  </div>

  <div class="main">
    <!-- MESAS -->
    <div id="tab-mesas">
      <div class="section-title">Mesas del Restaurante
        <span class="badge" id="badge-mesas">0 ocupadas</span></div>
      <div class="mesas-grid" id="mesas-grid"></div>
    </div>

    <!-- PRODUCTOS -->
    <div id="tab-productos" class="hidden">
      <div class="section-title">GestiÃ³n de Productos</div>
      <div id="add-prod-wrap">
        <div class="add-prod-form">
          <div class="field" style="margin:0"><label>Nombre</label>
            <input type="text" id="prod-nombre" placeholder="Ej: Mojito"/></div>
          <div class="field" style="margin:0"><label>Precio (Gs.)</label>
            <input type="number" id="prod-precio" placeholder="0" step="1" min="0"/></div>
          <button class="btn-primary" onclick="agregarProducto()" style="height:42px">+ AÃ±adir</button>
        </div>
      </div>
      <div class="productos-admin" id="productos-admin-list"></div>
    </div>

    <!-- HISTORIAL -->
    <div id="tab-historial" class="hidden">
      <div class="section-title">Historial de Ventas â€” Noche</div>
      <div class="report-summary">
        <div class="stat-card"><div class="stat-val" id="stat-clientes">0</div><div class="stat-lbl">Clientes Atendidos</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-mesas-h">0</div><div class="stat-lbl">Mesas Usadas</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-total">Gs. 0</div><div class="stat-lbl">Ingreso Total</div></div>
      </div>
      <div style="background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;">
        <div id="historial-container"></div>
      </div>
      <div id="btn-limpiar-wrap" style="margin-top:14px;text-align:right;display:none">
        <button class="btn-danger" onclick="limpiarHistorial()">ğŸ—‘ Limpiar historial de noche</button>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="tab-admin" class="hidden">
      <div class="section-title">âš™ï¸ Panel de AdministraciÃ³n</div>
      <div class="admin-grid">

        <!-- USUARIOS -->
        <div class="admin-card">
          <div class="admin-card-header">
            <span class="admin-card-title">ğŸ‘¥ Usuarios del Sistema</span>
            <button class="btn-primary" onclick="toggleAddUser()" style="font-size:.8rem;padding:6px 12px">+ Nuevo</button>
          </div>
          <div class="admin-card-body">
            <div id="add-user-wrap" class="hidden">
              <div class="add-user-form">
                <div class="field" style="margin:0"><label>Nombre completo</label>
                  <input type="text" id="nu-nombre" placeholder="Ej: Juan PÃ©rez"/></div>
                <div class="field" style="margin:0"><label>Usuario</label>
                  <input type="text" id="nu-user" placeholder="juanp"/></div>
                <div class="field" style="margin:0"><label>ContraseÃ±a</label>
                  <input type="password" id="nu-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
                <div class="field" style="margin:0"><label>Confirmar contraseÃ±a</label>
                  <input type="password" id="nu-pass2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
              </div>
              <div style="display:flex;gap:8px;margin-bottom:14px;">
                <button class="btn-success" onclick="crearUsuario()">âœ… Crear usuario</button>
                <button class="btn-ghost" onclick="toggleAddUser()">Cancelar</button>
              </div>
            </div>
            <div class="user-list" id="users-list"></div>
          </div>
        </div>

        <!-- ACTIVIDAD RECIENTE -->
        <div class="admin-card">
          <div class="admin-card-header">
            <span class="admin-card-title">ğŸ“ Registro de Actividad</span>
            <button class="btn-ghost" onclick="limpiarActividad()" style="font-size:.78rem;padding:5px 10px">Limpiar</button>
          </div>
          <div class="admin-card-body">
            <div class="activity-list" id="activity-list">
              <div class="empty-state"><div class="icon">ğŸ“</div><p>Sin actividad registrada.</p></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- MODAL MESA -->
<div class="modal-overlay" id="modal-mesa">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modal-title">Mesa 1</div>
        <div style="font-size:.78rem;color:var(--text3);margin-top:2px" id="modal-subtitle"></div>
      </div>
      <button class="modal-close" onclick="cerrarModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="field"><label>Mesero responsable</label>
        <input type="text" id="inp-mesero" placeholder="Nombre del mesero" readonly style="background:#f0ede9;cursor:default"/></div>
      <div class="pedido-layout">
        <div>
          <div style="font-size:.76rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:7px;">Productos</div>
          <div class="productos-grid" id="productos-grid"></div>
        </div>
        <div>
          <div class="orden-panel">
            <h4>Pedido actual</h4>
            <div class="orden-items" id="orden-items">
              <div style="color:var(--text3);font-size:.83rem;padding:8px 0">Sin productos</div>
            </div>
            <div class="orden-total">
              <span style="font-weight:600;color:var(--text2);font-size:.88rem">Total</span>
              <span class="total-amount" id="pedido-total">Gs. 0</span>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:18px;">
        <div style="font-size:.76rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;">
          Clientes esta noche en esta mesa
        </div>
        <div id="clientes-mesa-list"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-success" onclick="confirmarPedido()">âœ… Confirmar pedido</button>
        <button class="btn-warning" id="btn-pagar" onclick="marcarPagado()">ğŸ’° Pagado â€” Liberar mesa</button>
        <button class="btn-blue" onclick="verHistorialMesa()">ğŸ“‹ Historial completo</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR PRODUCTO -->
<div class="modal-overlay" id="modal-edit-prod">
  <div class="modal" style="max-width:400px">
    <div class="modal-header">
      <div class="modal-title">Editar Producto</div>
      <button class="modal-close" onclick="cerrarEditProd()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-prod-id"/>
      <div class="field"><label>Nombre</label><input type="text" id="edit-prod-nombre"/></div>
      <div class="field"><label>Precio (Gs.)</label><input type="number" id="edit-prod-precio" step="1" min="0"/></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn-primary" onclick="guardarEditProd()">Guardar</button>
        <button class="btn-ghost" onclick="cerrarEditProd()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL MESA -->
<div class="modal-overlay" id="modal-hist-mesa">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <div class="modal-title" id="hist-mesa-title">Historial Mesa</div>
      <button class="modal-close" onclick="$('modal-hist-mesa').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-body"><div id="hist-mesa-body"></div></div>
  </div>
</div>

<!-- MODAL CAMBIAR CONTRASEÃ‘A -->
<div class="modal-overlay" id="modal-cambiar-pass">
  <div class="modal" style="max-width:380px">
    <div class="modal-header">
      <div class="modal-title">Cambiar ContraseÃ±a</div>
      <button class="modal-close" onclick="$('modal-cambiar-pass').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="cp-user-id"/>
      <div id="cp-user-name" style="font-weight:600;color:var(--text2);margin-bottom:14px;font-size:.9rem;"></div>
      <div class="field"><label>Nueva contraseÃ±a</label><input type="password" id="cp-pass"/></div>
      <div class="field"><label>Confirmar</label><input type="password" id="cp-pass2"/></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn-primary" onclick="guardarNuevaPass()">Guardar</button>
        <button class="btn-ghost" onclick="$('modal-cambiar-pass').classList.remove('open')">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp }  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, push, remove }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey:"AIzaSyCdKSf2g1cIyXrD6k_u1aR9TMln9HaPJro",
  authDomain:"delicia-restaurante.firebaseapp.com",
  databaseURL:"https://delicia-restaurante-default-rtdb.firebaseio.com",
  projectId:"delicia-restaurante",
  storageBucket:"delicia-restaurante.firebasestorage.app",
  messagingSenderId:"653903447900",
  appId:"1:653903447900:web:85cffda9d703e464af6399"
};
const fbApp = initializeApp(firebaseConfig);
const db    = getDatabase(fbApp);

// â”€â”€ CONSTANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CURRENCY    = 'Gs.';
const TOTAL_MESAS = 12;
const SESSION_KEY = 'delicias_sess_v2';

// Usuario maestro (siempre existe, no se puede borrar)
const MASTER = { id:'admin', username:'ADMIN', nombre:'Administrador', role:'admin' };

const fmt = n => CURRENCY+' '+Math.round(n).toLocaleString('es-PY');

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = { mesas:{}, productos:[], historial:[], usuarios:[], actividad:[] };
let sesion = null;   // { id, username, nombre, role }
let mesaAbierta = null;
let pedidoActual = {};

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.$ = id => document.getElementById(id);
const html = (id,h) => { const e=$(id); if(e) e.innerHTML=h; };

function toast(msg,color=''){
  const el=document.createElement('div');
  el.className='toast'; el.textContent=msg;
  if(color) el.style.background=color;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3200);
}
function hora(){ return new Date().toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit'}); }
function fechaHora(){ return new Date().toLocaleString('es-PY',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}); }

// â”€â”€ SESIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession(s){ localStorage.setItem(SESSION_KEY,JSON.stringify(s)); }
function loadSession(){ try{ return JSON.parse(localStorage.getItem(SESSION_KEY)); }catch(e){ return null; } }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

// â”€â”€ ARRANQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot(){
  $('loading-screen').style.display='flex';
  try{
    await cargarDatos();
    suscribirCambios();
    $('loading-screen').style.display='none';
    const saved = loadSession();
    if(saved){
      // Verificar que el usuario aÃºn existe
      if(saved.id==='admin' || state.usuarios.find(u=>u.id===saved.id)){
        sesion=saved; mostrarApp();
      } else {
        clearSession(); mostrarLogin();
      }
    } else {
      mostrarLogin();
    }
  }catch(err){
    console.error(err);
    $('loading-screen').style.display='none';
    mostrarLogin();
    toast('âš ï¸ Error de conexiÃ³n con Firebase.');
  }
}

function mostrarLogin(){ $('login-screen').classList.add('show'); }
function ocultarLogin(){ $('login-screen').classList.remove('show'); }

function mostrarApp(){
  ocultarLogin();
  $('app').classList.remove('hidden');
  // Header
  $('header-username').textContent = sesion.nombre || sesion.username;
  $('header-role').textContent = sesion.role==='admin' ? 'Admin' : 'Mesero';
  $('header-role').className = 'role-badge '+(sesion.role==='admin'?'admin':'mesero');
  // Tabs segÃºn rol
  if(sesion.role==='admin'){
    $('tab-admin-btn').classList.remove('hidden');
    $('btn-limpiar-wrap').style.display='block';
  } else {
    $('tab-admin-btn').classList.add('hidden');
    $('btn-limpiar-wrap').style.display='none';
  }
  // El mesero no puede editar productos (solo ver)
  if(sesion.role!=='admin'){
    $('add-prod-wrap').style.display='none';
  }
  $('inp-mesero').value = sesion.nombre || sesion.username;
  $('fecha-lbl') && ($('fecha-lbl').textContent = new Date().toLocaleDateString('es-PY',
    {weekday:'long',year:'numeric',month:'long',day:'numeric'}));
  renderMesas();
  renderProductosAdmin();
  registrarActividad('accion-login',`IngresÃ³ al sistema`);
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doLogin = function(){
  const u=$('inp-user').value.trim().toUpperCase();
  const p=$('inp-pass').value.trim();
  $('login-err').textContent='';
  // Admin maestro
  if(u==='ADMIN' && p==='1234RD'){
    sesion={...MASTER};
    saveSession(sesion);
    mostrarApp();
    return;
  }
  // Usuarios meseros
  const found = state.usuarios.find(x=>x.username.toUpperCase()===u && x.password===p);
  if(found){
    sesion={id:found.id,username:found.username,nombre:found.nombre,role:'mesero'};
    saveSession(sesion);
    mostrarApp();
  } else {
    $('login-err').textContent='Usuario o contraseÃ±a incorrectos.';
  }
};

window.doLogout = function(){
  if(sesion) registrarActividad('accion-login','CerrÃ³ sesiÃ³n');
  clearSession();
  sesion=null;
  $('app').classList.add('hidden');
  mostrarLogin();
  $('inp-user').value='';
  $('inp-pass').value='';
  $('login-err').textContent='';
  // Reset tabs
  setTabDirect('mesas');
};

$('inp-pass').addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });
$('inp-user').addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });

// â”€â”€ FIREBASE DATOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mesaDefault(){ return {ocupada:false,mesero:'',pedidoActual:{},clientesNoche:[]}; }
function productosDefault(){
  return [
    {id:1,nombre:'Coca Cola',precio:150},{id:2,nombre:'Pizza',precio:850},
    {id:3,nombre:'Lomito',precio:950},{id:4,nombre:'Jugos',precio:120},
    {id:5,nombre:'Cerveza',precio:200},{id:6,nombre:'Agua',precio:80},
    {id:7,nombre:'Hamburguesa',precio:700},{id:8,nombre:'Papas fritas',precio:350}
  ];
}

async function cargarDatos(){
  const [msSnap,prSnap,hiSnap,usSnap,acSnap] = await Promise.all([
    get(ref(db,'mesas')), get(ref(db,'productos')),
    get(ref(db,'historial')), get(ref(db,'usuarios')),
    get(ref(db,'actividad'))
  ]);

  // Mesas
  if(msSnap.exists()){ state.mesas=msSnap.val();
    for(let i=1;i<=TOTAL_MESAS;i++) if(!state.mesas[i]){state.mesas[i]=mesaDefault();await set(ref(db,`mesas/${i}`),state.mesas[i]);}
  } else {
    for(let i=1;i<=TOTAL_MESAS;i++) state.mesas[i]=mesaDefault();
    await set(ref(db,'mesas'),state.mesas);
  }
  // Productos
  if(prSnap.exists()){ const r=prSnap.val(); state.productos=Array.isArray(r)?r:Object.values(r); }
  else { state.productos=productosDefault(); await set(ref(db,'productos'),state.productos); }
  // Historial
  if(hiSnap.exists()){ const r=hiSnap.val(); state.historial=Array.isArray(r)?r:Object.values(r); }
  else state.historial=[];
  // Usuarios
  if(usSnap.exists()){ const r=usSnap.val(); state.usuarios=Array.isArray(r)?r:Object.values(r); }
  else state.usuarios=[];
  // Actividad
  if(acSnap.exists()){ const r=acSnap.val(); state.actividad=Array.isArray(r)?r:Object.values(r); }
  else state.actividad=[];
}

function suscribirCambios(){
  onValue(ref(db,'mesas'),snap=>{ if(snap.exists()){state.mesas=snap.val(); renderMesas(); if(mesaAbierta) renderClientesMesa(mesaAbierta);} setSyncOk(true); },()=>setSyncOk(false));
  onValue(ref(db,'productos'),snap=>{ if(snap.exists()){const r=snap.val();state.productos=Array.isArray(r)?r:Object.values(r);}renderProductosAdmin();if(mesaAbierta)renderProductosGrid(); });
  onValue(ref(db,'historial'),snap=>{ if(snap.exists()){const r=snap.val();state.historial=Array.isArray(r)?r:Object.values(r);}else state.historial=[];renderHistorial(); });
  onValue(ref(db,'usuarios'),snap=>{ if(snap.exists()){const r=snap.val();state.usuarios=Array.isArray(r)?r:Object.values(r);}else state.usuarios=[];renderUsersList(); });
  onValue(ref(db,'actividad'),snap=>{ if(snap.exists()){const r=snap.val();state.actividad=Array.isArray(r)?r:Object.values(r);}else state.actividad=[];renderActividad(); });
}

function setSyncOk(ok){
  const dot=$('sync-dot'),txt=$('sync-txt');
  if(!dot)return;
  dot.className='sync-dot'+(ok?'':' offline');
  txt.textContent=ok?'En lÃ­nea':'Sin conexiÃ³n';
}

const saveMesa      = num => set(ref(db,`mesas/${num}`),state.mesas[num]);
const saveProductos = ()  => set(ref(db,'productos'),state.productos);
const saveHistorial = ()  => set(ref(db,'historial'),state.historial);
const saveUsuarios  = ()  => set(ref(db,'usuarios'),state.usuarios);

// â”€â”€ ACTIVIDAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registrarActividad(tipo, msg){
  if(!sesion) return;
  const entrada = {
    tipo, msg,
    usuario: sesion.nombre||sesion.username,
    role: sesion.role,
    fechaHora: fechaHora(),
    ts: Date.now()
  };
  state.actividad.unshift(entrada);
  if(state.actividad.length>200) state.actividad=state.actividad.slice(0,200);
  await set(ref(db,'actividad'),state.actividad);
}

function renderActividad(){
  const list=$('activity-list'); if(!list) return;
  if(!state.actividad.length){
    list.innerHTML='<div class="empty-state"><div class="icon">ğŸ“</div><p>Sin actividad registrada.</p></div>'; return;
  }
  list.innerHTML = state.actividad.slice(0,80).map(a=>`
    <div class="activity-item">
      <div class="activity-dot ${a.tipo}"></div>
      <div class="activity-content">
        <div class="activity-msg"><span class="activity-user">${a.usuario}</span> â€” ${a.msg}</div>
        <div class="activity-meta">${a.fechaHora} Â· ${a.role==='admin'?'ğŸ‘‘ Admin':'ğŸ‘¤ Mesero'}</div>
      </div>
    </div>`).join('');
}

window.limpiarActividad = async function(){
  if(!confirm('Â¿Limpiar el registro de actividad?')) return;
  state.actividad=[];
  await set(ref(db,'actividad'),[]);
  toast('Actividad limpiada.');
};

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setTab = function(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['mesas','productos','historial','admin'].forEach(t=>
    $('tab-'+t).classList.toggle('hidden',t!==tab));
};
function setTabDirect(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const tabs={mesas:0,productos:1,historial:2,admin:3};
  const btns=document.querySelectorAll('.tab');
  if(btns[tabs[tab]]) btns[tabs[tab]].classList.add('active');
  ['mesas','productos','historial','admin'].forEach(t=>
    $('tab-'+t).classList.toggle('hidden',t!==tab));
}

// â”€â”€ MESAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcTotal(pedido){
  if(!pedido) return 0;
  return Object.entries(pedido).reduce((s,[pid,qty])=>{
    const p=state.productos.find(p=>String(p.id)===String(pid));
    return s+(p?p.precio*qty:0);
  },0);
}

function renderMesas(){
  let h='',ocp=0;
  for(let i=1;i<=TOTAL_MESAS;i++){
    const m=state.mesas[i]||mesaDefault();
    const tot=calcTotal(m.pedidoActual);
    if(m.ocupada) ocp++;
    h+=`<div class="mesa-card ${m.ocupada?'ocupada':''}" onclick="abrirMesa(${i})">
      <div class="mesa-label">Mesa</div>
      <div class="mesa-num">${i}</div>
      <div class="mesa-status ${m.ocupada?'ocupada':'libre'}">${m.ocupada?'Ocupada':'Libre'}</div>
      ${m.mesero?`<div class="mesa-mesero">ğŸ‘¤ ${m.mesero}</div>`:''}
      ${m.ocupada&&tot>0?`<div class="mesa-total">${fmt(tot)}</div>`:''}
    </div>`;
  }
  html('mesas-grid',h);
  const b=$('badge-mesas'); if(b) b.textContent=`${ocp} ocupada${ocp!==1?'s':''}`;
}

// â”€â”€ MODAL MESA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.abrirMesa = function(num){
  mesaAbierta=num;
  const m=state.mesas[num]||mesaDefault();
  pedidoActual={...(m.pedidoActual||{})};
  $('modal-title').textContent=`Mesa ${num}`;
  $('modal-subtitle').textContent=m.ocupada?'ğŸ”´ Ocupada':'ğŸŸ¢ Disponible';
  // El campo mesero muestra al usuario logueado (solo lectura)
  $('inp-mesero').value=sesion?sesion.nombre||sesion.username:'';
  renderProductosGrid();
  renderPedidoActual();
  renderClientesMesa(num);
  $('modal-mesa').classList.add('open');
};

window.cerrarModal=function(){$('modal-mesa').classList.remove('open');mesaAbierta=null;};

function renderProductosGrid(){
  if(!state.productos.length){html('productos-grid','<div style="color:var(--text3);grid-column:1/-1;font-size:.83rem">Sin productos.</div>');return;}
  html('productos-grid',state.productos.map(p=>
    `<button class="producto-btn" onclick="addProd(${p.id})">
      <span class="prod-name">${p.nombre}</span>
      <span class="prod-price">${fmt(p.precio)}</span>
    </button>`).join(''));
}

window.addProd=function(pid){pedidoActual[pid]=(pedidoActual[pid]||0)+1;renderPedidoActual();};

window.cambiarQty=function(pid,d){
  pedidoActual[pid]=(pedidoActual[pid]||0)+d;
  if(pedidoActual[pid]<=0) delete pedidoActual[pid];
  renderPedidoActual();
};

function renderPedidoActual(){
  const items=Object.entries(pedidoActual);
  if(!items.length){html('orden-items','<div style="color:var(--text3);font-size:.83rem;padding:8px 0">Sin productos</div>');$('pedido-total').textContent=fmt(0);return;}
  let total=0,h='';
  for(const [pid,qty] of items){
    const p=state.productos.find(p=>String(p.id)===String(pid)); if(!p) continue;
    const sub=p.precio*qty; total+=sub;
    h+=`<div class="orden-item">
      <span class="orden-item-name">${p.nombre}</span>
      <span class="orden-item-qty">
        <button class="qty-btn" onclick="cambiarQty(${pid},-1)">âˆ’</button>
        <span class="qty-num">${qty}</span>
        <button class="qty-btn" onclick="cambiarQty(${pid},1)">+</button>
      </span>
      <span class="orden-item-price">${fmt(sub)}</span>
    </div>`;
  }
  html('orden-items',h);
  $('pedido-total').textContent=fmt(total);
}

window.confirmarPedido=async function(){
  if(!mesaAbierta) return;
  if(!Object.keys(pedidoActual).length){toast('AÃ±ade al menos un producto.');return;}
  const nombreMesero=sesion?sesion.nombre||sesion.username:'';
  const m=state.mesas[mesaAbierta];
  m.pedidoActual={...pedidoActual};
  m.mesero=nombreMesero;
  m.ocupada=true;
  m.ultimoUsuario=sesion?sesion.username:'';
  await saveMesa(mesaAbierta);
  $('modal-subtitle').textContent='ğŸ”´ Ocupada';
  await registrarActividad('accion-pedido',`ConfirmÃ³ pedido en Mesa ${mesaAbierta} (${fmt(calcTotal(pedidoActual))})`);
  toast(`âœ… Pedido confirmado â€” Mesa ${mesaAbierta}`);
};

window.marcarPagado=async function(){
  if(!mesaAbierta) return;
  const m=state.mesas[mesaAbierta];
  const nombreMesero=sesion?sesion.nombre||sesion.username:'';
  if(Object.keys(pedidoActual).length>0){
    const cn=m.clientesNoche||[];
    const detalles=Object.entries(pedidoActual).map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return p?{nombre:p.nombre,qty,precio:p.precio,sub:p.precio*qty}:null;
    }).filter(Boolean);
    const total=calcTotal(pedidoActual);
    cn.push({num:cn.length+1,detalles,total,mesero:nombreMesero,usuario:sesion?sesion.username:'',hora:hora()});
    m.clientesNoche=cn;
    state.historial.push({mesa:mesaAbierta,clienteNum:cn.length,detalles,total,
      mesero:nombreMesero,usuario:sesion?sesion.username:'',hora:hora()});
    await saveHistorial();
    await registrarActividad('accion-pago',`MarcÃ³ Mesa ${mesaAbierta} como pagada â€” ${fmt(total)}`);
  }
  m.ocupada=false; m.pedidoActual={}; m.mesero=''; m.ultimoUsuario='';
  await saveMesa(mesaAbierta);
  pedidoActual={};
  cerrarModal();
  toast(`ğŸ’° Mesa ${mesaAbierta} liberada y pagada âœ…`);
};

function renderClientesMesa(num){
  const m=state.mesas[num];
  const cl=m&&m.clientesNoche?m.clientesNoche:[];
  if(!cl.length){html('clientes-mesa-list','<div style="color:var(--text3);font-size:.81rem;">Sin clientes registrados esta noche.</div>');return;}
  html('clientes-mesa-list',cl.map(c=>`
    <div class="cliente-item">
      <div class="cliente-header">
        <span class="cliente-num">Cliente ${c.num}Â°</span>
        <span style="font-size:.86rem;font-weight:600;color:var(--text2)">${fmt(c.total)}</span>
      </div>
      <div class="cliente-items-list">${c.detalles.map(d=>`${d.qty}x ${d.nombre} = ${fmt(d.sub)}`).join(' Â· ')}</div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:4px;flex-wrap:wrap;">
        ${c.mesero?`<span class="mesero-badge">ğŸ‘¤ ${c.mesero}</span>`:''}
        ${c.usuario?`<span class="mesero-badge" style="color:var(--blue);border-color:rgba(41,128,185,.3)">ğŸ–¥ï¸ ${c.usuario}</span>`:''}
      </div>
    </div>`).join(''));
}

window.verHistorialMesa=function(){
  if(!mesaAbierta) return;
  const cl=(state.mesas[mesaAbierta]&&state.mesas[mesaAbierta].clientesNoche)||[];
  $('hist-mesa-title').textContent=`Historial Completo â€” Mesa ${mesaAbierta}`;
  if(!cl.length){html('hist-mesa-body','<div class="empty-state"><div class="icon">ğŸ“‹</div><p>Sin historial esta noche.</p></div>');}
  else{
    let tot=0;
    let h='<table class="history-table"><thead><tr><th>Cliente</th><th>Detalle</th><th>Mesero</th><th>Usuario</th><th>Total</th></tr></thead><tbody>';
    cl.forEach(c=>{tot+=c.total;
      h+=`<tr><td>Cliente ${c.num}Â°</td><td>${c.detalles.map(d=>`${d.qty}Ã— ${d.nombre}`).join(', ')}</td>
        <td>${c.mesero||'â€”'}</td><td>${c.usuario||'â€”'}</td><td>${fmt(c.total)}</td></tr>`;
    });
    h+=`<tr class="total-row"><td colspan="4">Total Mesa ${mesaAbierta}</td><td>${fmt(tot)}</td></tr></tbody></table>`;
    html('hist-mesa-body',h);
  }
  $('modal-hist-mesa').classList.add('open');
};

// â”€â”€ PRODUCTOS ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProductosAdmin(){
  html('productos-admin-list',state.productos.length
    ? state.productos.map(p=>`
        <div class="prod-card">
          <div><div class="pname">${p.nombre}</div><div class="pprice">${fmt(p.precio)}</div></div>
          <div class="prod-card-actions">
            ${sesion&&sesion.role==='admin'?`
              <button class="icon-btn" onclick="abrirEditProd(${p.id})">âœï¸</button>
              <button class="icon-btn" onclick="eliminarProd(${p.id})">ğŸ—‘ï¸</button>`:''}
          </div>
        </div>`).join('')
    : '<div style="color:var(--text3)">Sin productos.</div>');
}

window.agregarProducto=async function(){
  if(sesion?.role!=='admin'){toast('Solo el Admin puede aÃ±adir productos.');return;}
  const nombre=$('prod-nombre').value.trim();
  const precio=parseInt($('prod-precio').value);
  if(!nombre){toast('Ingresa el nombre.');return;}
  if(isNaN(precio)||precio<0){toast('Precio invÃ¡lido.');return;}
  const id=state.productos.length?Math.max(...state.productos.map(p=>p.id))+1:1;
  state.productos.push({id,nombre,precio});
  await saveProductos();
  $('prod-nombre').value='';$('prod-precio').value='';
  await registrarActividad('accion-producto',`AÃ±adiÃ³ producto "${nombre}" â€” ${fmt(precio)}`);
  toast(`"${nombre}" aÃ±adido.`);
};

window.eliminarProd=async function(id){
  if(sesion?.role!=='admin'){toast('Solo el Admin puede eliminar productos.');return;}
  if(!confirm('Â¿Eliminar este producto?')) return;
  const p=state.productos.find(p=>p.id===id);
  state.productos=state.productos.filter(p=>p.id!==id);
  await saveProductos();
  await registrarActividad('accion-producto',`EliminÃ³ producto "${p?.nombre||id}"`);
  toast('Producto eliminado.');
};

window.abrirEditProd=function(id){
  const p=state.productos.find(p=>p.id===id); if(!p) return;
  $('edit-prod-id').value=id;$('edit-prod-nombre').value=p.nombre;$('edit-prod-precio').value=p.precio;
  $('modal-edit-prod').classList.add('open');
};

window.guardarEditProd=async function(){
  if(sesion?.role!=='admin'){toast('Solo el Admin puede editar productos.');return;}
  const id=parseInt($('edit-prod-id').value);
  const nombre=$('edit-prod-nombre').value.trim();
  const precio=parseInt($('edit-prod-precio').value);
  if(!nombre||isNaN(precio)){toast('Completa los campos.');return;}
  const p=state.productos.find(p=>p.id===id);
  if(p){p.nombre=nombre;p.precio=precio;}
  await saveProductos();
  cerrarEditProd();
  await registrarActividad('accion-producto',`EditÃ³ producto "${nombre}" â€” ${fmt(precio)}`);
  toast('Producto actualizado.');
};

window.cerrarEditProd=function(){$('modal-edit-prod').classList.remove('open');};

// â”€â”€ GESTIÃ“N USUARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleAddUser=function(){
  const w=$('add-user-wrap');
  w.classList.toggle('hidden');
  if(!w.classList.contains('hidden')){
    $('nu-nombre').focus();
    $('nu-nombre').value='';$('nu-user').value='';$('nu-pass').value='';$('nu-pass2').value='';
  }
};

window.crearUsuario=async function(){
  const nombre=$('nu-nombre').value.trim();
  const username=$('nu-user').value.trim().toUpperCase();
  const pass=$('nu-pass').value;
  const pass2=$('nu-pass2').value;
  if(!nombre||!username||!pass){toast('Completa todos los campos.');return;}
  if(pass!==pass2){toast('Las contraseÃ±as no coinciden.');return;}
  if(username==='ADMIN'){toast('Ese nombre de usuario estÃ¡ reservado.');return;}
  if(state.usuarios.find(u=>u.username.toUpperCase()===username)){toast('Ese usuario ya existe.');return;}
  const newUser={
    id:'u_'+Date.now(),
    nombre, username, password:pass, role:'mesero',
    creadoPor: sesion?sesion.username:'admin',
    creadoEn: fechaHora()
  };
  state.usuarios.push(newUser);
  await saveUsuarios();
  toggleAddUser();
  await registrarActividad('accion-admin',`CreÃ³ usuario mesero "${nombre}" (${username})`);
  toast(`âœ… Usuario "${nombre}" creado.`);
};

window.eliminarUsuario=async function(id){
  const u=state.usuarios.find(u=>u.id===id);
  if(!u) return;
  if(!confirm(`Â¿Eliminar al usuario "${u.nombre}"?`)) return;
  state.usuarios=state.usuarios.filter(u=>u.id!==id);
  await saveUsuarios();
  await registrarActividad('accion-admin',`EliminÃ³ usuario "${u.nombre}" (${u.username})`);
  toast('Usuario eliminado.');
};

window.abrirCambiarPass=function(id){
  const u=state.usuarios.find(u=>u.id===id); if(!u) return;
  $('cp-user-id').value=id;
  $('cp-user-name').textContent=`ğŸ‘¤ ${u.nombre} (${u.username})`;
  $('cp-pass').value='';$('cp-pass2').value='';
  $('modal-cambiar-pass').classList.add('open');
};

window.guardarNuevaPass=async function(){
  const id=$('cp-user-id').value;
  const pass=$('cp-pass').value;
  const pass2=$('cp-pass2').value;
  if(!pass){toast('Ingresa la nueva contraseÃ±a.');return;}
  if(pass!==pass2){toast('Las contraseÃ±as no coinciden.');return;}
  const u=state.usuarios.find(u=>u.id===id);
  if(u) u.password=pass;
  await saveUsuarios();
  $('modal-cambiar-pass').classList.remove('open');
  await registrarActividad('accion-admin',`CambiÃ³ contraseÃ±a del usuario "${u?.nombre}"`);
  toast('ContraseÃ±a actualizada.');
};

function renderUsersList(){
  const list=$('users-list'); if(!list) return;
  // Admin maestro siempre primero
  let h=`<div class="user-item">
    <div class="user-info">
      <div class="uname">ğŸ‘‘ Administrador</div>
      <div class="ufull">Usuario: ADMIN Â· <span style="color:var(--accent);font-weight:600">Admin Principal</span></div>
    </div>
    <div><span class="role-badge admin">Admin</span></div>
  </div>`;
  if(!state.usuarios.length){
    h+='<div style="color:var(--text3);font-size:.83rem;text-align:center;padding:14px;">Sin meseros creados aÃºn.</div>';
  } else {
    h+=state.usuarios.map(u=>`
      <div class="user-item">
        <div class="user-info">
          <div class="uname">ğŸ‘¤ ${u.nombre}</div>
          <div class="ufull">Usuario: ${u.username} Â· Creado: ${u.creadoEn||'â€”'}</div>
        </div>
        <div class="user-item-actions">
          <span class="role-badge mesero">Mesero</span>
          <button class="icon-btn" title="Cambiar contraseÃ±a" onclick="abrirCambiarPass('${u.id}')">ğŸ”‘</button>
          <button class="icon-btn" title="Eliminar" onclick="eliminarUsuario('${u.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`).join('');
  }
  list.innerHTML=h;
}

// â”€â”€ HISTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistorial(){
  const h=state.historial||[];
  let total=0; const mesasSet=new Set(); const byMesa={};
  h.forEach(r=>{ if(!byMesa[r.mesa]) byMesa[r.mesa]=[]; byMesa[r.mesa].push(r); total+=r.total; mesasSet.add(r.mesa); });
  const sc=$('stat-clientes'),sm=$('stat-mesas-h'),st=$('stat-total');
  if(sc) sc.textContent=h.length; if(sm) sm.textContent=mesasSet.size; if(st) st.textContent=fmt(total);
  if(!h.length){html('historial-container','<div class="empty-state"><div class="icon">ğŸ“‹</div><p>Sin ventas esta noche. Aparecen al marcar una mesa como pagada.</p></div>');return;}
  let t='<table class="history-table"><thead><tr><th>Mesa</th><th>Cliente</th><th>Hora</th><th>Productos</th><th>Mesero</th><th>Usuario</th><th>Total</th></tr></thead><tbody>';
  Object.keys(byMesa).sort((a,b)=>a-b).forEach(mesa=>{
    let tm=0;
    byMesa[mesa].forEach(r=>{ tm+=r.total;
      t+=`<tr><td><strong>Mesa ${mesa}</strong></td><td>Cliente ${r.clienteNum}Â°</td><td>${r.hora}</td>
        <td>${r.detalles.map(d=>`${d.qty}Ã— ${d.nombre}`).join(', ')}</td>
        <td>${r.mesero||'â€”'}</td><td style="color:var(--blue);font-weight:500">${r.usuario||'â€”'}</td><td>${fmt(r.total)}</td></tr>`;
    });
    t+=`<tr class="total-row"><td colspan="6">Subtotal Mesa ${mesa}</td><td>${fmt(tm)}</td></tr>`;
  });
  t+=`<tr class="total-row" style="background:rgba(192,57,43,.04)"><td colspan="6">ğŸ’° INGRESO TOTAL DE LA NOCHE</td>
    <td style="color:var(--accent);font-size:1rem">${fmt(total)}</td></tr></tbody></table>`;
  html('historial-container',t);
}

window.limpiarHistorial=async function(){
  if(sesion?.role!=='admin'){toast('Solo el Admin puede limpiar el historial.');return;}
  if(!confirm('Â¿Limpiar todo el historial de la noche?')) return;
  state.historial=[];
  await set(ref(db,'historial'),[]);
  for(let i=1;i<=TOTAL_MESAS;i++){state.mesas[i].clientesNoche=[];await saveMesa(i);}
  await registrarActividad('accion-admin','LimpiÃ³ el historial de ventas de la noche');
  toast('Historial limpiado.');
};

// â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.exportCSV=function(){
  const h=state.historial||[];
  if(!h.length){toast('No hay ventas para exportar.');return;}
  const byMesa={}; let total=0;
  h.forEach(r=>{ if(!byMesa[r.mesa]) byMesa[r.mesa]=[]; byMesa[r.mesa].push(r); total+=r.total; });
  let csv=`Restaurante Delicias â€” Historial de Ventas\nFecha,${new Date().toLocaleDateString('es-PY')}\n\n`;
  csv+='Mesa,Cliente,Hora,Producto,Cantidad,Precio Unitario,Subtotal,Mesero,Usuario\n';
  Object.keys(byMesa).sort((a,b)=>a-b).forEach(mesa=>{
    byMesa[mesa].forEach(r=>r.detalles.forEach(d=>{
      csv+=`Mesa ${mesa},Cliente ${r.clienteNum}Â°,${r.hora},"${d.nombre}",${d.qty},${Math.round(d.precio)},${Math.round(d.sub)},"${r.mesero||''}","${r.usuario||''}"\n`;
    }));
    csv+=`Mesa ${mesa},Total Mesa,,,,,${fmt(byMesa[mesa].reduce((s,r)=>s+r.total,0))},,\n\n`;
  });
  csv+=`\nINGRESO TOTAL,,,,,,${fmt(total)},,\n\nRESUMEN POR MESA\nMesa,Clientes,Total\n`;
  Object.keys(byMesa).sort((a,b)=>a-b).forEach(mesa=>
    csv+=`Mesa ${mesa},${byMesa[mesa].length},"${fmt(byMesa[mesa].reduce((s,r)=>s+r.total,0))}"\n`);
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`Delicias_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();URL.revokeObjectURL(url);
  registrarActividad('accion-admin','ExportÃ³ el historial de ventas a CSV');
  toast('ğŸ“Š CSV descargado.');
};

// â”€â”€ CERRAR MODALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('modal-mesa').addEventListener('click',function(e){if(e.target===this)window.cerrarModal();});
$('modal-edit-prod').addEventListener('click',function(e){if(e.target===this)window.cerrarEditProd();});
$('modal-hist-mesa').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
$('modal-cambiar-pass').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});

boot();
</script>
</body>
</html>
