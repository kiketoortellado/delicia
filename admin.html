<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Delicias — Administración</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  /* PALETA UNIFICADA - Tema claro sofisticado */
  --bg:#faf8f5;
  --bg-warm:#f5f0eb;
  --surface:#ffffff;
  --surface-hover:#f9f7f4;
  --border:#e8e0d5;
  --border-accent:#d4c4b0;
  
  /* Dorado sofisticado */
  --gold:#c9a84c;
  --gold-light:#e8c96a;
  --gold-dark:#a88b3d;
  --gold-glow:rgba(201,168,76,0.12);
  
  /* Acentos funcionales */
  --accent:#8b4513;
  --accent-light:#a0522d;
  --success:#2d6a4f;
  --success-light:#40916c;
  --warning:#c9a84c;
  --error:#c0392b;
  --info:#4a7c59;
  --blue:#4a6fa5;
  --purple:#7b68ee;
  
  /* Textos */
  --text:#2c241b;
  --text-secondary:#5a4d3d;
  --text-muted:#8a7b6b;
  --text-light:#b8a99a;
  
  /* Sombras */
  --shadow-sm:0 2px 8px rgba(44,36,27,0.06);
  --shadow-md:0 4px 16px rgba(44,36,27,0.08);
  --shadow-lg:0 8px 32px rgba(44,36,27,0.12);
  --shadow-gold:0 0 20px rgba(201,168,76,0.15);
  
  /* Transiciones */
  --transition-fast:0.15s cubic-bezier(0.4,0,0.2,1);
  --transition-base:0.3s cubic-bezier(0.4,0,0.2,1);
  --transition-bounce:0.4s cubic-bezier(0.34,1.56,0.64,1);
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6;}

/* ════════════════════════════════════════════════════════════ */
/* ICONOS SVG REALISTAS */
/* ════════════════════════════════════════════════════════════ */
.icon{
  width:20px;
  height:20px;
  display:inline-block;
  vertical-align:middle;
  transition:all var(--transition-base);
}

.icon-sm{width:16px;height:16px;}
.icon-lg{width:24px;height:24px;}
.icon-xl{width:32px;height:32px;}

/* Iconos específicos */
.icon-logo{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9a84c' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-utensils{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-table{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='7' width='18' height='12' rx='2'/%3E%3Cpath d='M3 7v-2a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v2'/%3E%3Cpath d='M12 7v12'/%3E%3Cpath d='M8 7v-3'/%3E%3Cpath d='M16 7v-3'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-products{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m7.5 4.27 9 5.15'/%3E%3Cpath d='M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z'/%3E%3Cpath d='m3.3 7 8.7 5 8.7-5'/%3E%3Cpath d='M12 22V12'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-history{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 3v5h5'/%3E%3Cpath d='M3.05 13A9 9 0 1 0 6 5.3L3 8'/%3E%3Cpath d='M12 7v5l4 2'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-admin{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-user{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-chef{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z'/%3E%3Cline x1='6' x2='18' y1='17' y2='17'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-crown{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9a84c' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-key{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='7.5' cy='15.5' r='5.5'/%3E%3Cpath d='m21 2-9.6 9.6'/%3E%3Cpath d='m15.5 7.5 3 3L22 7l-3-3'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-trash{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 6h18'/%3E%3Cpath d='M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6'/%3E%3Cpath d='M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2'/%3E%3Cline x1='10' x2='10' y1='11' y2='17'/%3E%3Cline x1='14' x2='14' y1='11' y2='17'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-edit{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7'/%3E%3Cpath d='M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-plus{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 12h14'/%3E%3Cpath d='M12 5v14'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-minus{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 12h14'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-check{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-x{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 6 6 18'/%3E%3Cpath d='m6 6 12 12'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-arrow-left{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m12 19-7-7 7-7'/%3E%3Cpath d='M19 12H5'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-clock{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 6v6l4 2'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-dollar{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='12' x2='12' y1='2' y2='22'/%3E%3Cpath d='M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-receipt{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z'/%3E%3Cpath d='M16 8h-6'/%3E%3Cpath d='M16 12h-6'/%3E%3Cpath d='M16 16h-6'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-search{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.3-4.3'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-logout{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4'/%3E%3Cpolyline points='16 17 21 12 16 7'/%3E%3Cline x1='21' x2='9' y1='12' y2='12'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-sync{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8'/%3E%3Cpath d='M3 3v5h5'/%3E%3Cpath d='M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16'/%3E%3Cpath d='M16 16h5v5'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-activity{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 12h-4l-3 9L9 3l-3 9H2'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-food{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-drink{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 8h1a4 4 0 1 1 0 8h-1'/%3E%3Cpath d='M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z'/%3E%3Cline x1='6' x2='6.01' y1='2' y2='2'/%3E%3Cline x1='10' x2='10.01' y1='2' y2='2'/%3E%3Cline x1='14' x2='14.01' y1='2' y2='2'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-dessert{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='9' r='7'/%3E%3Cpath d='M12 16v7'/%3E%3Cpath d='M9 23h6'/%3E%3Cpath d='M19 9a7 7 0 1 1-14 0'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-fire{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e94560' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-2.072-2.143-2.072-4.286A5.002 5.002 0 0 0 12 2.005 5 5 0 0 0 17.005 7c0 2.144-1 2.144-2.072 4.286-.5 1-1 1.62-1 3a2.5 2.5 0 0 0 2.5 2.5c.667 0 1.167-.167 1.5-.5'/%3E%3Cpath d='M8.5 14.5c-1.5 1-2.5 2.5-2.5 4.5 0 3.5 3 6.5 6 7 3-.5 6-3.5 6-7 0-2-1-3.5-2.5-4.5'/%3E%3C/svg%3E") center/contain no-repeat;
}

.icon-empty{
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238a7b6b' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z'/%3E%3Cpath d='M3 6h18'/%3E%3Cpath d='M16 10a4 4 0 0 1-8 0'/%3E%3C/svg%3E") center/contain no-repeat;
}

/* ════════════════════════════════════════════════════════════ */
/* LOADING */
/* ════════════════════════════════════════════════════════════ */
#loading-screen{
  position:fixed;
  inset:0;
  background:var(--bg);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:9999;
  gap:20px;
}

.spinner{
  width:48px;
  height:48px;
  border:4px solid var(--border);
  border-top-color:var(--gold);
  border-radius:50%;
  animation:spin 0.9s linear infinite;
}

@keyframes spin{to{transform:rotate(360deg);}}

.loading-txt{
  font-size:0.9rem;
  color:var(--text-muted);
  letter-spacing:0.1em;
}

/* ════════════════════════════════════════════════════════════ */
/* LOGIN */
/* ════════════════════════════════════════════════════════════ */
#login-screen{
  position:fixed;
  inset:0;
  background:linear-gradient(135deg,var(--bg) 0%,var(--bg-warm) 100%);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

#login-screen.show{display:flex;animation:fadeIn 0.5s ease;}

.login-card{
  background:var(--surface);
  border-radius:20px;
  padding:48px 40px;
  box-shadow:var(--shadow-lg);
  width:100%;
  max-width:440px;
  text-align:center;
  border:1px solid var(--border);
  animation:slideUp 0.5s ease;
}

@keyframes slideUp{
  from{opacity:0;transform:translateY(30px);}
  to{opacity:1;transform:translateY(0);}
}

.login-logo{
  font-family:'Playfair Display',serif;
  font-size:2.6rem;
  color:var(--gold);
  margin-bottom:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
}

.login-sub{
  color:var(--text-muted);
  font-size:0.85rem;
  letter-spacing:0.15em;
  text-transform:uppercase;
  margin-bottom:40px;
}

.login-field{
  text-align:left;
  margin-bottom:20px;
}

.login-field label{
  display:block;
  font-size:0.75rem;
  font-weight:600;
  color:var(--text-secondary);
  letter-spacing:0.06em;
  text-transform:uppercase;
  margin-bottom:8px;
}

.login-field input{
  width:100%;
  padding:14px 16px;
  border:2px solid var(--border);
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-size:1rem;
  background:var(--bg);
  color:var(--text);
  transition:all var(--transition-base);
}

.login-field input:focus{
  outline:none;
  border-color:var(--gold);
  box-shadow:0 0 0 4px var(--gold-glow);
}

.login-btn{
  width:100%;
  padding:16px;
  background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);
  color:#fff;
  border:none;
  border-radius:12px;
  font-size:1rem;
  font-weight:600;
  cursor:pointer;
  font-family:'DM Sans',sans-serif;
  transition:all var(--transition-bounce);
  margin-top:12px;
  position:relative;
  overflow:hidden;
}

.login-btn::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,transparent,rgba(255,255,255,0.2),transparent);
  transform:translateX(-100%);
  transition:transform 0.6s;
}

.login-btn:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-md),var(--shadow-gold);
}

.login-btn:hover::before{
  transform:translateX(100%);
}

.login-btn:active{transform:scale(0.98);}

.login-err{
  color:var(--error);
  font-size:0.85rem;
  margin-top:16px;
  min-height:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}

/* ════════════════════════════════════════════════════════════ */
/* SYNC */
/* ════════════════════════════════════════════════════════════ */
.sync-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--success);
  display:inline-block;
  margin-right:6px;
  animation:pulse 2s infinite;
}

.sync-dot.offline{
  background:var(--error);
  animation:none;
}

@keyframes pulse{
  0%,100%{opacity:1;transform:scale(1);}
  50%{opacity:0.5;transform:scale(0.8);}
}

/* ════════════════════════════════════════════════════════════ */
/* HEADER */
/* ════════════════════════════════════════════════════════════ */
header{
  background:var(--surface);
  border-bottom:1px solid var(--border);
  padding:12px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:12px;
  position:sticky;
  top:0;
  z-index:100;
  box-shadow:var(--shadow-sm);
}

@media(min-width:768px){
  header{
    padding:0 32px;
    height:68px;
    flex-wrap:nowrap;
  }
}

.header-brand{
  display:flex;
  align-items:center;
  gap:12px;
}

.header-brand h1{
  font-family:'Playfair Display',serif;
  font-size:1.5rem;
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:10px;
}

.header-brand span{
  display:none;
  color:var(--text-muted);
  font-size:0.78rem;
  letter-spacing:0.1em;
  text-transform:uppercase;
}

@media(min-width:900px){
  .header-brand span{display:inline;}
}

.header-actions{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

#fecha-lbl{
  display:none;
  font-size:0.85rem;
  color:var(--text-muted);
}

@media(min-width:1000px){
  #fecha-lbl{display:inline;}
}

.user-pill{
  display:flex;
  align-items:center;
  gap:8px;
  background:var(--bg);
  border:1.5px solid var(--border);
  border-radius:100px;
  padding:6px 14px;
  font-size:0.85rem;
  transition:all var(--transition-base);
}

.user-pill:hover{
  border-color:var(--gold);
  box-shadow:var(--shadow-gold);
}

.role-badge{
  font-size:0.65rem;
  font-weight:700;
  padding:3px 10px;
  border-radius:20px;
  text-transform:uppercase;
  letter-spacing:0.05em;
}

.role-badge.admin{
  background:var(--gold-glow);
  color:var(--gold-dark);
  border:1px solid var(--gold);
}

.role-badge.mesero{
  background:rgba(74,111,165,0.12);
  color:var(--blue);
  border:1px solid var(--blue);
}

.role-badge.cocinero{
  background:rgba(233,69,96,0.1);
  color:#e94560;
  border:1px solid #e94560;
}

.btn-ghost{
  padding:10px 16px;
  border:1.5px solid var(--border);
  border-radius:10px;
  background:transparent;
  font-family:'DM Sans',sans-serif;
  font-size:0.85rem;
  font-weight:500;
  color:var(--text-secondary);
  cursor:pointer;
  transition:all var(--transition-base);
  display:flex;
  align-items:center;
  gap:6px;
}

.btn-ghost:hover{
  border-color:var(--gold);
  color:var(--gold-dark);
  background:var(--gold-glow);
  transform:translateY(-1px);
}

.btn-primary{
  padding:10px 20px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);
  color:#fff;
  font-family:'DM Sans',sans-serif;
  font-size:0.9rem;
  font-weight:600;
  cursor:pointer;
  transition:all var(--transition-bounce);
  display:flex;
  align-items:center;
  gap:6px;
}

.btn-primary:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-md),var(--shadow-gold);
}

.cierre-btn{
  background:var(--text);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  font-family:'DM Sans',sans-serif;
  font-weight:600;
  font-size:0.85rem;
  cursor:pointer;
  transition:all var(--transition-base);
  display:flex;
  align-items:center;
  gap:6px;
}

.cierre-btn:hover{
  background:var(--accent);
  transform:translateY(-1px);
}

/* ════════════════════════════════════════════════════════════ */
/* TABS */
/* ════════════════════════════════════════════════════════════ */
.tabs{
  display:flex;
  gap:4px;
  background:var(--surface);
  padding:16px 20px 0;
  border-bottom:1px solid var(--border);
  overflow-x:auto;
}

@media(min-width:768px){
  .tabs{padding:16px 32px 0;}
}

.tab{
  padding:12px 20px;
  border:none;
  background:transparent;
  font-family:'DM Sans',sans-serif;
  font-size:0.9rem;
  font-weight:500;
  color:var(--text-muted);
  cursor:pointer;
  white-space:nowrap;
  border-bottom:3px solid transparent;
  transition:all var(--transition-base);
  border-radius:10px 10px 0 0;
  display:flex;
  align-items:center;
  gap:8px;
}

.tab:hover{
  color:var(--text-secondary);
  background:var(--bg);
}

.tab.active{
  color:var(--gold-dark);
  border-bottom-color:var(--gold);
  font-weight:600;
  background:var(--gold-glow);
}

.tab.admin-only.active{
  color:var(--purple);
  border-bottom-color:var(--purple);
  background:rgba(123,104,238,0.08);
}

/* ════════════════════════════════════════════════════════════ */
/* MAIN */
/* ════════════════════════════════════════════════════════════ */
.main{
  padding:24px;
  margin:0 auto;
  max-width:1400px;
}

@media(min-width:768px){
  .main{padding:32px;}
}

.section-title{
  font-family:'Playfair Display',serif;
  font-size:1.4rem;
  color:var(--text);
  margin-bottom:24px;
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

.badge{
  font-family:'DM Sans',sans-serif;
  font-size:0.75rem;
  font-weight:600;
  padding:4px 12px;
  border-radius:20px;
  background:var(--gold-glow);
  color:var(--gold-dark);
  border:1px solid var(--gold);
  animation:fadeIn 0.3s ease;
}

/* ════════════════════════════════════════════════════════════ */
/* MESAS GRID */
/* ════════════════════════════════════════════════════════════ */
.mesas-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:16px;
}

@media(min-width:600px){
  .mesas-grid{
    grid-template-columns:repeat(3,1fr);
    gap:20px;
  }
}

@media(min-width:900px){
  .mesas-grid{
    grid-template-columns:repeat(4,1fr);
    gap:24px;
  }
}

@media(min-width:1200px){
  .mesas-grid{
    grid-template-columns:repeat(6,1fr);
    gap:24px;
  }
}

/* ════════════════════════════════════════════════════════════ */
/* TARJETA MESA */
/* ════════════════════════════════════════════════════════════ */
.mesa-card{
  background:var(--surface);
  border-radius:16px;
  border:2px solid var(--border);
  padding:20px;
  cursor:pointer;
  transition:all var(--transition-bounce);
  position:relative;
  overflow:hidden;
  min-height:140px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.mesa-card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:4px;
  background:var(--success);
  transition:all var(--transition-base);
}

.mesa-card.ocupada::before{
  background:var(--accent);
}

.mesa-card.ocupada{
  border-color:rgba(139,69,19,0.3);
  background:linear-gradient(135deg,var(--surface) 0%,rgba(139,69,19,0.03) 100%);
}

.mesa-card:hover{
  box-shadow:var(--shadow-lg);
  transform:translateY(-4px) scale(1.02);
  border-color:var(--gold);
}

.mesa-card:hover::before{
  background:var(--gold);
}

.mesa-num{
  font-family:'Playfair Display',serif;
  font-size:2.4rem;
  color:var(--text);
  font-weight:700;
  line-height:1;
}

@media(min-width:900px){
  .mesa-num{font-size:3rem;}
}

.mesa-label{
  font-size:0.7rem;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:var(--text-muted);
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:6px;
}

.mesa-status{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:0.75rem;
  font-weight:600;
  padding:4px 12px;
  border-radius:20px;
  text-transform:uppercase;
  letter-spacing:0.05em;
  transition:all var(--transition-base);
}

.mesa-status.libre{
  background:rgba(45,106,79,0.1);
  color:var(--success);
}

.mesa-status.ocupada{
  background:rgba(139,69,19,0.1);
  color:var(--accent);
}

.mesa-status::before{
  content:'';
  width:6px;
  height:6px;
  border-radius:50%;
  background:currentColor;
  animation:statusPulse 2s infinite;
}

@keyframes statusPulse{
  0%,100%{opacity:1;}
  50%{opacity:0.5;}
}

.mesa-mesero{
  font-size:0.8rem;
  color:var(--text-muted);
  margin-top:8px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  display:flex;
  align-items:center;
  gap:6px;
}

.mesa-total{
  font-size:1rem;
  font-weight:600;
  color:var(--text-secondary);
  margin-top:4px;
  font-family:'Playfair Display',serif;
}

.mesa-timer{
  font-size:0.85rem;
  font-weight:700;
  color:var(--warning);
  margin-top:6px;
  display:flex;
  align-items:center;
  gap:6px;
  font-variant-numeric:tabular-nums;
  transition:all var(--transition-base);
}

.mesa-timer.alerta{
  color:var(--error);
  animation:timerPulse 1s infinite;
}

@keyframes timerPulse{
  0%,100%{opacity:1;}
  50%{opacity:0.4;}
}

/* ════════════════════════════════════════════════════════════ */
/* MODAL */
/* ════════════════════════════════════════════════════════════ */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(44,36,27,0.6);
  z-index:200;
  display:none;
  align-items:flex-start;
  justify-content:center;
  padding:0;
  overflow-y:auto;
  backdrop-filter:blur(8px);
}

@media(min-width:600px){
  .modal-overlay{
    padding:24px;
    align-items:center;
  }
}

.modal-overlay.open{
  display:flex;
  animation:fadeIn 0.3s ease;
}

.modal{
  background:var(--surface);
  border-radius:0;
  width:100%;
  max-width:100%;
  box-shadow:var(--shadow-lg);
  animation:slideUpModal 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  margin:0;
  min-height:100vh;
  border:1px solid var(--border);
}

@media(min-width:600px){
  .modal{
    border-radius:24px;
    max-width:800px;
    margin:auto;
    min-height:unset;
    max-height:90vh;
    overflow:hidden;
  }
}

@keyframes slideUpModal{
  from{
    opacity:0;
    transform:translateY(40px) scale(0.95);
  }
  to{
    opacity:1;
    transform:translateY(0) scale(1);
  }
}

.modal-header{
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;
  top:0;
  background:var(--surface);
  z-index:10;
}

@media(min-width:600px){
  .modal-header{
    position:static;
    padding:24px 32px;
  }
}

.modal-title{
  font-family:'Playfair Display',serif;
  font-size:1.4rem;
  color:var(--text);
  display:flex;
  align-items:center;
  gap:10px;
}

.modal-close{
  width:40px;
  height:40px;
  border:none;
  background:var(--bg);
  border-radius:12px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all var(--transition-base);
}

.modal-close:hover{
  background:var(--border);
  transform:rotate(90deg);
}

.modal-body{
  padding:24px;
  max-height:calc(100vh - 80px);
  overflow-y:auto;
}

@media(min-width:600px){
  .modal-body{
    padding:32px;
    max-height:calc(90vh - 80px);
  }
}

/* ════════════════════════════════════════════════════════════ */
/* FORM */
/* ════════════════════════════════════════════════════════════ */
.field{
  margin-bottom:16px;
}

.field label{
  display:block;
  font-size:0.75rem;
  font-weight:600;
  color:var(--text-secondary);
  letter-spacing:0.05em;
  text-transform:uppercase;
  margin-bottom:8px;
}

.field input,
.field select{
  width:100%;
  padding:12px 16px;
  border:2px solid var(--border);
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-size:0.95rem;
  background:var(--bg);
  color:var(--text);
  transition:all var(--transition-base);
}

.field input:focus,
.field select:focus{
  outline:none;
  border-color:var(--gold);
  box-shadow:0 0 0 4px var(--gold-glow);
}

/* ════════════════════════════════════════════════════════════ */
/* CATEGORIAS */
/* ════════════════════════════════════════════════════════════ */
.cat-tabs{
  display:flex;
  gap:8px;
  margin-bottom:12px;
  flex-wrap:wrap;
}

.cat-tab{
  padding:8px 16px;
  border:2px solid var(--border);
  border-radius:100px;
  background:var(--bg);
  font-family:'DM Sans',sans-serif;
  font-size:0.8rem;
  font-weight:600;
  cursor:pointer;
  transition:all var(--transition-bounce);
  color:var(--text-secondary);
  display:flex;
  align-items:center;
  gap:6px;
}

.cat-tab:hover{
  border-color:var(--gold);
  color:var(--gold-dark);
  transform:translateY(-2px);
}

.cat-tab.active{
  color:#fff;
  border-color:transparent;
  transform:scale(1.05);
  box-shadow:var(--shadow-md);
}

.cat-tab[data-cat="todos"].active{
  background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);
}

.cat-tab[data-cat="bebida"].active{
  background:linear-gradient(135deg,var(--blue) 0%,#3d5a80 100%);
}

.cat-tab[data-cat="comida"].active{
  background:linear-gradient(135deg,var(--success) 0%,#1b4332 100%);
}

.cat-tab[data-cat="postre"].active{
  background:linear-gradient(135deg,var(--purple) 0%,#5a4fcf 100%);
}

/* ════════════════════════════════════════════════════════════ */
/* PEDIDO */
/* ════════════════════════════════════════════════════════════ */
.pedido-layout{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
}

@media(max-width:560px){
  .pedido-layout{grid-template-columns:1fr;}
}

.productos-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  max-height:320px;
  overflow-y:auto;
  padding-right:8px;
}

.producto-btn{
  padding:14px 12px;
  border:2px solid var(--border);
  border-radius:12px;
  background:var(--bg);
  cursor:pointer;
  font-family:'DM Sans',sans-serif;
  font-size:0.85rem;
  font-weight:500;
  color:var(--text-secondary);
  transition:all var(--transition-bounce);
  text-align:left;
  position:relative;
  overflow:hidden;
}

.producto-btn::before{
  content:'';
  position:absolute;
  inset:0;
  background:var(--gold-glow);
  opacity:0;
  transition:opacity var(--transition-fast);
}

.producto-btn:hover{
  border-color:var(--gold);
  color:var(--gold-dark);
  transform:translateY(-2px);
  box-shadow:var(--shadow-sm);
}

.producto-btn:hover::before{
  opacity:1;
}

.producto-btn .prod-name{
  font-weight:600;
  color:var(--text);
  display:block;
  position:relative;
  z-index:1;
}

.producto-btn .prod-price{
  color:var(--text-muted);
  font-size:0.8rem;
  position:relative;
  z-index:1;
}

.orden-panel{
  background:var(--bg);
  border-radius:16px;
  padding:20px;
  border:2px solid var(--border);
  position:sticky;
  top:20px;
}

.orden-panel h4{
  font-size:0.8rem;
  font-weight:700;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:8px;
  padding-bottom:12px;
  border-bottom:1px solid var(--border);
}

.orden-items{
  min-height:80px;
  max-height:260px;
  overflow-y:auto;
  padding-right:8px;
}

.orden-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid var(--border);
  transition:all var(--transition-fast);
}

.orden-item:last-child{
  border-bottom:none;
}

.orden-item:hover{
  transform:translateX(4px);
}

.orden-item-name{
  flex:1;
  color:var(--text);
  font-weight:500;
  font-size:0.9rem;
}

.orden-item-qty{
  display:flex;
  align-items:center;
  gap:8px;
}

.qty-btn{
  width:28px;
  height:28px;
  border:2px solid var(--border);
  border-radius:8px;
  background:var(--surface);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all var(--transition-base);
}

.qty-btn:hover{
  border-color:var(--gold);
  background:var(--gold-glow);
  transform:scale(1.1);
}

.qty-num{
  font-weight:700;
  width:24px;
  text-align:center;
  font-size:0.95rem;
  font-family:'Playfair Display',serif;
}

.orden-item-price{
  font-weight:600;
  min-width:90px;
  text-align:right;
  font-size:0.9rem;
  color:var(--text-secondary);
  font-family:'Playfair Display',serif;
}

.orden-total{
  border-top:2px solid var(--border);
  margin-top:16px;
  padding-top:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.total-amount{
  font-family:'Playfair Display',serif;
  font-size:1.6rem;
  color:var(--gold-dark);
  font-weight:700;
}

/* ════════════════════════════════════════════════════════════ */
/* CLIENTES */
/* ════════════════════════════════════════════════════════════ */
.cliente-item{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:12px;
  transition:all var(--transition-base);
}

.cliente-item:hover{
  border-color:var(--gold);
  transform:translateX(4px);
  box-shadow:var(--shadow-sm);
}

.cliente-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}

.cliente-num{
  font-family:'Playfair Display',serif;
  font-size:1rem;
  color:var(--accent);
  font-weight:700;
  display:flex;
  align-items:center;
  gap:6px;
}

.cliente-items-list{
  font-size:0.85rem;
  color:var(--text-muted);
  line-height:1.6;
}

.mesero-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:0.75rem;
  color:var(--text-muted);
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:4px 10px;
  margin-top:8px;
  transition:all var(--transition-fast);
}

.mesero-badge:hover{
  border-color:var(--gold);
  color:var(--gold-dark);
}

/* ════════════════════════════════════════════════════════════ */
/* ACCIONES MODAL */
/* ════════════════════════════════════════════════════════════ */
.modal-actions{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:24px;
  padding-top:24px;
  border-top:1px solid var(--border);
}

.btn-success{
  background:linear-gradient(135deg,var(--success) 0%,#1b4332 100%);
  color:#fff;
  border:none;
  padding:12px 24px;
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-weight:600;
  font-size:0.9rem;
  cursor:pointer;
  transition:all var(--transition-bounce);
  display:flex;
  align-items:center;
  gap:8px;
}

.btn-success:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(45,106,79,0.3);
}

.btn-danger{
  background:linear-gradient(135deg,var(--error) 0%,#a93226 100%);
  color:#fff;
  border:none;
  padding:12px 24px;
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-weight:600;
  font-size:0.9rem;
  cursor:pointer;
  transition:all var(--transition-bounce);
  display:flex;
  align-items:center;
  gap:8px;
}

.btn-danger:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(192,57,43,0.3);
}

.btn-warning{
  background:linear-gradient(135deg,var(--warning) 0%,var(--gold-dark) 100%);
  color:#fff;
  border:none;
  padding:12px 24px;
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-weight:600;
  font-size:0.9rem;
  cursor:pointer;
  transition:all var(--transition-bounce);
  display:flex;
  align-items:center;
  gap:8px;
}

.btn-warning:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(201,168,76,0.3);
}

.btn-blue{
  background:linear-gradient(135deg,var(--blue) 0%,#3d5a80 100%);
  color:#fff;
  border:none;
  padding:12px 24px;
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-weight:600;
  font-size:0.9rem;
  cursor:pointer;
  transition:all var(--transition-bounce);
  display:flex;
  align-items:center;
  gap:8px;
}

.btn-blue:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(74,111,165,0.3);
}

/* ════════════════════════════════════════════════════════════ */
/* PRODUCTOS ADMIN */
/* ════════════════════════════════════════════════════════════ */
.add-prod-form{
  background:var(--bg);
  border:2px solid var(--border);
  border-radius:16px;
  padding:24px;
  margin-bottom:24px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  align-items:end;
}

@media(min-width:700px){
  .add-prod-form{
    grid-template-columns:2fr 1fr 1fr auto;
  }
}

@media(max-width:500px){
  .add-prod-form{
    grid-template-columns:1fr;
  }
}

.productos-admin{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:16px;
}

.prod-card{
  background:var(--surface);
  border-radius:16px;
  border:2px solid var(--border);
  padding:20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  transition:all var(--transition-bounce);
}

.prod-card:hover{
  border-color:var(--gold);
  transform:translateY(-3px);
  box-shadow:var(--shadow-md);
}

.pname{
  font-weight:600;
  color:var(--text);
  font-size:1rem;
  margin-bottom:4px;
}

.pprice{
  font-size:0.9rem;
  color:var(--text-muted);
  font-family:'Playfair Display',serif;
}

.pcat{
  font-size:0.75rem;
  font-weight:700;
  padding:4px 12px;
  border-radius:20px;
  margin-top:8px;
  display:inline-flex;
  align-items:center;
  gap:4px;
  text-transform:uppercase;
  letter-spacing:0.05em;
}

.pcat.bebida{
  background:rgba(74,111,165,0.1);
  color:var(--blue);
  border:1px solid var(--blue);
}

.pcat.comida{
  background:rgba(45,106,79,0.1);
  color:var(--success);
  border:1px solid var(--success);
}

.pcat.postre{
  background:rgba(123,104,238,0.1);
  color:var(--purple);
  border:1px solid var(--purple);
}

.prod-card-actions{
  display:flex;
  gap:8px;
}

.icon-btn{
  width:40px;
  height:40px;
  border:2px solid var(--border);
  border-radius:10px;
  background:var(--surface);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all var(--transition-base);
}

.icon-btn:hover{
  border-color:var(--gold);
  background:var(--gold-glow);
  transform:scale(1.1);
}

/* ════════════════════════════════════════════════════════════ */
/* HISTORIAL */
/* ════════════════════════════════════════════════════════════ */
.report-summary{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:16px;
  margin-bottom:24px;
}

@media(min-width:600px){
  .report-summary{
    grid-template-columns:repeat(3,1fr);
    gap:20px;
    margin-bottom:32px;
  }
}

.stat-card{
  background:var(--surface);
  border-radius:16px;
  border:2px solid var(--border);
  padding:24px;
  transition:all var(--transition-base);
}

.stat-card:hover{
  border-color:var(--gold);
  transform:translateY(-2px);
  box-shadow:var(--shadow-sm);
}

.stat-val{
  font-family:'Playfair Display',serif;
  font-size:2rem;
  color:var(--gold-dark);
  font-weight:700;
}

@media(min-width:600px){
  .stat-val{font-size:2.4rem;}
}

.stat-lbl{
  font-size:0.75rem;
  text-transform:uppercase;
  letter-spacing:0.08em;
  color:var(--text-muted);
  margin-top:6px;
  font-weight:500;
}

.table-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  background:var(--surface);
  border-radius:16px;
  border:2px solid var(--border);
  box-shadow:var(--shadow-sm);
}

.history-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:0.9rem;
  min-width:600px;
}

.history-table th{
  padding:16px;
  text-align:left;
  border-bottom:2px solid var(--border);
  font-size:0.75rem;
  text-transform:uppercase;
  letter-spacing:0.08em;
  color:var(--text-muted);
  font-weight:700;
  background:var(--bg);
}

.history-table td{
  padding:14px 16px;
  border-bottom:1px solid var(--border);
  color:var(--text-secondary);
  transition:all var(--transition-fast);
}

.history-table tr:hover td{
  background:var(--bg);
  color:var(--text);
}

.history-table .total-row td{
  font-weight:700;
  color:var(--text);
  border-top:2px solid var(--border);
  border-bottom:none;
  background:var(--gold-glow);
}

.empty-state{
  text-align:center;
  padding:60px 24px;
  color:var(--text-muted);
}

.empty-state .icon{
  width:64px;
  height:64px;
  margin-bottom:16px;
  opacity:0.5;
}

/* ════════════════════════════════════════════════════════════ */
/* ADMIN PANEL */
/* ════════════════════════════════════════════════════════════ */
.admin-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:24px;
}

@media(min-width:900px){
  .admin-grid{
    grid-template-columns:1fr 1fr;
    gap:32px;
  }
}

.admin-card{
  background:var(--surface);
  border-radius:20px;
  border:2px solid var(--border);
  overflow:hidden;
  transition:all var(--transition-base);
}

.admin-card:hover{
  box-shadow:var(--shadow-md);
}

.admin-card-header{
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--bg);
}

.admin-card-title{
  font-family:'Playfair Display',serif;
  font-size:1.2rem;
  color:var(--text);
  display:flex;
  align-items:center;
  gap:10px;
}

.admin-card-body{
  padding:24px;
}

.user-list{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-top:8px;
}

.user-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  transition:all var(--transition-base);
}

.user-item:hover{
  border-color:var(--gold);
  transform:translateX(4px);
}

.user-info .uname{
  font-weight:600;
  color:var(--text);
  font-size:0.95rem;
  display:flex;
  align-items:center;
  gap:8px;
}

.user-info .ufull{
  font-size:0.8rem;
  color:var(--text-muted);
  margin-top:4px;
}

.user-item-actions{
  display:flex;
  gap:8px;
  align-items:center;
}

.add-user-form{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  margin-bottom:16px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}

@media(max-width:500px){
  .add-user-form{grid-template-columns:1fr;}
}

.activity-list{
  display:flex;
  flex-direction:column;
  gap:12px;
  max-height:400px;
  overflow-y:auto;
  padding-right:8px;
}

.activity-item{
  display:flex;
  gap:16px;
  padding:16px 0;
  border-bottom:1px solid var(--border);
  transition:all var(--transition-fast);
}

.activity-item:last-child{
  border-bottom:none;
}

.activity-item:hover{
  transform:translateX(4px);
}

.activity-dot{
  width:10px;
  height:10px;
  border-radius:50%;
  margin-top:6px;
  flex-shrink:0;
  animation:pulse 2s infinite;
}

.activity-dot.accion-pedido{background:var(--success);}
.activity-dot.accion-pago{background:var(--warning);}
.activity-dot.accion-login{background:var(--blue);}
.activity-dot.accion-producto{background:var(--purple);}
.activity-dot.accion-admin{background:var(--accent);}

.activity-content{flex:1;}

.activity-msg{
  font-size:0.9rem;
  color:var(--text-secondary);
  line-height:1.5;
}

.activity-user{
  font-weight:600;
  color:var(--text);
}

.activity-meta{
  font-size:0.8rem;
  color:var(--text-muted);
  margin-top:4px;
  display:flex;
  align-items:center;
  gap:8px;
}

/* ════════════════════════════════════════════════════════════ */
/* BOTTOM NAV MÓVIL */
/* ════════════════════════════════════════════════════════════ */
.bottom-nav{
  display:none;
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--surface);
  border-top:2px solid var(--border);
  z-index:150;
  box-shadow:0 -4px 20px rgba(44,36,27,0.08);
}

.bottom-nav-inner{
  display:flex;
  align-items:stretch;
}

.bnav-btn{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:12px 4px;
  border:none;
  background:transparent;
  cursor:pointer;
  font-family:'DM Sans',sans-serif;
  font-size:0.65rem;
  font-weight:600;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:0.05em;
  gap:6px;
  transition:all var(--transition-base);
  min-height:64px;
}

.bnav-btn .icon{
  width:24px;
  height:24px;
  transition:all var(--transition-base);
}

.bnav-btn.active{
  color:var(--gold-dark);
  background:var(--gold-glow);
}

.bnav-btn.active .icon{
  stroke:var(--gold);
  transform:translateY(-2px);
}

.bnav-btn.admin-nav.active{
  color:var(--purple);
  background:rgba(123,104,238,0.08);
}

@media(max-width:767px){
  .tabs{display:none!important;}
  .bottom-nav{display:block!important;}
  .main{padding-bottom:80px!important;}
}

@media(min-width:768px){
  .bottom-nav{display:none!important;}
  .tabs{display:flex!important;}
}

/* ════════════════════════════════════════════════════════════ */
/* TICKET - 80mm EXACTO */
/* ════════════════════════════════════════════════════════════ */
#ticket-print{display:none;}

@media print{
  @page{
    size:80mm auto;
    margin:0;
  }
  *{
    -webkit-print-color-adjust:exact!important;
    color-adjust:exact!important;
    print-color-adjust:exact!important;
  }
  body>*:not(#ticket-print){display:none!important;}
  #ticket-print{
    display:block!important;
    position:fixed;
    inset:0;
    background:#fff;
    z-index:99999;
  }
}

.ticket-wrap{
  width:72mm;
  max-width:302px;
  margin:0 auto;
  font-family:'Courier New',Courier,monospace;
  font-size:11pt;
  line-height:1.5;
  color:#000;
  background:#fff;
  padding:3mm 4mm;
}

.ticket-title{
  text-align:center;
  font-size:15pt;
  font-weight:900;
  letter-spacing:2px;
  margin-bottom:0;
  font-family:'Playfair Display',serif;
}

.ticket-sub{
  text-align:center;
  font-size:9pt;
  margin-bottom:4mm;
  color:#444;
}

.ticket-div{
  border:none;
  border-top:1px dashed #000;
  margin:3mm 0;
  width:100%;
}

.ticket-row{
  display:flex;
  justify-content:space-between;
  margin:1mm 0;
  font-size:10pt;
}

.ticket-row.bold{font-weight:700;}

.ticket-row.total{
  font-weight:900;
  font-size:13pt;
  border-top:2px solid #000;
  margin-top:3mm;
  padding-top:2mm;
}

.ticket-center{
  text-align:center;
  font-size:9pt;
  margin-top:4mm;
  color:#555;
}

.ticket-cat-hdr{
  font-size:9pt;
  font-weight:700;
  margin-top:4mm;
  margin-bottom:1mm;
  text-transform:uppercase;
  letter-spacing:1px;
  border-bottom:1px solid #ccc;
  padding-bottom:1mm;
}

.ticket-item-name{
  flex:1;
  padding-right:4mm;
  word-break:break-word;
}

.ticket-item-price{
  white-space:nowrap;
  text-align:right;
  font-weight:700;
}

.ticket-corte{
  border:none;
  border-top:2px dashed #000;
  margin:6mm 0 0;
  width:100%;
}

/* ════════════════════════════════════════════════════════════ */
/* VISTA COCINERO */
/* ════════════════════════════════════════════════════════════ */
#cocina-app{display:none;}

#cocina-app.show{
  display:flex;
  flex-direction:column;
  min-height:100vh;
  background:#0f0f1a;
}

.cocina-header{
  background:#1a1a2e;
  border-bottom:2px solid #2a2a4a;
  padding:16px 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;
  top:0;
  z-index:100;
}

.cocina-brand{
  display:flex;
  align-items:center;
  gap:16px;
}

.cocina-logo{
  font-family:'Playfair Display',serif;
  font-size:1.6rem;
  color:#e94560;
  display:flex;
  align-items:center;
  gap:10px;
}

.cocina-subtitle{
  font-size:0.8rem;
  letter-spacing:0.15em;
  text-transform:uppercase;
  color:#a0a0b0;
}

.cocina-user-pill{
  background:rgba(233,69,96,0.15);
  border:1.5px solid rgba(233,69,96,0.3);
  border-radius:100px;
  padding:8px 16px;
  font-size:0.85rem;
  color:#e94560;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
}

.cocina-salir{
  padding:10px 18px;
  background:transparent;
  border:2px solid #2a2a4a;
  border-radius:10px;
  color:#a0a0b0;
  font-family:'DM Sans',sans-serif;
  font-size:0.85rem;
  cursor:pointer;
  transition:all var(--transition-base);
  display:flex;
  align-items:center;
  gap:8px;
}

.cocina-salir:hover{
  border-color:#e94560;
  color:#e94560;
}

.cocina-hist-btn{
  padding:10px 18px;
  background:rgba(233,69,96,0.12);
  border:2px solid rgba(233,69,96,0.35);
  border-radius:10px;
  color:#e94560;
  font-family:'DM Sans',sans-serif;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  transition:all var(--transition-base);
  display:flex;
  align-items:center;
  gap:8px;
}

.cocina-hist-btn:hover{
  background:rgba(233,69,96,0.22);
  border-color:#e94560;
}

.cocina-main{
  padding:24px;
  flex:1;
}

@media(min-width:768px){
  .cocina-main{padding:32px;}
}

.cocina-titulo{
  font-family:'Playfair Display',serif;
  font-size:1.8rem;
  color:#eaeaea;
  margin-bottom:24px;
  display:flex;
  align-items:center;
  gap:16px;
}

.cocina-badge{
  background:#e94560;
  color:#fff;
  font-size:0.85rem;
  font-weight:700;
  padding:6px 16px;
  border-radius:100px;
  animation:pulse 2s infinite;
}

/* SIEMPRE 5 tarjetas máx en pantalla */
.cocina-grid{
  display:grid;
  gap:20px;
  grid-template-columns:1fr;
}

@media(min-width:500px){
  .cocina-grid{grid-template-columns:repeat(2,1fr);}
}

@media(min-width:900px){
  .cocina-grid{
    grid-template-columns:repeat(3,1fr);
    gap:24px;
  }
}

@media(min-width:1300px){
  .cocina-grid{
    grid-template-columns:repeat(5,1fr);
    gap:24px;
  }
}

/* Tarjeta cocina */
.cocina-card{
  background:#1a1a2e;
  border:2px solid #2a2a4a;
  border-radius:20px;
  overflow:hidden;
  transition:all var(--transition-bounce);
  position:relative;
}

.cocina-card.nueva{
  border-color:#e94560;
  box-shadow:0 0 30px rgba(233,69,96,0.3);
  animation:pulseCard 2s ease-in-out infinite;
}

@keyframes pulseCard{
  0%,100%{box-shadow:0 0 30px rgba(233,69,96,0.3);}
  50%{box-shadow:0 0 50px rgba(233,69,96,0.5);}
}

.cocina-card-header{
  padding:20px 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(255,255,255,0.03);
}

.cocina-mesa-num{
  font-family:'Playfair Display',serif;
  font-size:2.8rem;
  font-weight:700;
  color:#eaeaea;
  line-height:1;
}

.cocina-mesa-lbl{
  font-size:0.75rem;
  letter-spacing:0.15em;
  text-transform:uppercase;
  color:#a0a0b0;
  margin-bottom:4px;
}

.cocina-timer-big{
  font-size:1.1rem;
  font-weight:700;
  color:#00d4aa;
  font-variant-numeric:tabular-nums;
  display:flex;
  align-items:center;
  gap:8px;
}

.cocina-timer-big.alerta{
  color:#e94560;
  animation:alertPulse 1s infinite;
}

@keyframes alertPulse{
  0%,100%{opacity:1;}
  50%{opacity:0.5;}
}

.cocina-card-body{
  padding:20px 24px 24px;
}

.cocina-items-list{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.cocina-item{
  display:flex;
  align-items:center;
  gap:16px;
  padding:14px 18px;
  background:rgba(255,255,255,0.05);
  border-radius:12px;
  border-left:4px solid #00d4aa;
  transition:all var(--transition-fast);
}

.cocina-item:hover{
  background:rgba(255,255,255,0.08);
  transform:translateX(4px);
}

.cocina-item-qty{
  font-family:'Playfair Display',serif;
  font-size:2rem;
  font-weight:700;
  color:#e94560;
  min-width:48px;
  text-align:center;
  line-height:1;
}

.cocina-item-name{
  font-size:1.1rem;
  font-weight:600;
  color:#eaeaea;
}

.cocina-item-cat{
  font-size:0.75rem;
  letter-spacing:0.1em;
  text-transform:uppercase;
  color:#a0a0b0;
  margin-top:2px;
}

.cocina-card-footer{
  padding:16px 24px 20px;
  border-top:1px solid #2a2a4a;
}

.cocina-mesero{
  font-size:0.9rem;
  color:#a0a0b0;
  display:flex;
  align-items:center;
  gap:8px;
}

.cocina-empty{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:100px 24px;
  color:#a0a0b0;
  text-align:center;
}

.cocina-empty-icon{
  width:80px;
  height:80px;
  margin-bottom:24px;
  opacity:0.3;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b0' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'/%3E%3Cpath d='M7 2v20'/%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'/%3E%3C/svg%3E") center/contain no-repeat;
}

.cocina-empty-txt{
  font-size:1.2rem;
  opacity:0.7;
}

/* ════════════════════════════════════════════════════════════ */
/* TOAST */
/* ════════════════════════════════════════════════════════════ */
.toast{
  position:fixed;
  bottom:90px;
  right:24px;
  background:var(--surface);
  border:2px solid var(--gold);
  color:var(--text);
  padding:16px 24px;
  border-radius:16px;
  font-size:0.95rem;
  z-index:9999;
  animation:toastSlide 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  box-shadow:var(--shadow-lg),var(--shadow-gold);
  max-width:360px;
  display:flex;
  align-items:center;
  gap:12px;
  backdrop-filter:blur(10px);
}

@media(min-width:768px){
  .toast{
    bottom:32px;
    right:32px;
  }
}

@keyframes toastSlide{
  from{
    opacity:0;
    transform:translateX(100%) scale(0.8);
  }
  to{
    opacity:1;
    transform:translateX(0) scale(1);
  }
}

.toast::before{
  content:'';
  width:24px;
  height:24px;
  background:var(--gold);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E");
  background-size:14px;
  background-position:center;
  background-repeat:no-repeat;
}

::-webkit-scrollbar{
  width:8px;
  height:8px;
}

::-webkit-scrollbar-track{
  background:var(--bg);
}

::-webkit-scrollbar-thumb{
  background:var(--border);
  border-radius:4px;
}

::-webkit-scrollbar-thumb:hover{
  background:var(--gold);
}

.hidden{display:none!important;}

/* Animaciones generales */
@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}

::selection{
  background:var(--gold);
  color:#fff;
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="spinner"></div>
  <div class="loading-txt">Conectando con Firebase...</div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <span class="icon icon-logo icon-xl"></span>
      Delicias
    </div>
    <div class="login-sub">Administrador de Mesas</div>
    <div class="login-field">
      <label>Usuario</label>
      <input type="text" id="inp-user" placeholder="usuario" autocomplete="username"/>
    </div>
    <div class="login-field">
      <label>Contraseña</label>
      <input type="password" id="inp-pass" placeholder="••••••" autocomplete="current-password"/>
    </div>
    <button class="login-btn" onclick="doLogin()">
      <span class="icon icon-check icon-sm"></span>
      Ingresar
    </button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- TICKET (solo impresión) -->
<div id="ticket-print"></div>

<!-- ════════════════════════════════════════════════════════════ -->
<!-- APP NORMAL (Admin / Mesero)                               -->
<!-- ════════════════════════════════════════════════════════════ -->
<div id="app" class="hidden">
  <header>
    <div class="header-brand">
      <h1>
        <span class="icon icon-logo"></span>
        Delicias
      </h1>
      <span>Administrador de Mesas</span>
    </div>
    <div class="header-actions">
      <span>
        <span class="sync-dot" id="sync-dot"></span>
        <span id="sync-txt" style="font-size:0.8rem;color:var(--text-muted)">En línea</span>
      </span>
      <span id="fecha-lbl"></span>
      <div class="user-pill">
        <span class="icon icon-user icon-sm"></span>
        <span id="header-username">—</span>
        <span class="role-badge" id="header-role">—</span>
      </div>
      <button class="btn-ghost" id="btn-cierre" onclick="cierreCaja()">
        <span class="icon icon-dollar"></span>
        Cierre de Caja
      </button>
      <button class="btn-ghost" onclick="doLogout()">
        <span class="icon icon-logout"></span>
        Salir
      </button>
    </div>
  </header>

  <div class="tabs" id="tabs-bar">
    <button class="tab active" onclick="setTab('mesas',this)">
      <span class="icon icon-table"></span>
      Mesas
    </button>
    <button class="tab" onclick="setTab('productos',this)">
      <span class="icon icon-products"></span>
      Productos
    </button>
    <button class="tab" onclick="setTab('historial',this)">
      <span class="icon icon-history"></span>
      Historial
    </button>
    <button class="tab admin-only hidden" id="tab-admin-btn" onclick="setTab('admin',this)">
      <span class="icon icon-admin"></span>
      Admin
    </button>
  </div>

  <div class="main">
    <!-- MESAS -->
    <div id="tab-mesas">
      <div class="section-title">
        Mesas del Restaurante
        <span class="badge" id="badge-mesas">0 ocupadas</span>
      </div>
      <div class="mesas-grid" id="mesas-grid"></div>
    </div>

    <!-- PRODUCTOS -->
    <div id="tab-productos" class="hidden">
      <div class="section-title">Gestión de Productos</div>
      <div id="add-prod-wrap">
        <div class="add-prod-form">
          <div class="field" style="margin:0">
            <label>Nombre</label>
            <input type="text" id="prod-nombre" placeholder="Ej: Mojito"/>
          </div>
          <div class="field" style="margin:0">
            <label>Precio (Gs.)</label>
            <input type="number" id="prod-precio" placeholder="0" step="1" min="0"/>
          </div>
          <div class="field" style="margin:0">
            <label>Categoría</label>
            <select id="prod-cat">
              <option value="comida">Comida</option>
              <option value="bebida">Bebida</option>
              <option value="postre">Postre</option>
            </select>
          </div>
          <button class="btn-primary" onclick="agregarProducto()" style="height:46px;align-self:end">
            <span class="icon icon-plus"></span>
            Añadir
          </button>
        </div>
      </div>
      <div class="productos-admin" id="productos-admin-list"></div>
    </div>

    <!-- HISTORIAL -->
    <div id="tab-historial" class="hidden">
      <div class="section-title">Historial de Ventas — Noche</div>
      <div class="report-summary">
        <div class="stat-card">
          <div class="stat-val" id="stat-clientes">0</div>
          <div class="stat-lbl">Clientes Atendidos</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-mesas-h">0</div>
          <div class="stat-lbl">Mesas Usadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-total">Gs. 0</div>
          <div class="stat-lbl">Ingreso Total</div>
        </div>
      </div>
      <div class="table-wrap">
        <div id="historial-container"></div>
      </div>
      <div id="btn-limpiar-wrap" style="margin-top:16px;text-align:right;display:none">
        <button class="btn-danger" onclick="limpiarHistorial()">
          <span class="icon icon-trash"></span>
          Limpiar historial de noche
        </button>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="tab-admin" class="hidden">
      <div class="section-title">
        <span class="icon icon-admin"></span>
        Panel de Administración
      </div>
      <div class="admin-grid">
        <div class="admin-card">
          <div class="admin-card-header">
            <span class="admin-card-title">
              <span class="icon icon-user"></span>
              Usuarios del Sistema
            </span>
            <button class="btn-primary" onclick="toggleAddUser()" style="font-size:0.8rem;padding:8px 14px">
              <span class="icon icon-plus icon-sm"></span>
              Nuevo
            </button>
          </div>
          <div class="admin-card-body">
            <div id="add-user-wrap-panel" class="hidden">
              <div class="add-user-form">
                <div class="field" style="margin:0">
                  <label>Nombre completo</label>
                  <input type="text" id="nu-nombre" placeholder="Ej: Juan Pérez"/>
                </div>
                <div class="field" style="margin:0">
                  <label>Usuario</label>
                  <input type="text" id="nu-user" placeholder="juanp"/>
                </div>
                <div class="field" style="margin:0">
                  <label>Contraseña</label>
                  <input type="password" id="nu-pass" placeholder="••••••"/>
                </div>
                <div class="field" style="margin:0">
                  <label>Confirmar</label>
                  <input type="password" id="nu-pass2" placeholder="••••••"/>
                </div>
                <div class="field" style="margin:0;grid-column:1/-1">
                  <label>Rol</label>
                  <select id="nu-role" style="width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:0.95rem;background:var(--bg);color:var(--text);">
                    <option value="mesero">Mesero</option>
                    <option value="cocinero">Cocinero/a</option>
                  </select>
                </div>
              </div>
              <div style="display:flex;gap:12px;margin-bottom:16px;">
                <button class="btn-success" onclick="crearUsuario()">
                  <span class="icon icon-check icon-sm"></span>
                  Crear
                </button>
                <button class="btn-ghost" onclick="toggleAddUser()">Cancelar</button>
              </div>
            </div>
            <div class="user-list" id="users-list"></div>
          </div>
        </div>
        <div>
          <div class="admin-card" style="margin-bottom:24px;">
            <div class="admin-card-header">
              <span class="admin-card-title">
                <span class="sync-dot" style="margin-right:4px;"></span>
                Usuarios Conectados Ahora
              </span>
            </div>
            <div class="admin-card-body">
              <div id="presencia-panel"><div style="color:var(--text-muted);font-size:0.85rem;">Cargando...</div></div>
            </div>
          </div>
          <div class="admin-card">
            <div class="admin-card-header">
              <span class="admin-card-title">
                <span class="icon icon-activity"></span>
                Registro de Actividad
              </span>
              <button class="btn-ghost" onclick="limpiarActividad()" style="font-size:0.8rem;padding:6px 12px">
                Limpiar
              </button>
            </div>
            <div class="admin-card-body">
              <div class="activity-list" id="activity-list">
                <div class="empty-state">
                  <span class="icon icon-empty icon-xl"></span>
                  <p>Sin actividad.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NAV INFERIOR MÓVIL -->
<div class="bottom-nav" id="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="bnav-btn active" id="bnav-mesas" onclick="setTabMobile('mesas',this)">
      <span class="icon icon-table"></span>
      Mesas
    </button>
    <button class="bnav-btn" id="bnav-productos" onclick="setTabMobile('productos',this)">
      <span class="icon icon-products"></span>
      Productos
    </button>
    <button class="bnav-btn" id="bnav-historial" onclick="setTabMobile('historial',this)">
      <span class="icon icon-history"></span>
      Historial
    </button>
    <button class="bnav-btn admin-nav hidden" id="bnav-admin" onclick="setTabMobile('admin',this)">
      <span class="icon icon-admin"></span>
      Admin
    </button>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════ -->
<!-- APP COCINA (Cocinero/a)                                   -->
<!-- ════════════════════════════════════════════════════════════ -->
<div id="cocina-app">
  <div class="cocina-header">
    <div class="cocina-brand">
      <div>
        <div class="cocina-logo">
          <span class="icon icon-fire icon-lg"></span>
          Cocina
        </div>
        <div class="cocina-subtitle">Delicias — Pedidos activos</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <span>
        <span class="sync-dot" id="sync-dot-cocina"></span>
        <span id="sync-txt-cocina" style="font-size:0.8rem;color:#a0a0b0">En línea</span>
      </span>
      <div class="cocina-user-pill" id="cocina-user-lbl">
        <span class="icon icon-chef icon-sm"></span>
        —
      </div>
      <button class="cocina-hist-btn" onclick="abrirHistorialCocina()">
        <span class="icon icon-history icon-sm"></span>
        Pedidos Anteriores
      </button>
      <button class="cocina-salir" onclick="doLogout()">
        <span class="icon icon-logout icon-sm"></span>
        Salir
      </button>
    </div>
  </div>

  <div class="cocina-main">
    <div class="cocina-titulo">
      Pedidos de Comida
      <span class="cocina-badge" id="cocina-badge">0 mesas</span>
    </div>
    <div class="cocina-grid" id="cocina-grid">
      <div class="cocina-empty">
        <div class="cocina-empty-icon"></div>
        <div class="cocina-empty-txt">Sin pedidos activos</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL MESA -->
<div class="modal-overlay" id="modal-mesa">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modal-title">
          <span class="icon icon-table"></span>
          Mesa 1
        </div>
        <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px" id="modal-subtitle"></div>
      </div>
      <button class="modal-close" onclick="cerrarModal()">
        <span class="icon icon-x"></span>
      </button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Mesero responsable</label>
        <input type="text" id="inp-mesero" readonly style="background:var(--bg);cursor:default"/>
      </div>
      <div class="pedido-layout">
        <div>
          <div style="font-size:0.8rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px;">
            Productos
          </div>
          <div class="cat-tabs" id="cat-tabs-modal">
            <button class="cat-tab active" data-cat="todos" onclick="filtrarCat('todos',this)">
              <span class="icon icon-utensils icon-sm"></span>
              Todos
            </button>
            <button class="cat-tab" data-cat="bebida" onclick="filtrarCat('bebida',this)">
              <span class="icon icon-drink icon-sm"></span>
              Bebidas
            </button>
            <button class="cat-tab" data-cat="comida" onclick="filtrarCat('comida',this)">
              <span class="icon icon-food icon-sm"></span>
              Comidas
            </button>
            <button class="cat-tab" data-cat="postre" onclick="filtrarCat('postre',this)">
              <span class="icon icon-dessert icon-sm"></span>
              Postres
            </button>
          </div>
          <div class="productos-grid" id="productos-grid"></div>
        </div>
        <div>
          <div class="orden-panel">
            <h4>
              <span class="icon icon-receipt icon-sm"></span>
              Pedido actual
            </h4>
            <div class="orden-items" id="orden-items">
              <div style="color:var(--text-muted);font-size:0.9rem;padding:12px 0">Sin productos</div>
            </div>
            <div class="orden-total">
              <span style="font-weight:600;color:var(--text-secondary);font-size:0.9rem">Total</span>
              <span class="total-amount" id="pedido-total">Gs. 0</span>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:24px;">
        <div style="font-size:0.8rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;">
          Clientes esta noche en esta mesa
        </div>
        <div id="clientes-mesa-list"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-success" onclick="confirmarPedido()">
          <span class="icon icon-check"></span>
          Confirmar pedido
        </button>
        <button class="btn-warning" onclick="marcarPagado()">
          <span class="icon icon-dollar"></span>
          Pagado — Liberar
        </button>
        <button class="btn-blue" onclick="verHistorialMesa()">
          <span class="icon icon-history"></span>
          Historial
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR PRODUCTO -->
<div class="modal-overlay" id="modal-edit-prod">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon icon-edit"></span>
        Editar Producto
      </div>
      <button class="modal-close" onclick="cerrarEditProd()">
        <span class="icon icon-x"></span>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-prod-id"/>
      <div class="field">
        <label>Nombre</label>
        <input type="text" id="edit-prod-nombre"/>
      </div>
      <div class="field">
        <label>Precio (Gs.)</label>
        <input type="number" id="edit-prod-precio" step="1" min="0"/>
      </div>
      <div class="field">
        <label>Categoría</label>
        <select id="edit-prod-cat">
          <option value="comida">Comida</option>
          <option value="bebida">Bebida</option>
          <option value="postre">Postre</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <button class="btn-primary" onclick="guardarEditProd()">
          <span class="icon icon-check"></span>
          Guardar
        </button>
        <button class="btn-ghost" onclick="cerrarEditProd()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL COCINA -->
<div class="modal-overlay" id="modal-hist-cocina" style="z-index:300;">
  <div class="modal" style="max-width:720px;background:#1a1a2e;border:2px solid #2a2a4a;">
    <div class="modal-header" style="background:#1a1a2e;border-bottom:2px solid #2a2a4a;">
      <div class="modal-title" style="color:#eaeaea;font-family:'Playfair Display',serif;">
        <span class="icon icon-history"></span>
        Pedidos Anteriores — Cocina
      </div>
      <button class="modal-close" style="background:rgba(255,255,255,0.1);color:#a0a0b0;" onclick="$('modal-hist-cocina').classList.remove('open')">
        <span class="icon icon-x"></span>
      </button>
    </div>
    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
      <div id="hist-cocina-body"></div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL MESA -->
<div class="modal-overlay" id="modal-hist-mesa">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <div class="modal-title" id="hist-mesa-title">
        <span class="icon icon-history"></span>
        Historial Mesa
      </div>
      <button class="modal-close" onclick="$('modal-hist-mesa').classList.remove('open')">
        <span class="icon icon-x"></span>
      </button>
    </div>
    <div class="modal-body"><div id="hist-mesa-body"></div></div>
  </div>
</div>

<!-- MODAL CAMBIAR CONTRASEÑA -->
<div class="modal-overlay" id="modal-cambiar-pass">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon icon-key"></span>
        Cambiar Contraseña
      </div>
      <button class="modal-close" onclick="$('modal-cambiar-pass').classList.remove('open')">
        <span class="icon icon-x"></span>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="cp-user-id"/>
      <div id="cp-user-name" style="font-weight:600;color:var(--text-secondary);margin-bottom:16px;font-size:1rem;display:flex;align-items:center;gap:8px;">
        <span class="icon icon-user icon-sm"></span>
      </div>
      <div class="field">
        <label>Nueva contraseña</label>
        <input type="password" id="cp-pass"/>
      </div>
      <div class="field">
        <label>Confirmar</label>
        <input type="password" id="cp-pass2"/>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <button class="btn-primary" onclick="guardarNuevaPass()">
          <span class="icon icon-check"></span>
          Guardar
        </button>
        <button class="btn-ghost" onclick="$('modal-cambiar-pass').classList.remove('open')">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp }  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, runTransaction, onDisconnect, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyCdKSf2g1cIyXrD6k_u1aR9TMln9HaPJro",
  authDomain:"delicia-restaurante.firebaseapp.com",
  databaseURL:"https://delicia-restaurante-default-rtdb.firebaseio.com",
  projectId:"delicia-restaurante",
  storageBucket:"delicia-restaurante.firebasestorage.app",
  messagingSenderId:"653903447900",
  appId:"1:653903447900:web:85cffda9d703e464af6399"
};
const fbApp = initializeApp(firebaseConfig);
const db    = getDatabase(fbApp);

// ── CONSTANTES ────────────────────────────────────────────────
const CURRENCY    = 'Gs.';
const TOTAL_MESAS = 12;
const SESSION_KEY = 'delicias_sess_v4';
const TZ          = 'America/Asuncion';
const MASTER      = {id:'admin',username:'ADMIN',nombre:'Administrador',role:'admin'};

const CAT_DEFAULT = {
  'Coca Cola':'bebida','Pizza':'comida','Lomito':'comida','Jugos':'bebida',
  'Cerveza':'bebida','Agua':'bebida','Hamburguesa':'comida','Papas fritas':'comida',
  'Helado':'postre','Flan':'postre','Tiramisú':'postre'
};
const CAT_LABELS  = {bebida:'Bebida',comida:'Comida',postre:'Postre'};
const CAT_ICONS   = {bebida:'icon-drink',comida:'icon-food',postre:'icon-dessert'};

const fmt = n => CURRENCY+' '+Math.round(n).toLocaleString('es-PY');

// ── ESTADO ────────────────────────────────────────────────────
let state  = {mesas:{},productos:[],historial:[],usuarios:[],actividad:[]};
let sesion = null;
let mesaAbierta = null;
let pedidoActual = {};
let catActiva = 'todos';
let timerInterval = null;
let cocinaTimerInterval = null;

// ── DOM (definido primero para evitar errores en cualquier orden de ejecución) ──
window.$ = id => document.getElementById(id);
const html = (id,h) => { const e=$(id); if(e) e.innerHTML=h; };

function toast(msg){
  const el=document.createElement('div');
  el.className='toast';
  el.innerHTML=`<span>${msg}</span>`;
  document.body.appendChild(el);
  setTimeout(()=>{
    el.style.animation='toastSlide 0.3s ease reverse';
    setTimeout(()=>el.remove(),300);
  },3000);
}
function hora(){ return new Date().toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ}); }
function fechaHora(){ return new Date().toLocaleString('es-PY',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',timeZone:TZ}); }

// ── SESIÓN ────────────────────────────────────────────────────
const saveSession  = s => localStorage.setItem(SESSION_KEY,JSON.stringify(s));
const loadSession  = () => { try{ return JSON.parse(localStorage.getItem(SESSION_KEY)); }catch(e){ return null; } };
const clearSession = () => localStorage.removeItem(SESSION_KEY);

// ── BOOT ──────────────────────────────────────────────────────
async function boot(){
  $('loading-screen').style.display='flex';
  try{
    await cargarDatos();
    suscribirCambios();
    $('loading-screen').style.display='none';
    const saved=loadSession();
    if(saved && (saved.id==='admin'||state.usuarios.find(u=>u.id===saved.id))){
      sesion=saved; mostrarSegunRol();
    } else { clearSession(); mostrarLogin(); }
  }catch(err){
    console.error('Error de boot:', err);
    $('loading-screen').style.display='none';
    mostrarLogin();
    toast('⚠ Error de conexión con Firebase. Verificá tu internet.');
  }
}

function mostrarLogin(){
  $('login-screen').classList.add('show');
  $('app').classList.add('hidden');
  $('cocina-app').classList.remove('show');
}
function ocultarLogin(){ $('login-screen').classList.remove('show'); }

function mostrarSegunRol(){
  if(sesion.role==='cocinero'){
    ocultarLogin();
    $('app').classList.add('hidden');
    mostrarCocina();
  } else {
    ocultarLogin();
    $('cocina-app').classList.remove('show');
    mostrarApp();
  }
}

// ── VISTA NORMAL (Admin / Mesero) ─────────────────────────────
function mostrarApp(){
  $('app').classList.remove('hidden');
  $('header-username').textContent = sesion.nombre||sesion.username;
  $('header-role').textContent     = sesion.role==='admin'?'Admin':'Mesero';
  $('header-role').className       = 'role-badge '+(sesion.role==='admin'?'admin':'mesero');
  $('fecha-lbl').textContent       = new Date().toLocaleDateString('es-PY',{weekday:'long',year:'numeric',month:'long',day:'numeric',timeZone:TZ});
  if(sesion.role==='admin'){
    $('tab-admin-btn').classList.remove('hidden');
    $('btn-limpiar-wrap').style.display='block';
    $('btn-cierre').style.display='flex';
    $('add-prod-wrap').style.display='';
    const ba=$('bnav-admin'); if(ba) ba.classList.remove('hidden');
  } else {
    $('tab-admin-btn').classList.add('hidden');
    $('btn-limpiar-wrap').style.display='none';
    $('btn-cierre').style.display='none';
    $('add-prod-wrap').style.display='none';
    const ba=$('bnav-admin'); if(ba) ba.classList.add('hidden');
  }
  $('inp-mesero').value = sesion.nombre||sesion.username;
  renderMesas();
  renderProductosAdmin();
  renderHistorial();
  iniciarTimers();
  registrarActividad('accion-login','Ingresó al sistema');
  // Registrar presencia en línea
  registrarPresencia();
}

// ── VISTA COCINA ──────────────────────────────────────────────
function mostrarCocina(){
  $('cocina-app').classList.add('show');
  $('cocina-user-lbl').innerHTML = `<span class="icon icon-chef icon-sm"></span> ${sesion.nombre||sesion.username}`;
  renderCocina();
  iniciarTimersCocina();
  registrarActividad('accion-login','Ingresó como Cocinero/a');
  registrarPresencia();
}

// ── PRESENCIA EN TIEMPO REAL ──────────────────────────────────
async function registrarPresencia(){
  if(!sesion) return;
  const presRef = ref(db, `presencia/${sesion.username}`);
  try{
    await set(presRef, {
      online: true,
      nombre: sesion.nombre||sesion.username,
      rol: sesion.role,
      desde: Date.now()
    });
    // Firebase elimina automáticamente al desconectarse
    await onDisconnect(presRef).remove();
  }catch(e){ console.warn('Presencia no disponible:', e); }
}

async function quitarPresencia(){
  if(!sesion) return;
  try{ await set(ref(db, `presencia/${sesion.username}`), null); }catch(e){}
}

function iniciarTimersCocina(){
  detenerTimersCocina();
  cocinaTimerInterval = setInterval(actualizarTimersCocina, 1000);
}
function detenerTimersCocina(){
  if(cocinaTimerInterval){ clearInterval(cocinaTimerInterval); cocinaTimerInterval=null; }
}
function actualizarTimersCocina(){
  const ahora = Date.now();
  for(let i=1;i<=TOTAL_MESAS;i++){
    const el = document.getElementById(`cocina-timer-${i}`);
    if(!el) continue;
    const m = state.mesas[i];
    if(!m||!m.ocupada||!m.tsOcupada){ el.textContent=''; el.className='cocina-timer-big'; continue; }
    const diff = Math.floor((ahora - m.tsOcupada)/1000);
    const h2=Math.floor(diff/3600), mn=Math.floor((diff%3600)/60), s=diff%60;
    el.innerHTML = `<span class="icon icon-clock icon-sm"></span> ` + (h2>0
      ? `${h2}h ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`
      : `${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`);
    el.className = 'cocina-timer-big'+(diff>=5400?' alerta':'');
  }
}

// ── COLA COCINA ───────────────────────────────────────────────
let historialCocinaLocal = [];

function renderCocina(){
  const mesasConComida = [];
  for(let i=1;i<=TOTAL_MESAS;i++){
    const m=state.mesas[i];
    if(!m||!m.ocupada||!m.pedidoActual) continue;
    const itemsComida = Object.entries(m.pedidoActual).filter(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return p && (p.cat||'comida')==='comida' && qty>0;
    });
    if(itemsComida.length>0){
      mesasConComida.push({num:i, mesa:m, items:itemsComida, ts: m.tsOcupada||0});
    }
  }

  mesasConComida.sort((a,b)=>b.ts-a.ts);
  const visibles  = mesasConComida.slice(0,5);
  const ocultas   = mesasConComida.slice(5);

  ocultas.forEach(({num, mesa, items})=>{
    const yaEsta = historialCocinaLocal.some(h=>h.mesaNum===num && h.tipo==='oculta');
    if(!yaEsta){
      historialCocinaLocal.unshift({
        mesaNum: num,
        mesero: mesa.mesero||'—',
        hora: hora(),
        tipo: 'oculta',
        items: items.map(([pid,qty])=>{
          const p=state.productos.find(p=>String(p.id)===String(pid));
          return {nombre:p?p.nombre:'?',qty};
        })
      });
    }
  });
  
  const numsVisibles = visibles.map(v=>v.num);
  historialCocinaLocal = historialCocinaLocal.filter(h=>
    !(h.tipo==='oculta' && numsVisibles.includes(h.mesaNum))
  );

  const badge=$('cocina-badge');
  if(badge){
    const total=mesasConComida.length;
    const oculN=ocultas.length;
    badge.textContent=total===0?'Sin pedidos'
      :`${total} pedido${total!==1?'s':''}${oculN>0?` · ${oculN} oculto${oculN!==1?'s':''}`:'' }`;
  }

  if(!visibles.length){
    html('cocina-grid',`<div class="cocina-empty">
      <div class="cocina-empty-icon"></div>
      <div class="cocina-empty-txt">Sin pedidos de comida activos</div>
    </div>`);
    return;
  }

  html('cocina-grid', visibles.map(({num,mesa,items},idx)=>{
    const itemsHtml = items.map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      if(!p) return '';
      return `<div class="cocina-item">
        <div class="cocina-item-qty">${qty}</div>
        <div>
          <div class="cocina-item-name">${p.nombre}</div>
          <div class="cocina-item-cat">${CAT_LABELS[p.cat||'comida']}</div>
        </div>
      </div>`;
    }).join('');

    const esNuevo = idx===0;
    const borderColor = esNuevo ? '#e94560' : '#2a2a4a';
    const extraClass  = esNuevo ? 'nueva' : '';

    return `<div class="cocina-card ${extraClass}" style="border-color:${borderColor};">
      <div class="cocina-card-header">
        <div style="display:flex;align-items:flex-start;gap:12px;">
          <div style="background:${esNuevo?'#e94560':'rgba(255,255,255,0.1)'};color:${esNuevo?'#fff':'#a0a0b0'};font-family:'DM Sans',sans-serif;font-size:0.75rem;font-weight:800;padding:4px 12px;border-radius:20px;margin-top:4px;letter-spacing:0.08em;white-space:nowrap;">
            ${esNuevo?'NUEVO':'#'+(idx+1)}
          </div>
          <div>
            <div class="cocina-mesa-lbl">Mesa</div>
            <div class="cocina-mesa-num">${num}</div>
          </div>
        </div>
        <div id="cocina-timer-${num}" class="cocina-timer-big"></div>
      </div>
      <div class="cocina-card-body">
        <div class="cocina-items-list">${itemsHtml}</div>
      </div>
      ${mesa.mesero?`<div class="cocina-card-footer"><div class="cocina-mesero"><span class="icon icon-user icon-sm"></span> ${mesa.mesero}</div></div>`:''}
    </div>`;
  }).join(''));

  actualizarTimersCocina();
}

// ── HISTORIAL COCINA ──────────────────────────────────────────
function capturarHistorialCocina(mesaNum, mesa, pedido){
  const itemsComida = Object.entries(pedido).filter(([pid,qty])=>{
    const p=state.productos.find(p=>String(p.id)===String(pid));
    return p && (p.cat||'comida')==='comida' && qty>0;
  });
  if(!itemsComida.length) return;

  historialCocinaLocal = historialCocinaLocal.filter(h=>!(h.mesaNum===mesaNum && h.tipo==='oculta'));

  historialCocinaLocal.unshift({
    mesaNum,
    mesero: mesa.mesero||'—',
    hora: hora(),
    tipo: 'pagada',
    items: itemsComida.map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return {nombre:p?p.nombre:'?',qty};
    })
  });
  if(historialCocinaLocal.length>80) historialCocinaLocal=historialCocinaLocal.slice(0,80);
}

window.abrirHistorialCocina = function(){
  const body=$('hist-cocina-body'); if(!body) return;
  if(!historialCocinaLocal.length){
    body.innerHTML=`<div style="text-align:center;padding:48px 24px;color:#a0a0b0;">
      <div style="font-size:3.5rem;opacity:0.3;margin-bottom:16px;"><span class="icon icon-history icon-xl"></span></div>
      <div>Sin pedidos anteriores en esta sesión</div>
    </div>`;
  } else {
    const tipoBadge={
      oculta:`<span style="background:rgba(230,126,34,0.2);color:#e67e22;border:1px solid rgba(230,126,34,0.4);border-radius:20px;padding:4px 12px;font-size:0.75rem;font-weight:700;">EN COLA</span>`,
      pagada:`<span style="background:rgba(39,174,96,0.2);color:#27ae60;border:1px solid rgba(39,174,96,0.4);border-radius:20px;padding:4px 12px;font-size:0.75rem;font-weight:700;">ENTREGADO</span>`
    };
    body.innerHTML = historialCocinaLocal.map(h=>`
      <div style="background:rgba(255,255,255,0.05);border:1px solid #2a2a4a;border-radius:12px;padding:20px;margin-bottom:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <span style="font-family:'Playfair Display',serif;font-size:1.3rem;color:#eaeaea;font-weight:700;">Mesa ${h.mesaNum}</span>
            ${tipoBadge[h.tipo]||''}
          </div>
          <div style="font-size:0.85rem;color:#a0a0b0;display:flex;align-items:center;gap:8px;">
            <span class="icon icon-clock icon-sm"></span> ${h.hora} · <span class="icon icon-user icon-sm"></span> ${h.mesero}
          </div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
          ${h.items.map(it=>`
            <div style="background:rgba(233,69,96,0.15);border:1px solid rgba(233,69,96,0.3);border-radius:8px;padding:8px 16px;font-size:1rem;color:#eaeaea;font-weight:600;">
              <span style="color:#e94560;font-family:'Playfair Display',serif;font-size:1.2rem;">${it.qty}×</span> ${it.nombre}
            </div>`).join('')}
        </div>
      </div>`).join('');
  }
  $('modal-hist-cocina').classList.add('open');
};

// ── AUTH ──────────────────────────────────────────────────────
window.doLogin = function(){
  const u=$('inp-user').value.trim().toUpperCase();
  const p=$('inp-pass').value.trim();
  $('login-err').textContent='';
  if(u==='ADMIN'&&p==='1234RD'){ sesion={...MASTER}; saveSession(sesion); mostrarSegunRol(); return; }
  const found=state.usuarios.find(x=>x.username.toUpperCase()===u&&x.password===p);
  if(found){
    sesion={id:found.id,username:found.username,nombre:found.nombre,role:found.role||'mesero'};
    saveSession(sesion);
    mostrarSegunRol();
  } else $('login-err').innerHTML='<span class="icon icon-x icon-sm"></span> Usuario o contraseña incorrectos.';
};

window.doLogout = async function(){
  if(sesion) registrarActividad('accion-login','Cerró sesión');
  await quitarPresencia();
  clearSession(); sesion=null;
  detenerTimers();
  detenerTimersCocina();
  $('app').classList.add('hidden');
  $('cocina-app').classList.remove('show');
  mostrarLogin();
  $('inp-user').value=''; $('inp-pass').value=''; $('login-err').textContent='';
  setTabDirect('mesas');
};

$('inp-pass').addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });
$('inp-user').addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });

// ── FIREBASE ──────────────────────────────────────────────────
function mesaDefault(){ return {ocupada:false,mesero:'',pedidoActual:{},clientesNoche:[],tsOcupada:null}; }

function productosDefault(){
  return [
    {id:1,nombre:'Coca Cola',precio:150,cat:'bebida'},
    {id:2,nombre:'Pizza',precio:850,cat:'comida'},
    {id:3,nombre:'Lomito',precio:950,cat:'comida'},
    {id:4,nombre:'Jugos',precio:120,cat:'bebida'},
    {id:5,nombre:'Cerveza',precio:200,cat:'bebida'},
    {id:6,nombre:'Agua',precio:80,cat:'bebida'},
    {id:7,nombre:'Hamburguesa',precio:700,cat:'comida'},
    {id:8,nombre:'Papas fritas',precio:350,cat:'comida'},
    {id:9,nombre:'Helado',precio:180,cat:'postre'},
    {id:10,nombre:'Flan',precio:120,cat:'postre'},
    {id:11,nombre:'Tiramisú',precio:250,cat:'postre'},
  ];
}

async function cargarDatos(){
  const [msSnap,prSnap,hiSnap,usSnap,acSnap]=await Promise.all([
    get(ref(db,'mesas')),get(ref(db,'productos')),
    get(ref(db,'historial')),get(ref(db,'usuarios')),get(ref(db,'actividad'))
  ]);
  if(msSnap.exists()){ state.mesas=msSnap.val();
    for(let i=1;i<=TOTAL_MESAS;i++) if(!state.mesas[i]){state.mesas[i]=mesaDefault();await set(ref(db,`mesas/${i}`),state.mesas[i]);}
  } else {
    for(let i=1;i<=TOTAL_MESAS;i++) state.mesas[i]=mesaDefault();
    await set(ref(db,'mesas'),state.mesas);
  }
  if(prSnap.exists()){ const r=prSnap.val(); state.productos=Array.isArray(r)?r:Object.values(r);
    let migrado=false;
    state.productos.forEach(p=>{ if(!p.cat){ p.cat=CAT_DEFAULT[p.nombre]||'comida'; migrado=true; } });
    if(migrado) await set(ref(db,'productos'),state.productos);
  } else { state.productos=productosDefault(); await set(ref(db,'productos'),state.productos); }
  if(hiSnap.exists()){ const r=hiSnap.val(); state.historial=Array.isArray(r)?r:Object.values(r); } else state.historial=[];
  if(usSnap.exists()){ const r=usSnap.val(); state.usuarios=Array.isArray(r)?r:Object.values(r); } else state.usuarios=[];
  if(acSnap.exists()){ const r=acSnap.val(); state.actividad=Array.isArray(r)?r:Object.values(r); } else state.actividad=[];
}

function suscribirCambios(){
  let prevMesas = {};
  onValue(ref(db,'mesas'),snap=>{
    if(snap.exists()){
      const newMesas=snap.val();
      if(sesion?.role==='cocinero'){
        for(let i=1;i<=TOTAL_MESAS;i++){
          const prev=prevMesas[i], next=newMesas[i];
          if(prev&&prev.ocupada&&next&&!next.ocupada&&prev.pedidoActual&&Object.keys(prev.pedidoActual).length){
            capturarHistorialCocina(i, prev, prev.pedidoActual);
          }
        }
      }
      prevMesas={...newMesas};
      state.mesas=newMesas;
      renderMesas();
      if(mesaAbierta) renderClientesMesa(mesaAbierta);
      if(sesion?.role==='cocinero') renderCocina();
    }
    setSyncOk(true);
  },()=>setSyncOk(false));
  onValue(ref(db,'productos'),snap=>{ if(snap.exists()){const r=snap.val();state.productos=Array.isArray(r)?r:Object.values(r);}renderProductosAdmin();if(mesaAbierta)renderProductosGrid(); });
  onValue(ref(db,'historial'),snap=>{ if(snap.exists()){const r=snap.val();state.historial=Array.isArray(r)?r:Object.values(r);}else state.historial=[];renderHistorial(); });
  onValue(ref(db,'usuarios'),snap=>{ if(snap.exists()){const r=snap.val();state.usuarios=Array.isArray(r)?r:Object.values(r);}else state.usuarios=[];renderUsersList(); });
  onValue(ref(db,'actividad'),snap=>{ if(snap.exists()){const r=snap.val();state.actividad=Array.isArray(r)?r:Object.values(r);}else state.actividad=[];renderActividad(); });
  // Presencia en tiempo real
  onValue(ref(db,'presencia'),snap=>{
    const activos = snap.exists() ? snap.val() : {};
    renderPresencia(activos);
  });
}

function renderPresencia(activos){
  const el = $('presencia-panel');
  if(!el || sesion?.role!=='admin') return;
  const lista = Object.values(activos||{});
  if(!lista.length){
    el.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;">Ningún usuario conectado ahora.</div>';
    return;
  }
  const roleColor = {admin:'var(--gold)',mesero:'var(--blue)',cocinero:'#e94560'};
  el.innerHTML = lista.map(u=>`
    <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="width:8px;height:8px;border-radius:50%;background:var(--success);display:inline-block;box-shadow:0 0 6px var(--success);flex-shrink:0;animation:pulse 2s infinite;"></span>
      <span style="font-weight:600;color:var(--text);font-size:0.9rem;">${u.nombre}</span>
      <span style="font-size:0.7rem;font-weight:700;padding:3px 8px;border-radius:20px;background:rgba(255,255,255,0.1);color:${roleColor[u.rol]||'var(--text-muted)'};">${u.rol}</span>
      <span style="font-size:0.75rem;color:var(--text-muted);margin-left:auto;">${u.desde?new Date(u.desde).toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',timeZone:TZ}):''}</span>
    </div>`).join('');
}

function setSyncOk(ok){
  const dot=$('sync-dot'),txt=$('sync-txt'); if(dot){ dot.className='sync-dot'+(ok?'':' offline'); txt.textContent=ok?'En línea':'Sin conexión'; }
  const dotC=$('sync-dot-cocina'),txtC=$('sync-txt-cocina'); if(dotC){ dotC.className='sync-dot'+(ok?'':' offline'); txtC.textContent=ok?'En línea':'Sin conexión'; }
}

const saveMesa = async (num) => {
  try{
    await set(ref(db,`mesas/${num}`), state.mesas[num]);
  }catch(e){
    console.error('Error guardando mesa:', e);
    toast('⚠ Error al guardar en Firebase. Reintentando...');
    // Retry once
    try{ await set(ref(db,`mesas/${num}`), state.mesas[num]); }catch(e2){ toast('⚠ No se pudo guardar. Verificá tu conexión.'); }
  }
};
const saveProductos = async () => {
  try{ await set(ref(db,'productos'),state.productos); }
  catch(e){ console.error('Error guardando productos:', e); toast('⚠ Error al guardar productos.'); }
};
const saveHistorial = async () => {
  try{ await set(ref(db,'historial'),state.historial); }
  catch(e){ console.error('Error guardando historial:', e); toast('⚠ Error al guardar historial.'); }
};
const saveUsuarios = async () => {
  try{ await set(ref(db,'usuarios'),state.usuarios); }
  catch(e){ console.error('Error guardando usuarios:', e); toast('⚠ Error al guardar usuarios.'); }
};

// ── OCUPAR MESA CON TRANSACCIÓN (evita condición de carrera) ──
async function ocuparMesaConTransaccion(num, meseroNombre){
  const mesaRef = ref(db, `mesas/${num}`);
  try{
    const result = await runTransaction(mesaRef, (mesaActual) => {
      // Si otro mesero la tomó mientras tanto, abortar
      if(mesaActual && mesaActual.ocupada && !state.mesas[num]?.ocupada){
        return; // undefined = abort
      }
      const nuevo = mesaActual || mesaDefault();
      nuevo.mesero = meseroNombre;
      nuevo.ocupada = true;
      nuevo.ultimoUsuario = sesion?.username || '';
      if(!mesaActual?.ocupada) nuevo.tsOcupada = Date.now();
      nuevo.pedidoActual = {...pedidoActual};
      return nuevo;
    });
    if(!result.committed){
      toast('⚠ Esta mesa fue tomada por otro mesero. Actualizando...');
      return false;
    }
    return true;
  }catch(e){
    console.error('Error en transacción:', e);
    // Fallback a set directo
    await saveMesa(num);
    return true;
  }
}

// ── TIMERS NORMAL ─────────────────────────────────────────────
function iniciarTimers(){ detenerTimers(); timerInterval=setInterval(actualizarTimers,1000); }
function detenerTimers(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }

function actualizarTimers(){
  const ahora=Date.now();
  for(let i=1;i<=TOTAL_MESAS;i++){
    const el=document.getElementById(`timer-mesa-${i}`); if(!el) continue;
    const m=state.mesas[i];
    if(!m||!m.ocupada||!m.tsOcupada){ el.textContent=''; el.className='mesa-timer'; continue; }
    const diff=Math.floor((ahora-m.tsOcupada)/1000);
    const h2=Math.floor(diff/3600),mn=Math.floor((diff%3600)/60),s=diff%60;
    el.innerHTML=`<span class="icon icon-clock icon-sm"></span> ` + (h2>0?`${h2}h ${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`:`${String(mn).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`);
    el.className='mesa-timer'+(diff>=5400?' alerta':'');
  }
}

// ── TABS ──────────────────────────────────────────────────────
window.setTab = function(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['mesas','productos','historial','admin'].forEach(t=>$('tab-'+t).classList.toggle('hidden',t!==tab));
};
window.setTabMobile = function(tab,el){
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['mesas','productos','historial','admin'].forEach(t=>$('tab-'+t).classList.toggle('hidden',t!==tab));
};
function setTabDirect(tab){
  ['mesas','productos','historial','admin'].forEach(t=>$('tab-'+t).classList.toggle('hidden',t!==tab));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
}

// ── RENDER MESAS ─────────────────────────────────────────────
function calcTotal(pedido){
  if(!pedido) return 0;
  return Object.entries(pedido).reduce((s,[pid,qty])=>{
    const p=state.productos.find(p=>String(p.id)===String(pid));
    return s+(p?p.precio*qty:0);
  },0);
}

function renderMesas(){
  if(sesion?.role==='cocinero') return;
  let h='',ocp=0;
  for(let i=1;i<=TOTAL_MESAS;i++){
    const m=state.mesas[i]||mesaDefault();
    const tot=calcTotal(m.pedidoActual);
    if(m.ocupada) ocp++;
    h+=`<div class="mesa-card ${m.ocupada?'ocupada':''}" onclick="abrirMesa(${i})">
      <div class="mesa-top">
        <div class="mesa-label"><span class="icon icon-table icon-sm"></span> Mesa</div>
        <div class="mesa-num">${i}</div>
      </div>
      <div class="mesa-bottom">
        <div class="mesa-status ${m.ocupada?'ocupada':'libre'}">${m.ocupada?'Ocupada':'Libre'}</div>
        ${m.mesero?`<div class="mesa-mesero"><span class="icon icon-user icon-sm"></span> ${m.mesero}</div>`:''}
        ${m.ocupada&&tot>0?`<div class="mesa-total">${fmt(tot)}</div>`:''}
        <div class="mesa-timer" id="timer-mesa-${i}"></div>
      </div>
    </div>`;
  }
  html('mesas-grid',h);
  const b=$('badge-mesas'); if(b) b.textContent=`${ocp} ocupada${ocp!==1?'s':''}`;
  actualizarTimers();
}

// ── MODAL MESA ────────────────────────────────────────────────
window.abrirMesa = function(num){
  mesaAbierta=num;
  const m=state.mesas[num]||mesaDefault();
  pedidoActual={...(m.pedidoActual||{})};
  $('modal-title').innerHTML=`<span class="icon icon-table"></span> Mesa ${num}`;
  $('modal-subtitle').textContent=m.ocupada?'Ocupada':'Disponible';
  $('inp-mesero').value=sesion?sesion.nombre||sesion.username:'';
  catActiva='todos';
  document.querySelectorAll('#cat-tabs-modal .cat-tab').forEach(t=>t.classList.toggle('active',t.dataset.cat==='todos'));
  renderProductosGrid();
  renderPedidoActual();
  renderClientesMesa(num);
  $('modal-mesa').classList.add('open');
};
window.cerrarModal = function(){ $('modal-mesa').classList.remove('open'); mesaAbierta=null; };

window.filtrarCat = function(cat,el){
  catActiva=cat;
  document.querySelectorAll('#cat-tabs-modal .cat-tab').forEach(t=>t.classList.toggle('active',t===el));
  renderProductosGrid();
};

function renderProductosGrid(){
  const prods=catActiva==='todos'?state.productos:state.productos.filter(p=>(p.cat||'comida')===catActiva);
  if(!prods.length){ html('productos-grid','<div style="color:var(--text-muted);grid-column:1/-1;font-size:0.9rem;padding:16px 0">Sin productos en esta categoría.</div>'); return; }
  html('productos-grid',prods.map(p=>
    `<button class="producto-btn" onclick="addProd(${p.id})">
      <span class="prod-name">${p.nombre}</span>
      <span class="prod-price">${fmt(p.precio)}</span>
    </button>`).join(''));
}

window.addProd = function(pid){ pedidoActual[pid]=(pedidoActual[pid]||0)+1; renderPedidoActual(); };
window.cambiarQty = function(pid,d){
  pedidoActual[pid]=(pedidoActual[pid]||0)+d;
  if(pedidoActual[pid]<=0) delete pedidoActual[pid];
  renderPedidoActual();
};

function renderPedidoActual(){
  const items=Object.entries(pedidoActual);
  if(!items.length){ html('orden-items','<div style="color:var(--text-muted);font-size:0.9rem;padding:12px 0">Sin productos</div>'); $('pedido-total').textContent=fmt(0); return; }
  let total=0,h='';
  for(const [pid,qty] of items){
    const p=state.productos.find(p=>String(p.id)===String(pid)); if(!p) continue;
    const sub=p.precio*qty; total+=sub;
    h+=`<div class="orden-item">
      <span class="orden-item-name">${p.nombre}</span>
      <span class="orden-item-qty">
        <button class="qty-btn" onclick="cambiarQty(${pid},-1)"><span class="icon icon-minus icon-sm"></span></button>
        <span class="qty-num">${qty}</span>
        <button class="qty-btn" onclick="cambiarQty(${pid},1)"><span class="icon icon-plus icon-sm"></span></button>
      </span>
      <span class="orden-item-price">${fmt(sub)}</span>
    </div>`;
  }
  html('orden-items',h); $('pedido-total').textContent=fmt(total);
}

window.confirmarPedido = async function(){
  if(!mesaAbierta) return;
  if(!Object.keys(pedidoActual).length){ toast('Añade al menos un producto.'); return; }
  const mesero=sesion?sesion.nombre||sesion.username:'';
  const m=state.mesas[mesaAbierta];
  const yaOcupada=m.ocupada;
  m.pedidoActual={...pedidoActual};
  m.mesero=mesero; m.ocupada=true; m.ultimoUsuario=sesion?.username||'';
  if(!yaOcupada) m.tsOcupada=Date.now();
  // Usar transacción para evitar condición de carrera al ocupar mesa
  const ok = await ocuparMesaConTransaccion(mesaAbierta, mesero);
  if(!ok) return;
  $('modal-subtitle').textContent='Ocupada';
  await registrarActividad('accion-pedido',`Confirmó pedido en Mesa ${mesaAbierta} (${fmt(calcTotal(pedidoActual))})`);
  toast(`Pedido confirmado — Mesa ${mesaAbierta}`);
};

window.marcarPagado = async function(){
  if(!mesaAbierta) return;
  const m=state.mesas[mesaAbierta];
  const mesero=sesion?sesion.nombre||sesion.username:'';
  let ticketData=null;
  if(Object.keys(pedidoActual).length>0){
    const cn=m.clientesNoche||[];
    const detalles=Object.entries(pedidoActual).map(([pid,qty])=>{
      const p=state.productos.find(p=>String(p.id)===String(pid));
      return p?{nombre:p.nombre,qty,precio:p.precio,sub:p.precio*qty,cat:p.cat||'comida'}:null;
    }).filter(Boolean);
    const total=calcTotal(pedidoActual);
    const tiempoOcupada=m.tsOcupada?Math.floor((Date.now()-m.tsOcupada)/60000):null;
    cn.push({num:cn.length+1,detalles,total,mesero,usuario:sesion?.username||'',hora:hora(),tiempoMin:tiempoOcupada});
    m.clientesNoche=cn;
    state.historial.push({mesa:mesaAbierta,clienteNum:cn.length,detalles,total,mesero,usuario:sesion?.username||'',hora:hora()});
    await saveHistorial();
    await registrarActividad('accion-pago',`Marcó Mesa ${mesaAbierta} como pagada — ${fmt(total)}`);
    ticketData={mesa:mesaAbierta,clienteNum:cn.length,detalles,total,mesero,hora:hora()};
    capturarHistorialCocina(mesaAbierta, m, pedidoActual);
  }
  m.ocupada=false; m.pedidoActual={}; m.mesero=''; m.ultimoUsuario=''; m.tsOcupada=null;
  await saveMesa(mesaAbierta);
  pedidoActual={};
  cerrarModal();
  toast(`Mesa ${mesaAbierta} liberada`);
  if(ticketData) setTimeout(()=>imprimirTicket(ticketData),300);
};

function renderClientesMesa(num){
  const m=state.mesas[num];
  const cl=m&&m.clientesNoche?m.clientesNoche:[];
  if(!cl.length){ html('clientes-mesa-list','<div style="color:var(--text-muted);font-size:0.85rem;">Sin clientes registrados esta noche.</div>'); return; }
  html('clientes-mesa-list',cl.map(c=>`
    <div class="cliente-item">
      <div class="cliente-header">
        <span class="cliente-num"><span class="icon icon-user icon-sm"></span> Cliente ${c.num}°</span>
        <span style="font-size:0.95rem;font-weight:600;color:var(--text-secondary);font-family:'Playfair Display',serif;">${fmt(c.total)}</span>
      </div>
      <div class="cliente-items-list">${c.detalles.map(d=>`${d.qty}x ${d.nombre} = ${fmt(d.sub)}`).join(' · ')}</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
        ${c.mesero?`<span class="mesero-badge"><span class="icon icon-user icon-sm"></span> ${c.mesero}</span>`:''}
        ${c.usuario?`<span class="mesero-badge" style="color:var(--blue);border-color:var(--blue)"><span class="icon icon-admin icon-sm"></span> ${c.usuario}</span>`:''}
        ${c.tiempoMin!=null?`<span class="mesero-badge"><span class="icon icon-clock icon-sm"></span> ${c.tiempoMin}min</span>`:''}
      </div>
    </div>`).join(''));
}

window.verHistorialMesa = function(){
  if(!mesaAbierta) return;
  const cl=(state.mesas[mesaAbierta]?.clientesNoche)||[];
  $('hist-mesa-title').innerHTML=`<span class="icon icon-history"></span> Historial Completo — Mesa ${mesaAbierta}`;
  if(!cl.length){ html('hist-mesa-body','<div class="empty-state"><span class="icon icon-empty icon-xl"></span><p>Sin historial esta noche.</p></div>'); }
  else{
    let tot=0;
    let h='<table class="history-table"><thead><tr><th>Cliente</th><th>Detalle</th><th>Mesero</th><th>Tiempo</th><th>Total</th></tr></thead><tbody>';
    cl.forEach(c=>{ tot+=c.total;
      h+=`<tr><td>Cliente ${c.num}°</td><td>${c.detalles.map(d=>`${d.qty}× ${d.nombre}`).join(', ')}</td><td>${c.mesero||'—'}</td><td>${c.tiempoMin!=null?c.tiempoMin+'min':'—'}</td><td>${fmt(c.total)}</td></tr>`;
    });
    h+=`<tr class="total-row"><td colspan="4">Total Mesa ${mesaAbierta}</td><td>${fmt(tot)}</td></tr></tbody></table>`;
    html('hist-mesa-body',h);
  }
  $('modal-hist-mesa').classList.add('open');
};

// ── TICKET 80mm ───────────────────────────────────────────────
function imprimirTicket(t){
  const cats={bebida:[],comida:[],postre:[]};
  t.detalles.forEach(d=>{ const c=d.cat||'comida'; (cats[c]=cats[c]||[]).push(d); });

  const catNames={comida:'COMIDAS',bebida:'BEBIDAS',postre:'POSTRES'};
  let itemsHtml='';
  ['comida','bebida','postre'].forEach(cat=>{
    if(!cats[cat]||!cats[cat].length) return;
    itemsHtml+=`<div class="ticket-cat-hdr">${catNames[cat]}</div>`;
    cats[cat].forEach(d=>{
      const nombre = d.nombre.length>20 ? d.nombre.slice(0,19)+'…' : d.nombre;
      itemsHtml+=`<div class="ticket-row">
        <span class="ticket-item-name">${d.qty}x ${nombre}</span>
        <span class="ticket-item-price">${fmt(d.sub)}</span>
      </div>`;
    });
  });

  const now=new Date();
  const fechaTk=now.toLocaleDateString('es-PY',{day:'2-digit',month:'2-digit',year:'numeric',timeZone:TZ});
  const horaTk=now.toLocaleTimeString('es-PY',{hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:TZ});

  $('ticket-print').innerHTML=`
  <div class="ticket-wrap">
    <div class="ticket-title">RESTAURANTE</div>
    <div class="ticket-title" style="font-size:17pt;letter-spacing:4px;">DELICIAS</div>
    <div class="ticket-div"></div>
    <div class="ticket-row bold"><span>Mesa:</span><span>${t.mesa}</span></div>
    <div class="ticket-row bold"><span>Cliente:</span><span>${t.clienteNum}°</span></div>
    <div class="ticket-row"><span>Mesero:</span><span>${t.mesero||'—'}</span></div>
    <div class="ticket-row"><span>Fecha:</span><span>${fechaTk}</span></div>
    <div class="ticket-row"><span>Hora:</span><span>${horaTk}</span></div>
    <div class="ticket-div"></div>
    ${itemsHtml}
    <div class="ticket-div"></div>
    <div class="ticket-row total"><span>TOTAL</span><span>${fmt(t.total)}</span></div>
    <div class="ticket-div"></div>
    <div class="ticket-center">¡Gracias por su visita!</div>
    <div class="ticket-center">Vuelva pronto</div>
    <hr class="ticket-corte"/>
  </div>`;

  window.print();
}

// ── PRODUCTOS ADMIN ───────────────────────────────────────────
function renderProductosAdmin(){
  if(sesion?.role==='cocinero') return;
  html('productos-admin-list',state.productos.length
    ? state.productos.map(p=>`
        <div class="prod-card">
          <div>
            <div class="pname">${p.nombre}</div>
            <div class="pprice">${fmt(p.precio)}</div>
            <span class="pcat ${p.cat||'comida'}"><span class="icon ${CAT_ICONS[p.cat||'comida']} icon-sm"></span> ${CAT_LABELS[p.cat||'comida']}</span>
          </div>
          <div class="prod-card-actions">
            ${sesion?.role==='admin'?`
              <button class="icon-btn" onclick="abrirEditProd(${p.id})" title="Editar"><span class="icon icon-edit"></span></button>
              <button class="icon-btn" onclick="eliminarProd(${p.id})" title="Eliminar"><span class="icon icon-trash"></span></button>`:''}
          </div>
        </div>`).join('')
    : '<div style="color:var(--text-muted)">Sin productos.</div>');
}

window.agregarProducto = async function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin puede añadir productos.'); return; }
  const nombre=$('prod-nombre').value.trim();
  const precio=parseInt($('prod-precio').value);
  const cat   =$('prod-cat').value;
  if(!nombre){ toast('Ingresa el nombre.'); return; }
  if(isNaN(precio)||precio<0){ toast('Precio inválido.'); return; }
  const id=state.productos.length?Math.max(...state.productos.map(p=>p.id))+1:1;
  state.productos.push({id,nombre,precio,cat});
  await saveProductos();
  $('prod-nombre').value=''; $('prod-precio').value='';
  await registrarActividad('accion-producto',`Añadió "${nombre}" (${CAT_LABELS[cat]}) — ${fmt(precio)}`);
  toast(`"${nombre}" añadido.`);
};

window.eliminarProd = async function(id){
  if(sesion?.role!=='admin'){ toast('Solo el Admin.'); return; }
  if(!confirm('¿Eliminar este producto?')) return;
  const p=state.productos.find(p=>p.id===id);
  state.productos=state.productos.filter(p=>p.id!==id);
  await saveProductos();
  await registrarActividad('accion-producto',`Eliminó producto "${p?.nombre}"`);
  toast('Producto eliminado.');
};

window.abrirEditProd = function(id){
  const p=state.productos.find(p=>p.id===id); if(!p) return;
  $('edit-prod-id').value=id; $('edit-prod-nombre').value=p.nombre;
  $('edit-prod-precio').value=p.precio; $('edit-prod-cat').value=p.cat||'comida';
  $('modal-edit-prod').classList.add('open');
};

window.guardarEditProd = async function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin.'); return; }
  const id=parseInt($('edit-prod-id').value);
  const nombre=$('edit-prod-nombre').value.trim();
  const precio=parseInt($('edit-prod-precio').value);
  const cat   =$('edit-prod-cat').value;
  if(!nombre||isNaN(precio)){ toast('Completa los campos.'); return; }
  const p=state.productos.find(p=>p.id===id);
  if(p){ p.nombre=nombre; p.precio=precio; p.cat=cat; }
  await saveProductos();
  cerrarEditProd();
  await registrarActividad('accion-producto',`Editó "${nombre}" → ${fmt(precio)} (${CAT_LABELS[cat]})`);
  toast('Producto actualizado.');
};
window.cerrarEditProd = ()=>$('modal-edit-prod').classList.remove('open');

// ── USUARIOS ADMIN ────────────────────────────────────────────
window.toggleAddUser = function(){
  const w=$('add-user-wrap-panel'); w.classList.toggle('hidden');
  if(!w.classList.contains('hidden')){ $('nu-nombre').focus(); ['nu-nombre','nu-user','nu-pass','nu-pass2'].forEach(i=>$(i).value=''); }
};

window.crearUsuario = async function(){
  const nombre=$('nu-nombre').value.trim();
  const username=$('nu-user').value.trim().toUpperCase();
  const pass=$('nu-pass'), pass2=$('nu-pass2').value;
  const role=$('nu-role').value;
  if(!nombre||!username||!pass){ toast('Completa todos los campos.'); return; }
  if(pass!==pass2){ toast('Las contraseñas no coinciden.'); return; }
  if(username==='ADMIN'){ toast('Nombre reservado.'); return; }
  if(state.usuarios.find(u=>u.username.toUpperCase()===username)){ toast('Usuario ya existe.'); return; }
  const nu={id:'u_'+Date.now(),nombre,username,password:pass,role,creadoPor:sesion?.username||'admin',creadoEn:fechaHora()};
  state.usuarios.push(nu);
  await saveUsuarios();
  toggleAddUser();
  const roleLbl = role==='cocinero'?'Cocinero/a':'Mesero';
  await registrarActividad('accion-admin',`Creó usuario ${roleLbl}: "${nombre}" (${username})`);
  toast(`Usuario "${nombre}" (${roleLbl}) creado.`);
};

window.eliminarUsuario = async function(id){
  const u=state.usuarios.find(u=>u.id===id); if(!u) return;
  if(!confirm(`¿Eliminar a "${u.nombre}"?`)) return;
  state.usuarios=state.usuarios.filter(u=>u.id!==id);
  await saveUsuarios();
  await registrarActividad('accion-admin',`Eliminó usuario "${u.nombre}"`);
  toast('Usuario eliminado.');
};

window.abrirCambiarPass = function(id){
  const u=state.usuarios.find(u=>u.id===id); if(!u) return;
  $('cp-user-id').value=id; 
  $('cp-user-name').innerHTML=`<span class="icon icon-user icon-sm"></span> ${u.nombre} (${u.username})`;
  $('cp-pass').value=''; $('cp-pass2').value='';
  $('modal-cambiar-pass').classList.add('open');
};

window.guardarNuevaPass = async function(){
  const id=$('cp-user-id').value, pass=$('cp-pass').value, pass2=$('cp-pass2').value;
  if(!pass){ toast('Ingresa la contraseña.'); return; }
  if(pass!==pass2){ toast('No coinciden.'); return; }
  const u=state.usuarios.find(u=>u.id===id); if(u) u.password=pass;
  await saveUsuarios();
  $('modal-cambiar-pass').classList.remove('open');
  await registrarActividad('accion-admin',`Cambió contraseña de "${u?.nombre}"`);
  toast('Contraseña actualizada.');
};

function renderUsersList(){
  const list=$('users-list'); if(!list) return;
  let h=`<div class="user-item">
    <div class="user-info">
      <div class="uname"><span class="icon icon-crown icon-sm"></span> Administrador</div>
      <div class="ufull">ADMIN · <span style="color:var(--gold);font-weight:600">Admin Principal</span></div>
    </div>
    <span class="role-badge admin">Admin</span>
  </div>`;
  if(!state.usuarios.length) h+='<div style="color:var(--text-muted);font-size:0.9rem;text-align:center;padding:16px;">Sin usuarios creados.</div>';
  else h+=state.usuarios.map(u=>{
    const isCocinero=u.role==='cocinero';
    const badgeClass=isCocinero?'cocinero':'mesero';
    const badgeLabel=isCocinero?'Cocinero/a':'Mesero';
    const iconClass=isCocinero?'icon-chef':'icon-user';
    return `<div class="user-item">
      <div class="user-info">
        <div class="uname"><span class="icon ${iconClass} icon-sm"></span> ${u.nombre}</div>
        <div class="ufull">${u.username} · ${u.creadoEn||'—'}</div>
      </div>
      <div class="user-item-actions">
        <span class="role-badge ${badgeClass}">${badgeLabel}</span>
        <button class="icon-btn" onclick="abrirCambiarPass('${u.id}')" title="Cambiar contraseña"><span class="icon icon-key"></span></button>
        <button class="icon-btn" onclick="eliminarUsuario('${u.id}')" title="Eliminar"><span class="icon icon-trash"></span></button>
      </div>
    </div>`;
  }).join('');
  list.innerHTML=h;
}

// ── ACTIVIDAD ─────────────────────────────────────────────────
async function registrarActividad(tipo,msg){
  if(!sesion) return;
  const e={tipo,msg,usuario:sesion.nombre||sesion.username,role:sesion.role,fechaHora:fechaHora(),ts:Date.now()};
  state.actividad.unshift(e);
  if(state.actividad.length>200) state.actividad=state.actividad.slice(0,200);
  await set(ref(db,'actividad'),state.actividad);
}
function renderActividad(){
  const list=$('activity-list'); if(!list) return;
  if(!state.actividad.length){ list.innerHTML='<div class="empty-state"><span class="icon icon-empty icon-xl"></span><p>Sin actividad.</p></div>'; return; }
  list.innerHTML=state.actividad.slice(0,80).map(a=>{
    const roleLabel={admin:'Admin',mesero:'Mesero',cocinero:'Cocinero/a'}[a.role]||a.role;
    const iconMap={admin:'icon-crown',mesero:'icon-user',cocinero:'icon-chef'};
    return `<div class="activity-item">
      <div class="activity-dot ${a.tipo}"></div>
      <div class="activity-content">
        <div class="activity-msg"><span class="activity-user"><span class="icon ${iconMap[a.role]} icon-sm"></span> ${a.usuario}</span> — ${a.msg}</div>
        <div class="activity-meta"><span class="icon icon-clock icon-sm"></span> ${a.fechaHora} · ${roleLabel}</div>
      </div>
    </div>`;
  }).join('');
}
window.limpiarActividad = async function(){
  if(!confirm('¿Limpiar el registro de actividad?')) return;
  state.actividad=[]; await set(ref(db,'actividad'),[]); toast('Actividad limpiada.');
};

// ── HISTORIAL ─────────────────────────────────────────────────
function renderHistorial(){
  if(sesion?.role==='cocinero') return;
  const h=state.historial||[];
  let total=0; const mesasSet=new Set(); const byMesa={};
  h.forEach(r=>{ if(!byMesa[r.mesa]) byMesa[r.mesa]=[]; byMesa[r.mesa].push(r); total+=r.total; mesasSet.add(r.mesa); });
  const sc=$('stat-clientes'),sm=$('stat-mesas-h'),st=$('stat-total');
  if(sc) sc.textContent=h.length; if(sm) sm.textContent=mesasSet.size; if(st) st.textContent=fmt(total);
  if(!h.length){ html('historial-container','<div class="empty-state"><span class="icon icon-empty icon-xl"></span><p>Sin ventas esta noche.</p></div>'); return; }
  let t='<table class="history-table"><thead><tr><th>Mesa</th><th>Cliente</th><th>Hora</th><th>Productos</th><th>Mesero</th><th>Usuario</th><th>Total</th></tr></thead><tbody>';
  Object.keys(byMesa).sort((a,b)=>+a-+b).forEach(mesa=>{
    let tm=0; byMesa[mesa].forEach(r=>{ tm+=r.total;
      t+=`<tr><td><strong>Mesa ${mesa}</strong></td><td>${r.clienteNum}°</td><td>${r.hora}</td>
        <td>${r.detalles.map(d=>`${d.qty}× ${d.nombre}`).join(', ')}</td>
        <td>${r.mesero||'—'}</td><td style="color:var(--blue);font-weight:500">${r.usuario||'—'}</td>
        <td>${fmt(r.total)}</td></tr>`;
    });
    t+=`<tr class="total-row"><td colspan="6">Subtotal Mesa ${mesa}</td><td>${fmt(tm)}</td></tr>`;
  });
  t+=`<tr class="total-row" style="background:rgba(201,168,76,0.08)"><td colspan="6">INGRESO TOTAL</td><td style="color:var(--gold-dark);font-size:1.1rem">${fmt(total)}</td></tr></tbody></table>`;
  html('historial-container',t);
}

window.limpiarHistorial = async function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin.'); return; }
  if(!confirm('¿Limpiar todo el historial de la noche?')) return;
  state.historial=[];
  await set(ref(db,'historial'),[]);
  for(let i=1;i<=TOTAL_MESAS;i++){ state.mesas[i].clientesNoche=[]; await saveMesa(i); }
  await registrarActividad('accion-admin','Limpió el historial de ventas de la noche');
  toast('Historial limpiado.');
};

// ── CIERRE DE CAJA ────────────────────────────────────────────
window.cierreCaja = function(){
  if(sesion?.role!=='admin'){ toast('Solo el Admin puede hacer cierre de caja.'); return; }
  const h=state.historial||[];
  if(!h.length){ toast('No hay ventas registradas hoy.'); return; }
  const total = h.reduce((s,r)=>s+r.total,0);
  const ok = confirm(
    `¿Confirmar Cierre de Caja?\n\n` +
    `• Clientes atendidos: ${h.length}\n` +
    `• Total a cerrar: ${fmt(total)}\n\n` +
    `Se descargará el Excel del día. El historial puede limpiarse luego manualmente.`
  );
  if(!ok) return;
  registrarActividad('accion-admin','Ejecutó Cierre de Caja — descargó XLSX del día');
  cargarYExportar(h, true);
};

window.exportCSV = function(){
  const h=state.historial||[];
  if(!h.length){ toast('No hay ventas para exportar.'); return; }
  cargarYExportar(h, false);
};

function cargarYExportar(hist, esCierre){
  const script=document.createElement('script');
  script.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  script.onload=()=>generarXLSX(hist, esCierre);
  script.onerror=()=>toast('Error cargando librería XLSX.');
  document.head.appendChild(script);
}

function generarXLSX(hist, esCierre){
  const XLSX=window.XLSX;
  const wb=XLSX.utils.book_new();
  const fecha=new Date().toLocaleDateString('es-PY',{timeZone:TZ});
  const C={
    rojo:'C0392B',rojoMedio:'E74C3C',rojoClaro:'FADBD8',
    grisOscuro:'2C241B',grisClaro:'F5F0EB',blanco:'FFFFFF',
    naranja:'C9A84C',naranjaClr:'F9F5EB',
    verde:'2D6A4F',verdeClr:'E8F5E9',
    azul:'4A6FA5',azulClr:'E3F2FD',
    morado:'7B68EE',moradoClr:'F3E5F5',
    gold:'C9A84C'
  };
  const st=(bg,fg='000000',bold=false,sz=10,border=false,align='left',numFmt='')=>({
    fill:{fgColor:{rgb:bg}},font:{color:{rgb:fg},bold,sz,name:'Arial'},
    alignment:{horizontal:align,vertical:'center',wrapText:true},
    border:border?{top:{style:'thin',color:{rgb:'D4C4B0'}},bottom:{style:'thin',color:{rgb:'D4C4B0'}},left:{style:'thin',color:{rgb:'D4C4B0'}},right:{style:'thin',color:{rgb:'D4C4B0'}}}:{},
    numFmt
  });
  const sc=(r,c)=>XLSX.utils.encode_cell({r,c});

  const byMesa={};let totalGlobal=0;
  hist.forEach(r=>{ if(!byMesa[r.mesa]) byMesa[r.mesa]=[]; byMesa[r.mesa].push(r); totalGlobal+=r.total; });

  const ws1d=[];
  ws1d.push(['RESTAURANTE DELICIAS — HISTORIAL DE VENTAS','','','','','','','','','']);
  ws1d.push([`Fecha: ${fecha}   |   ${esCierre?'CIERRE DE CAJA':'Exportación parcial'}   |   Total: ${fmt(totalGlobal)}`,'','','','','','','','','']);
  ws1d.push(['']);
  ws1d.push(['Mesa','Cliente','Hora','Categoría','Producto','Cant.','Precio Unit.','Subtotal','Mesero','Usuario']);

  const mesaKeys=Object.keys(byMesa).sort((a,b)=>+a-+b);
  let altRow=false;
  mesaKeys.forEach(mesa=>{
    byMesa[mesa].forEach(r=>{
      r.detalles.forEach(d=>{
        ws1d.push([`Mesa ${mesa}`,`${r.clienteNum}°`,r.hora,CAT_LABELS[d.cat||'comida']||d.cat||'',
          d.nombre,d.qty,Math.round(d.precio),Math.round(d.sub),r.mesero||'—',r.usuario||'—']);
      });
      altRow=!altRow;
    });
    const totM=byMesa[mesa].reduce((s,r)=>s+r.total,0);
    ws1d.push([`SUBTOTAL MESA ${mesa}`,'','','','','','',Math.round(totM),'','']);
    ws1d.push(['']);
  });
  ws1d.push(['']);
  ws1d.push(['INGRESO TOTAL DE LA NOCHE','','','','','','',Math.round(totalGlobal),'','']);

  const ws1=XLSX.utils.aoa_to_sheet(ws1d);
  ws1['!cols']=[{wch:13},{wch:9},{wch:7},{wch:11},{wch:20},{wch:7},{wch:16},{wch:15},{wch:16},{wch:14}];
  const ms1=[{s:{r:0,c:0},e:{r:0,c:9}},{s:{r:1,c:0},e:{r:1,c:9}}];

  let ri=4;
  mesaKeys.forEach(mesa=>{
    const lineas=byMesa[mesa].reduce((s,r)=>s+r.detalles.length,0);
    ri+=lineas;
    ms1.push({s:{r:ri,c:0},e:{r:ri,c:6}});
    ri+=2;
  });
  const lastR=ws1d.length-1;
  ms1.push({s:{r:lastR,c:0},e:{r:lastR,c:6}});
  ws1['!merges']=ms1;

  ws1[sc(0,0)]={v:ws1d[0][0],t:'s',s:st(C.gold,C.blanco,true,14,false,'center')};
  ws1[sc(1,0)]={v:ws1d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Mesa','Cliente','Hora','Categoría','Producto','Cant.','Precio Unit.','Subtotal','Mesero','Usuario'].forEach((h2,ci)=>{
    ws1[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')};
  });

  let ri2=4; let alt=false;
  mesaKeys.forEach(mesa=>{
    byMesa[mesa].forEach(r=>{
      r.detalles.forEach(d=>{
        const catC={comida:C.grisClaro,bebida:C.azulClr,postre:C.moradoClr}[d.cat||'comida']||C.blanco;
        const bg=alt?catC:C.blanco;
        const row=ws1d[ri2];
        row.forEach((v,ci)=>{
          const isN=ci===5||ci===6||ci===7;
          ws1[sc(ri2,ci)]={v:isN?Number(v):v,t:isN?'n':'s',s:st(bg,'000000',false,10,true,isN?'right':'left',isN?'#,##0':'')};
        });
        ri2++;
      });
      alt=!alt;
    });
    const stRow=ws1d[ri2];
    ws1[sc(ri2,0)]={v:stRow[0],t:'s',s:st(C.naranjaClr,C.naranja,true,10,true,'left')};
    for(let ci=1;ci<=6;ci++) ws1[sc(ri2,ci)]={v:'',t:'s',s:st(C.naranjaClr,C.naranja,true,10,true)};
    ws1[sc(ri2,7)]={v:Number(stRow[7]),t:'n',s:st(C.naranjaClr,C.naranja,true,10,true,'right','#,##0')};
    ws1[sc(ri2,8)]={v:'',t:'s',s:st(C.naranjaClr,C.naranja,true,10,true)};
    ws1[sc(ri2,9)]={v:'',t:'s',s:st(C.naranjaClr,C.naranja,true,10,true)};
    ri2+=2;
  });
  ws1[sc(lastR,0)]={v:'INGRESO TOTAL DE LA NOCHE',t:'s',s:st(C.verde,C.blanco,true,12,true,'left')};
  for(let ci=1;ci<=6;ci++) ws1[sc(lastR,ci)]={v:'',t:'s',s:st(C.verde,C.blanco,true,12,true)};
  ws1[sc(lastR,7)]={v:Math.round(totalGlobal),t:'n',s:st(C.verde,C.blanco,true,12,true,'right','#,##0')};
  ws1[sc(lastR,8)]={v:'',t:'s',s:st(C.verde,C.blanco,true,12,true)};
  ws1[sc(lastR,9)]={v:'',t:'s',s:st(C.verde,C.blanco,true,12,true)};
  ws1['!rows']=[]; ws1['!rows'][0]={hpt:26}; ws1['!rows'][1]={hpt:15}; ws1['!rows'][3]={hpt:18};
  XLSX.utils.book_append_sheet(wb,ws1,'Detalle de Ventas');

  const ws2d=[
    ['RESTAURANTE DELICIAS — RESUMEN POR MESA','','','',''],
    [`Fecha: ${fecha}`,'','','',''],[''],
    ['Mesa','Clientes','Bebidas (Gs.)','Comidas (Gs.)','Postres (Gs.)','Total (Gs.)','% del Total']
  ];
  mesaKeys.forEach(mesa=>{
    const rs=byMesa[mesa]; const cl=rs.length;
    const tot=rs.reduce((s,r)=>s+r.total,0);
    const beb=rs.reduce((s,r)=>s+r.detalles.filter(d=>(d.cat||'comida')==='bebida').reduce((a,d)=>a+d.sub,0),0);
    const com=rs.reduce((s,r)=>s+r.detalles.filter(d=>(d.cat||'comida')==='comida').reduce((a,d)=>a+d.sub,0),0);
    const pos=rs.reduce((s,r)=>s+r.detalles.filter(d=>(d.cat||'comida')==='postre').reduce((a,d)=>a+d.sub,0),0);
    ws2d.push([`Mesa ${mesa}`,cl,Math.round(beb),Math.round(com),Math.round(pos),Math.round(tot),totalGlobal>0?tot/totalGlobal:0]);
  });
  ws2d.push(['']);
  ws2d.push(['TOTAL',hist.length,
    Math.round(mesaKeys.reduce((s,m)=>s+byMesa[m].reduce((a,r)=>a+r.detalles.filter(d=>(d.cat||'comida')==='bebida').reduce((x,d)=>x+d.sub,0),0),0)),
    Math.round(mesaKeys.reduce((s,m)=>s+byMesa[m].reduce((a,r)=>a+r.detalles.filter(d=>(d.cat||'comida')==='comida').reduce((x,d)=>x+d.sub,0),0),0)),
    Math.round(mesaKeys.reduce((s,m)=>s+byMesa[m].reduce((a,r)=>a+r.detalles.filter(d=>(d.cat||'comida')==='postre').reduce((x,d)=>x+d.sub,0),0),0)),
    Math.round(totalGlobal),1
  ]);
  const ws2=XLSX.utils.aoa_to_sheet(ws2d);
  ws2['!cols']=[{wch:12},{wch:10},{wch:16},{wch:16},{wch:16},{wch:16},{wch:12}];
  ws2['!merges']=[{s:{r:0,c:0},e:{r:0,c:6}},{s:{r:1,c:0},e:{r:1,c:6}}];
  ws2[sc(0,0)]={v:ws2d[0][0],t:'s',s:st(C.gold,C.blanco,true,13,false,'center')};
  ws2[sc(1,0)]={v:ws2d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Mesa','Clientes','Bebidas (Gs.)','Comidas (Gs.)','Postres (Gs.)','Total (Gs.)','% del Total'].forEach((h2,ci)=>{
    ws2[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')};
  });
  mesaKeys.forEach((mesa,idx)=>{
    const ri3=4+idx; const bg=idx%2===0?C.azulClr:C.blanco; const row=ws2d[ri3];
    ws2[sc(ri3,0)]={v:row[0],t:'s',s:st(bg,'000000',false,10,true,'left')};
    ws2[sc(ri3,1)]={v:Number(row[1]),t:'n',s:st(bg,'000000',false,10,true,'center')};
    [2,3,4,5].forEach(ci=>ws2[sc(ri3,ci)]={v:Number(row[ci]),t:'n',s:st(bg,'000000',false,10,true,'right','#,##0')});
    ws2[sc(ri3,6)]={v:Number(row[6]),t:'n',s:st(bg,'000000',false,10,true,'center','0.0%')};
  });
  const totRi=4+mesaKeys.length+1;
  ws2[sc(totRi,0)]={v:'TOTAL',t:'s',s:st(C.verde,C.blanco,true,11,true,'left')};
  ws2[sc(totRi,1)]={v:hist.length,t:'n',s:st(C.verde,C.blanco,true,11,true,'center')};
  [2,3,4,5].forEach(ci=>ws2[sc(totRi,ci)]={v:Number(ws2d[totRi][ci]),t:'n',s:st(C.verde,C.blanco,true,11,true,'right','#,##0')});
  ws2[sc(totRi,6)]={v:1,t:'n',s:st(C.verde,C.blanco,true,11,true,'center','0.0%')};
  ws2['!rows']=[]; ws2['!rows'][0]={hpt:24}; ws2['!rows'][3]={hpt:17};
  XLSX.utils.book_append_sheet(wb,ws2,'Resumen por Mesa');

  const catTotals={bebida:0,comida:0,postre:0};
  hist.forEach(r=>r.detalles.forEach(d=>{ catTotals[d.cat||'comida']=(catTotals[d.cat||'comida']||0)+d.sub; }));
  const ws3d=[
    ['RESTAURANTE DELICIAS — VENTAS POR CATEGORÍA','',''],
    [`Fecha: ${fecha}`,'',''],[''],
    ['Categoría','Total Vendido (Gs.)','% del Total'],
    ['Bebidas',Math.round(catTotals.bebida),totalGlobal>0?catTotals.bebida/totalGlobal:0],
    ['Comidas',Math.round(catTotals.comida),totalGlobal>0?catTotals.comida/totalGlobal:0],
    ['Postres',Math.round(catTotals.postre),totalGlobal>0?catTotals.postre/totalGlobal:0],
    [''],['TOTAL',Math.round(totalGlobal),1]
  ];
  const ws3=XLSX.utils.aoa_to_sheet(ws3d);
  ws3['!cols']=[{wch:16},{wch:20},{wch:14}];
  ws3['!merges']=[{s:{r:0,c:0},e:{r:0,c:2}},{s:{r:1,c:0},e:{r:1,c:2}}];
  ws3[sc(0,0)]={v:ws3d[0][0],t:'s',s:st(C.gold,C.blanco,true,13,false,'center')};
  ws3[sc(1,0)]={v:ws3d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Categoría','Total Vendido (Gs.)','% del Total'].forEach((h2,ci)=>{ ws3[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')}; });
  const catColors={4:C.azulClr,5:C.grisClaro,6:C.moradoClr};
  [4,5,6].forEach(ri=>{
    const row=ws3d[ri]; const bg=catColors[ri];
    ws3[sc(ri,0)]={v:row[0],t:'s',s:st(bg,'000000',false,11,true,'left')};
    ws3[sc(ri,1)]={v:Number(row[1]),t:'n',s:st(bg,'000000',true,11,true,'right','#,##0')};
    ws3[sc(ri,2)]={v:Number(row[2]),t:'n',s:st(bg,'000000',false,11,true,'center','0.0%')};
  });
  ws3[sc(8,0)]={v:'TOTAL',t:'s',s:st(C.verde,C.blanco,true,12,true,'left')};
  ws3[sc(8,1)]={v:Math.round(totalGlobal),t:'n',s:st(C.verde,C.blanco,true,12,true,'right','#,##0')};
  ws3[sc(8,2)]={v:1,t:'n',s:st(C.verde,C.blanco,true,12,true,'center','0.0%')};
  ws3['!rows']=[]; ws3['!rows'][0]={hpt:24}; ws3['!rows'][3]={hpt:18};
  XLSX.utils.book_append_sheet(wb,ws3,'Ventas por Categoría');

  const ws4d=[['RESTAURANTE DELICIAS — ACTIVIDAD DE USUARIOS','','',''],
    [`Fecha: ${fecha}`,'','',''],[''],['Fecha/Hora','Usuario','Rol','Acción']];
  (state.actividad||[]).slice(0,500).forEach(a=>{
    const roleLbl={admin:'Admin',mesero:'Mesero',cocinero:'Cocinero/a'}[a.role]||a.role;
    ws4d.push([a.fechaHora||'—',a.usuario||'—',roleLbl,a.msg||'—']);
  });
  const ws4=XLSX.utils.aoa_to_sheet(ws4d);
  ws4['!cols']=[{wch:17},{wch:18},{wch:12},{wch:52}];
  ws4['!merges']=[{s:{r:0,c:0},e:{r:0,c:3}},{s:{r:1,c:0},e:{r:1,c:3}}];
  ws4[sc(0,0)]={v:ws4d[0][0],t:'s',s:st(C.gold,C.blanco,true,13,false,'center')};
  ws4[sc(1,0)]={v:ws4d[1][0],t:'s',s:st(C.rojoMedio,C.blanco,false,9,false,'center')};
  ['Fecha/Hora','Usuario','Rol','Acción'].forEach((h2,ci)=>{ ws4[sc(3,ci)]={v:h2,t:'s',s:st(C.grisOscuro,C.blanco,true,10,true,'center')}; });
  (state.actividad||[]).slice(0,500).forEach((a,idx)=>{
    const ri=4+idx; const bg=idx%2===0?C.grisClaro:C.blanco;
    const roleLbl={admin:'Admin',mesero:'Mesero',cocinero:'Cocinero/a'}[a.role]||a.role;
    [a.fechaHora,a.usuario,roleLbl,a.msg].forEach((v,ci)=>{
      ws4[sc(ri,ci)]={v:v||'',t:'s',s:st(bg,ci===2&&a.role==='admin'?C.gold:'000000',ci===2&&a.role==='admin',9,true,'left')};
    });
  });
  ws4['!rows']=[]; ws4['!rows'][0]={hpt:24}; ws4['!rows'][3]={hpt:17};
  XLSX.utils.book_append_sheet(wb,ws4,'Actividad de Usuarios');

  const fechaArch=new Date().toISOString().slice(0,10);
  const nombre=esCierre?`Cierre_Caja_Delicias_${fechaArch}.xlsx`:`Restaurante_Delicias_${fechaArch}.xlsx`;
  XLSX.writeFile(wb,nombre);
  toast(`${esCierre?'Cierre de Caja':'Excel'} descargado`);
  if(sesion) registrarActividad('accion-admin',`Descargó ${esCierre?'Cierre de Caja':'XLSX'}: ${nombre}`);
}

// ── CERRAR MODALES ────────────────────────────────────────────
$('modal-mesa').addEventListener('click',function(e){if(e.target===this)window.cerrarModal();});
$('modal-edit-prod').addEventListener('click',function(e){if(e.target===this)window.cerrarEditProd();});
$('modal-hist-mesa').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
$('modal-hist-cocina').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});
$('modal-cambiar-pass').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});

boot();
</script>
</body>
</html>
